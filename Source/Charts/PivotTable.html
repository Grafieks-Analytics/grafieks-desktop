<!DOCTYPE html>
<html>
    <head>
        <title>orb</title>

        <link
            rel="stylesheet"
            type="text/css"
            href="./Data/bootstrap-3.3.1/css/bootstrap.css"
        />
        <link
            rel="stylesheet"
            type="text/css"
            href="./Data/bootstrap-3.3.1/css/bootstrap-theme.css"
        />

        <link rel="stylesheet" type="text/css" href="./Data/orb.min.css" />
        <script
            type="text/javascript"
            src="./Data/react-0.12.2.min.js"
        ></script>
        <script type="text/javascript" src="./Data/orb.min.js"></script>

        <script type="text/javascript" src="./Data/demo.data.js"></script>

        <style type="text/css">
            body {
                font-size: 1.2em;
                overflow: hidden;
            }

            .inner-table.upper-buttons {
                display: none;
            }

            .orb-container {
                margin-left: 5px;
                margin-right: 0px;
            }

            .custom-left-top-menu td {
                padding: 14px 7px;
                text-overflow: ellipsis;
            }

            .orb-toolbar {
                display: none;
            }

            * {
                border-radius: 0 !important;
            }
        </style>
    </head>

    <body>
        <div id="rr" style="padding: 7px"></div>
        <div id="export" style="padding: 7px"></div>

        <script type="text/javascript">
            function setTopLeftColumnThemeColor(theme) {
                var themeCss = "";
                switch (theme) {
                    case "flower":
                        themeCss = `.custom-left-top-menu td{
                            border-left: 0.5px solid #d3a4e3;
                            border-top: 0.5px solid #d3a4e3;
                        }`;
                        break;
                    case "black":
                        themeCss = `.custom-left-top-menu td{
                            border-left: 0.5px solid #7f7f7f;
                            border-top: 0.5px solid #7f7f7f;
                        }`;
                        break;
                    case "white":
                        themeCss = `.custom-left-top-menu td{
                        border-left: 0.5px solid #e6e6e6;
                        border-top: 0.5px solid #e6e6e6;
                    }`;
                        break;
                    case "red":
                        themeCss = `.custom-left-top-menu td{
                            border-left: 0.5px solid #e395a3;
                            border-top: 0.5px solid #e395a3;
                        }`;
                        break;

                    case "green":
                        themeCss = `.custom-left-top-menu td{
                            border-left: 0.5px solid #9fda8b;
                            border-top: 0.5px solid #9fda8b;
                        }`;
                        break;

                    case "orange":
                        themeCss = `.custom-left-top-menu td{
                                border-left: 0.5px solid #efb48c;
                                border-top: 0.5px solid #efb48c;
                            }`;
                        break;
                    default:
                        themeCss = `.custom-left-top-menu td{
                            border-left: 0.5px solid #addfee;
                            border-top: 0.5px solid #addfee;
                        }`;
                }
                var themeColor = document.getElementById("themeId");
                if (themeColor) {
                    themeColor.remove();
                }
                var themeStyleTag = document.createElement("style");
                themeStyleTag.id = "themeId";
                themeStyleTag.innerHTML = themeCss;
                document.head.append(themeStyleTag);
            }

            function refreshData() {
                pgridwidget.refreshData(window.demo.data);
            }

            function changeTheme() {
                pgridwidget.changeTheme("bootstrap");
            }

            function exportToExcel(anchor) {
                document.querySelector(".export-xls").click();
                // anchor.href = orb.export(pgridwidget);
                // return true;
            }

            function changeThemeColour(themeColor) {
                config.theme = themeColor.toLowerCase();
                drawChart(window.data);
            }

           
            var config = {
                dataSource: window.demo.data,
                canMoveFields: false,
                dataHeadersLocation: "columns",
                theme: "blue",
                toolbar: {
                    visible: true,
                },
                subTotal: {
                    visible: true,
                    collapsed: false,
                    collapsible: false,
                },
            };

            var pgridwidget = new orb.pgridwidget(config);
            
            function drawChart(data, plotConfiguration = {}) {
                window.data = data;                
                window.plotConfiguration =
                    plotConfiguration || window.plotConfiguration;
                var dataSource = data[0];


                var fields = data[2].map((d, i) => {
                    return { name: i.toString(), caption: d };
                });

                var [rows, columns, data] = data[3];

                console.log(rows, columns, data);

                var elem = document.getElementById("rr");
                clearChart();

                config = {
                    ...config,
                    width: window.innerWidth - 20,
                    height: window.innerHeight + 40,
                    dataSource,
                    fields,
                    grandTotal: {
                        rowsvisible: !!plotConfiguration.rowWiseGrandTotal,
                        columnsvisible: !!plotConfiguration.columnWiseGrandTotal,
                    },
                    subTotal: {
                        visible: !!plotConfiguration.subTotalVisible,
                        collapsed: false,
                        collapsible: false,
                    },
                    rows,
                    columns,
                    data,
                };

                pgridwidget = new orb.pgridwidget(config);
                pgridwidget.render(elem);

                var { theme } = config;


                setTopLeftColumnThemeColor(theme);

                var outerTableBody = document.querySelector("table tbody");
                var menuFieldDataRow0 = outerTableBody.children[1];
                menuFieldDataRow0.style.display = "none";

                var menuFieldDataRow = outerTableBody.children[2];
                // time to clear it
                var menuFieldDataFirstCloumn =
                    menuFieldDataRow.firstElementChild;

                var innerValues =
                    menuFieldDataFirstCloumn.querySelectorAll("div");
                var dataValues = [];
                Array.from(innerValues).forEach((element) => {
                    if (
                        !element.innerText ||
                        element.className.includes("drp-trgt")
                    ) {
                        return;
                    }
                    dataValues.push(element.innerText.trim());
                });
                var widthPercentage = (1 / dataValues.length) * 100;
                var tableHtml = "";

                var innerTableColumns = document.querySelector(
                    ".rows-cntr .inner-table tbody"
                );
                var headerColumns =
                    innerTableColumns.firstElementChild.children;
                var widths = Array.from(headerColumns).map((d) => {
                    return d.clientWidth;
                });

                dataValues.forEach((d, i) => {
                    tableHtml +=
                        "<td class='header-st custom-tds' data-text='" + d +
                        "' style='width: " +
                        widths[i] +
                        "px'>" +
                        d +
                        "</td>";
                });

                tableHtml =
                    "<table class='ord-" +
                    theme +
                    " custom-left-top-menu' style='width: 100%;'><tr class='orb'>" +
                    tableHtml +
                    "</tr></table>";

                menuFieldDataFirstCloumn.innerHTML = tableHtml;

                var tds = document.querySelectorAll(".custom-tds");
                Array.from(tds).forEach((td) => {
                    clipLetters(td);
                });
                
                document.querySelector(".custom-left-top-menu").style.height =
                    menuFieldDataFirstCloumn.clientHeight + 0.72 + "px";

                var innerTableContainerColumns =
                    document.querySelector(".columns-cntr");
                var tableColumns = innerTableContainerColumns.firstElementChild;
                var tableParentColumns =
                    innerTableContainerColumns.parentElement;

                var innerTableContainerData =
                    document.querySelector(".data-cntr");
                var tableData = innerTableContainerData.firstElementChild;
                var tableParentData = innerTableContainerData.parentElement;

                var columnWidth = innerTableContainerColumns.style.width;
                columnWidth = columnWidth && columnWidth.replace("px", "");

                var customTopWidth = document.querySelector(
                    ".custom-left-top-menu tr"
                ).clientWidth;

                if (+columnWidth + customTopWidth + 36 < window.innerWidth) {
                    console.log("Setting widths!");
                    innerTableContainerColumns.style.width = "100%";
                    tableColumns.style.width = "100%";
                    tableParentColumns.style.width = "100%";

                    innerTableContainerData.style.width = "100%";
                    tableData.style.width = "100%";
                    tableParentData.style.width = "100%";
                }

                
                /*  removing this for future reference
                    This is an event listener to adust height of custom left top menu
                
                var toggleButtons = document.querySelectorAll('.orb-tgl-btn-down')
                Array.from(toggleButtons).forEach(toggleButton=>{
                    toggleButton.addEventListener('click',function(){
                        var outerTableBody = document.querySelector("table tbody");
                        var menuFieldDataRow = outerTableBody.children[2];
                        var menuFieldDataFirstCloumn = menuFieldDataRow.children[1].firstElementChild;
                        console.log(menuFieldDataFirstCloumn);
                        setTimeout(function(){
                            console.log({ height: menuFieldDataFirstCloumn.clientHeight });
                            document.querySelector(".custom-left-top-menu").style.height =
                            menuFieldDataFirstCloumn.clientHeight + 0.72 + "px";
                        },100)

                    })
                })

                */

            }

            function clipLetters(td) {
                var width = td.style.width;
                width = +width.substr(0, width.length - 2);
                var clientWidth = td.clientWidth;
                console.log({ width, clientWidth });
                if (clientWidth > width) {
                    console.log("Clipping..");
                    // single character width = total width / length of character
                    var singleCharacterLength = parseInt(clientWidth / td.innerText.length);
                    var maxAllowedCharacters = parseInt(
                        width / singleCharacterLength
                    );

                    var subString = td
                        .getAttribute("data-text")
                        .substr(0, maxAllowedCharacters - 4);
                    console.log(singleCharacterLength);
                    subString += "...";
                    td.innerText = subString;
                }
            }


            function clearChart() {
                var elem = document.getElementById("rr");
                if (elem) {
                    elem.innerHTML = "";
                }
            }

            var data = [[["Furniture","Consumer","2019-11-11","Bookcases","2019-11-08",786,6],["Furniture","Consumer","2019-11-11","Chairs","2019-11-08",1464,6],["Office Supplies","Corporate","2019-06-16","Labels","2019-06-12",30,4],["Furniture","Consumer","2018-10-18","Tables","2018-10-11",1916,10],["Office Supplies","Consumer","2018-10-18","Storage","2018-10-11",44,4],["Furniture","Consumer","2017-06-14","Furnishings","2017-06-09",98,14],["Office Supplies","Consumer","2017-06-14","Art","2017-06-09",14,8],["Technology","Consumer","2017-06-14","Phones","2017-06-09",1814,12],["Office Supplies","Consumer","2017-06-14","Binders","2017-06-09",38,6],["Office Supplies","Consumer","2017-06-14","Appliances","2017-06-09",230,10],["Furniture","Consumer","2017-06-14","Tables","2017-06-09",3412,18],["Office Supplies","Consumer","2020-04-20","Paper","2020-04-15",32,6],["Office Supplies","Consumer","2019-12-10","Binders","2019-12-05",816,6],["Office Supplies","Home Office","2018-11-26","Appliances","2018-11-22",138,10],["Office Supplies","Home Office","2018-11-26","Binders","2018-11-22",6,6],["Office Supplies","Consumer","2017-11-18","Storage","2017-11-11",1332,12],["Office Supplies","Consumer","2017-05-15","Storage","2017-05-13",112,4],["Office Supplies","Consumer","2017-09-01","Art","2017-08-27",18,4],["Technology","Consumer","2017-09-01","Phones","2017-08-27",426,6],["Office Supplies","Consumer","2017-09-01","Binders","2017-08-27",46,8],["Office Supplies","Corporate","2019-12-13","Art","2019-12-09",38,14],["Office Supplies","Corporate","2019-12-13","Appliances","2019-12-09",120,14],["Furniture","Consumer","2020-07-18","Chairs","2020-07-16",142,4],["Furniture","Consumer","2018-09-30","Tables","2018-09-25",2090,6],["Office Supplies","Consumer","2019-01-20","Binders","2019-01-16",24,4],["Furniture","Consumer","2018-09-21","Bookcases","2018-09-17",6166,14],["Office Supplies","Consumer","2018-09-21","Binders","2018-09-17",34,16],["Furniture","Consumer","2018-09-21","Furnishings","2018-09-17",248,6],["Office Supplies","Consumer","2018-09-21","Envelopes","2018-09-17",6,4],["Office Supplies","Consumer","2018-09-21","Art","2018-09-17",204,16],["Office Supplies","Home Office","2020-10-23","Paper","2020-10-19",58,6],["Technology","Corporate","2019-12-10","Phones","2019-12-08",2196,14],["Furniture","Corporate","2019-12-10","Furnishings","2019-12-08",382,10],["Office Supplies","Home Office","2018-12-31","Envelopes","2018-12-27",226,18],["Furniture","Home Office","2018-12-31","Bookcases","2018-12-27",1064,6],["Furniture","Home Office","2018-12-31","Chairs","2018-12-27",424,6],["Technology","Home Office","2018-12-31","Phones","2018-12-27",742,8],["Technology","Corporate","2020-09-15","Phones","2020-09-10",294,8],["Office Supplies","Corporate","2019-07-22","Storage","2019-07-17",156,4],["Office Supplies","Corporate","2020-09-23","Storage","2020-09-19",192,4],["Technology","Corporate","2019-03-13","Accessories","2019-03-11",92,4],["Office Supplies","Corporate","2019-03-13","Binders","2019-03-11",34,4],["Office Supplies","Consumer","2017-10-25","Storage","2017-10-20",424,8],["Technology","Consumer","2019-06-25","Phones","2019-06-20",44,4],["Office Supplies","Consumer","2018-04-22","Binders","2018-04-18",76,12],["Office Supplies","Consumer","2018-04-22","Labels","2018-04-18",150,12],["Furniture","Consumer","2018-04-22","Furnishings","2018-04-18",12,4],["Furniture","Consumer","2018-04-22","Chairs","2018-04-18",180,2],["Office Supplies","Corporate","2019-12-17","Fasteners","2019-12-11",30,14],["Technology","Corporate","2019-12-17","Phones","2019-12-11",2060,10],["Office Supplies","Consumer","2019-06-18","Storage","2019-06-17",418,12],["Office Supplies","Consumer","2019-06-18","Paper","2019-06-17",94,14],["Furniture","Consumer","2019-06-18","Chairs","2019-06-17",638,10],["Office Supplies","Consumer","2019-06-18","Binders","2019-06-17",96,8],["Office Supplies","Consumer","2019-06-18","Art","2019-06-17",4,2],["Technology","Consumer","2018-11-30","Accessories","2018-11-24",28,4],["Office Supplies","Consumer","2018-11-30","Binders","2018-11-24",52,12],["Office Supplies","Consumer","2018-11-30","Paper","2018-11-24",294,6],["Furniture","Consumer","2018-11-30","Furnishings","2018-11-24",160,8],["Furniture","Home Office","2018-05-05","Chairs","2018-04-30",426,10],["Office Supplies","Corporate","2017-12-10","Art","2017-12-05",2226,16],["Technology","Corporate","2017-12-10","Phones","2017-12-05",336,8],["Office Supplies","Consumer","2019-06-06","Paper","2019-06-04",152,4],["Office Supplies","Consumer","2019-09-23","Binders","2019-09-18",10,2],["Office Supplies","Consumer","2020-09-17","Paper","2020-09-14",38,6],["Furniture","Consumer","2018-05-02","Chairs","2018-04-26",1664,16],["Furniture","Consumer","2018-05-02","Furnishings","2018-04-26",194,4],["Office Supplies","Consumer","2018-05-02","Storage","2018-04-26",146,2],["Office Supplies","Corporate","2020-12-11","Binders","2020-12-09",2,6],["Furniture","Corporate","2020-12-11","Furnishings","2020-12-09",20,6],["Office Supplies","Corporate","2020-12-11","Storage","2020-12-09",54,6],["Furniture","Consumer","2017-12-01","Furnishings","2017-11-26",38,10],["Office Supplies","Corporate","2019-06-15","Appliances","2019-06-12",416,2],["Office Supplies","Corporate","2019-06-15","Binders","2019-06-12",34,6],["Office Supplies","Consumer","2017-10-16","Art","2017-10-12",30,10],["Office Supplies","Consumer","2017-10-16","Storage","2017-10-12",42,2],["Office Supplies","Corporate","2018-09-08","Envelopes","2018-09-03",402,14],["Office Supplies","Home Office","2020-11-16","Storage","2020-11-13",460,6],["Furniture","Consumer","2020-05-30","Chairs","2020-05-28",604,4],["Office Supplies","Consumer","2020-11-02","Labels","2020-10-26",12,4],["Office Supplies","Home Office","2019-04-10","Storage","2019-04-05",316,14],["Office Supplies","Corporate","2019-09-22","Art","2019-09-17",40,6],["Technology","Corporate","2019-09-22","Phones","2019-09-17",148,4],["Office Supplies","Corporate","2019-09-22","Paper","2019-09-17",12,2],["Office Supplies","Consumer","2018-02-05","Paper","2018-01-31",26,4],["Furniture","Consumer","2018-02-05","Furnishings","2018-01-31",106,6],["Office Supplies","Consumer","2018-02-05","Binders","2018-01-31",66,4],["Office Supplies","Home Office","2020-11-12","Binders","2020-11-06",12,2],["Furniture","Home Office","2020-11-11","Furnishings","2020-11-09",194,14],["Office Supplies","Consumer","2020-06-20","Binders","2020-06-17",102,6],["Office Supplies","Corporate","2019-09-11","Appliances","2019-09-06",156,12],["Office Supplies","Home Office","2019-09-02","Paper","2019-08-29",130,14],["Technology","Home Office","2019-09-02","Accessories","2019-08-29",192,6],["Office Supplies","Home Office","2019-09-02","Binders","2019-08-29",4,6],["Office Supplies","Consumer","2019-12-04","Paper","2019-12-01",48,8],["Technology","Consumer","2018-11-17","Accessories","2018-11-13",478,12],["Furniture","Consumer","2018-11-17","Furnishings","2018-11-13",204,6],["Office Supplies","Consumer","2018-11-17","Binders","2018-11-13",74,6],["Technology","Consumer","2020-11-28","Accessories","2020-11-23",148,16],["Technology","Consumer","2020-11-28","Phones","2020-11-23",56,2],["Office Supplies","Consumer","2020-11-28","Art","2020-11-23",6,2],["Furniture","Corporate","2020-12-30","Furnishings","2020-12-25",84,4],["Office Supplies","Consumer","2019-11-10","Art","2019-11-03",152,4],["Office Supplies","Consumer","2019-11-10","Binders","2019-11-03",54,12],["Office Supplies","Consumer","2017-08-27","Fasteners","2017-08-25",80,28],["Office Supplies","Consumer","2017-08-27","Envelopes","2017-08-25",270,16],["Office Supplies","Consumer","2017-08-27","Paper","2017-08-25",48,6],["Furniture","Consumer","2018-03-06","Tables","2018-03-02",1576,6],["Office Supplies","Corporate","2018-04-10","Binders","2018-04-05",316,2],["Furniture","Consumer","2019-06-15","Furnishings","2019-06-12",94,6],["Office Supplies","Consumer","2019-06-15","Binders","2019-06-12",62,8],["Office Supplies","Consumer","2019-06-15","Storage","2019-06-12",454,12],["Office Supplies","Consumer","2019-06-15","Envelopes","2019-06-12",230,18],["Technology","Consumer","2019-06-15","Phones","2019-06-12",136,14],["Furniture","Home Office","2017-12-28","Chairs","2017-12-26",1202,6],["Furniture","Consumer","2017-09-25","Tables","2017-09-20",1236,12],["Office Supplies","Consumer","2020-11-12","Binders","2020-11-05",4,4],["Office Supplies","Consumer","2020-11-12","Storage","2020-11-05",488,14],["Furniture","Home Office","2019-11-10","Chairs","2019-11-06",162,4],["Furniture","Home Office","2019-11-10","Furnishings","2019-11-06",478,6],["Technology","Corporate","2020-02-05","Phones","2020-02-02",120,10],["Office Supplies","Corporate","2020-02-05","Paper","2020-02-02",156,4],["Office Supplies","Corporate","2020-02-05","Fasteners","2020-02-02",42,18],["Office Supplies","Consumer","2019-10-19","Paper","2019-10-13",110,8],["Office Supplies","Consumer","2019-10-19","Art","2019-10-13",24,8],["Office Supplies","Consumer","2019-10-19","Fasteners","2019-10-13",8,4],["Office Supplies","Consumer","2019-10-19","Binders","2019-10-13",152,6],["Office Supplies","Consumer","2019-10-19","Supplies","2019-10-13",132,12],["Furniture","Consumer","2019-10-19","Furnishings","2019-10-13",86,28]],["","","","","",50244,1068],["Category","Segment","Ship_Date","Sub_Category","Order_Date","Sales","Quantity"],[["Category","Segment","Ship_Date"],["Sub_Category","Order_Date"],["Sales","Quantity"]],[[{"itemName":"Category","itemType":"Categorical","dateFormat":"%Y"},{"itemName":"Segment","itemType":"Categorical","dateFormat":"%Y"},{"itemName":"Ship_Date","itemType":"Date","dateFormat":"%Y"}],[{"itemName":"Sub_Category","itemType":"Categorical","dateFormat":"%Y"},{"itemName":"Order_Date","itemType":"Date","dateFormat":"%Y"}],[{"itemName":"Sales","itemType":"Numerical","dateFormat":"%Y"},{"itemName":"Quantity","itemType":"Numerical","dateFormat":"%Y"}]]]


            
            drawChart(data);
            
        </script>
    </body>
</html>
