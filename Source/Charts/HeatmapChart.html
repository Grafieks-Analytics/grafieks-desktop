<html>
    <head>
        <meta charset="utf-8" />

        <!-- Load d3.js -->

        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <title>Heatmap</title>
        <link rel="stylesheet" href="Data/general.css" />
    </head>
    <body>
        <!-- Create a div where the graph will take place -->
        <div
            id="my_dataviz"
            style="text-align: center; padding-top: 50px"
        ></div>
        <div id="tooltip"></div>

        <script>
            // Spectral color range
            var d3colors = [
                "#ffffff",
                "#f7fbff",
                "#f6faff",
                "#f5fafe",
                "#f5f9fe",
                "#f4f9fe",
                "#f3f8fe",
                "#f2f8fd",
                "#f2f7fd",
                "#f1f7fd",
                "#f0f6fd",
                "#eff6fc",
                "#eef5fc",
                "#eef5fc",
                "#edf4fc",
                "#ecf4fb",
                "#ebf3fb",
                "#eaf3fb",
                "#eaf2fb",
                "#e9f2fa",
                "#e8f1fa",
                "#e7f1fa",
                "#e7f0fa",
                "#e6f0f9",
                "#e5eff9",
                "#e4eff9",
                "#e3eef9",
                "#e3eef8",
                "#e2edf8",
                "#e1edf8",
                "#e0ecf8",
                "#e0ecf7",
                "#dfebf7",
                "#deebf7",
                "#ddeaf7",
                "#ddeaf6",
                "#dce9f6",
                "#dbe9f6",
                "#dae8f6",
                "#d9e8f5",
                "#d9e7f5",
                "#d8e7f5",
                "#d7e6f5",
                "#d6e6f4",
                "#d6e5f4",
                "#d5e5f4",
                "#d4e4f4",
                "#d3e4f3",
                "#d2e3f3",
                "#d2e3f3",
                "#d1e2f3",
                "#d0e2f2",
                "#cfe1f2",
                "#cee1f2",
                "#cde0f1",
                "#cce0f1",
                "#ccdff1",
                "#cbdff1",
                "#cadef0",
                "#c9def0",
                "#c8ddf0",
                "#c7ddef",
                "#c6dcef",
                "#c5dcef",
                "#c4dbee",
                "#c3dbee",
                "#c2daee",
                "#c1daed",
                "#c0d9ed",
                "#bfd9ec",
                "#bed8ec",
                "#bdd8ec",
                "#bcd7eb",
                "#bbd7eb",
                "#b9d6eb",
                "#b8d5ea",
                "#b7d5ea",
                "#b6d4e9",
                "#b5d4e9",
                "#b4d3e9",
                "#b2d3e8",
                "#b1d2e8",
                "#b0d1e7",
                "#afd1e7",
                "#add0e7",
                "#acd0e6",
                "#abcfe6",
                "#a9cfe5",
                "#a8cee5",
                "#a7cde5",
                "#a5cde4",
                "#a4cce4",
                "#a3cbe3",
                "#a1cbe3",
                "#a0cae3",
                "#9ec9e2",
                "#9dc9e2",
                "#9cc8e1",
                "#9ac7e1",
                "#99c6e1",
                "#97c6e0",
                "#96c5e0",
                "#94c4df",
                "#93c3df",
                "#91c3df",
                "#90c2de",
                "#8ec1de",
                "#8dc0de",
                "#8bc0dd",
                "#8abfdd",
                "#88bedc",
                "#87bddc",
                "#85bcdc",
                "#84bbdb",
                "#82bbdb",
                "#81badb",
                "#7fb9da",
                "#7eb8da",
                "#7cb7d9",
                "#7bb6d9",
                "#79b5d9",
                "#78b5d8",
                "#76b4d8",
                "#75b3d7",
                "#73b2d7",
                "#72b1d7",
                "#70b0d6",
                "#6fafd6",
                "#6daed5",
                "#6caed5",
                "#6badd5",
                "#69acd4",
                "#68abd4",
                "#66aad3",
                "#65a9d3",
                "#63a8d2",
                "#62a7d2",
                "#61a7d1",
                "#5fa6d1",
                "#5ea5d0",
                "#5da4d0",
                "#5ba3d0",
                "#5aa2cf",
                "#59a1cf",
                "#57a0ce",
                "#569fce",
                "#559ecd",
                "#549ecd",
                "#529dcc",
                "#519ccc",
                "#509bcb",
                "#4f9acb",
                "#4d99ca",
                "#4c98ca",
                "#4b97c9",
                "#4a96c9",
                "#4895c8",
                "#4794c8",
                "#4693c7",
                "#4592c7",
                "#4492c6",
                "#4391c6",
                "#4190c5",
                "#408fc4",
                "#3f8ec4",
                "#3e8dc3",
                "#3d8cc3",
                "#3c8bc2",
                "#3b8ac2",
                "#3a89c1",
                "#3988c1",
                "#3787c0",
                "#3686c0",
                "#3585bf",
                "#3484bf",
                "#3383be",
                "#3282bd",
                "#3181bd",
                "#3080bc",
                "#2f7fbc",
                "#2e7ebb",
                "#2d7dbb",
                "#2c7cba",
                "#2b7bb9",
                "#2a7ab9",
                "#2979b8",
                "#2878b8",
                "#2777b7",
                "#2676b6",
                "#2574b6",
                "#2473b5",
                "#2372b4",
                "#2371b4",
                "#2270b3",
                "#216fb3",
                "#206eb2",
                "#1f6db1",
                "#1e6cb0",
                "#1d6bb0",
                "#1c6aaf",
                "#1c69ae",
                "#1b68ae",
                "#1a67ad",
                "#1966ac",
                "#1865ab",
                "#1864aa",
                "#1763aa",
                "#1662a9",
                "#1561a8",
                "#1560a7",
                "#145fa6",
                "#135ea5",
                "#135da4",
                "#125ca4",
                "#115ba3",
                "#115aa2",
                "#1059a1",
                "#1058a0",
                "#0f579f",
                "#0e569e",
                "#0e559d",
                "#0e549c",
                "#0d539a",
                "#0d5299",
                "#0c5198",
                "#0c5097",
                "#0b4f96",
                "#0b4e95",
                "#0b4d93",
                "#0b4c92",
                "#0a4b91",
                "#0a4a90",
                "#0a498e",
                "#0a488d",
                "#09478c",
                "#09468a",
                "#094589",
                "#094487",
                "#094386",
                "#094285",
                "#094183",
                "#084082",
                "#083e80",
                "#083d7f",
                "#083c7d",
                "#083b7c",
                "#083a7a",
                "#083979",
                "#083877",
                "#083776",
                "#083674",
                "#083573",
                "#083471",
                "#083370",
                "#08326e",
                "#08316d",
                "#08306b",
            ];

            var d3colors = [
                "#f7fbff",
                "#9ecae1",
                "#deebf7",
                "#c6dbef",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
                "#9ecae1",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
                "#9ecae1",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
            ];

            // Labels of row and columns
            var myGroups = ["A", "B", "C"];
            var myVars = [
                "v1sjjjjjjjjjas das dsa",
                "v2",
                "v3",
                "v4",
                "v5",
                "v6",
                "v7",
                "v8",
                "v9",
                "v10",
            ];

            var data = [
                [
                    ["A", "v1sjjjjjjjjjas das dsa", "30"],
                    ["A", "v3", "22"],
                    ["A", "v4", "14"],
                    ["A", "v5", "59"],
                    ["A", "v6", "52"],
                    ["A", "v7", "83"],
                    ["A", "v8", "20"],
                    ["A", "v9", "99"],
                    ["A", "v10", "66"],
                    ["B", "v1sjjjjjjjjjas das dsa", "37"],
                    ["B", "v2", "50"],
                    ["B", "v3", "83"],
                    ["B", "v4", "74"],
                    ["B", "v5", "85"],
                    ["B", "v7", "82"],
                    ["B", "v8", "14"],
                    ["B", "v9", "6"],
                    ["B", "v10", "67"],
                    ["C", "v1sjjjjjjjjjas das dsa", "96"],
                    ["C", "v2", "13"],
                    ["C", "v3", "98"],
                    ["C", "v4", "10"],
                    ["C", "v5", "86"],
                    ["C", "v6", "23"],
                    ["C", "v7", "74"],
                    ["C", "v9", "73"],
                    ["C", "v10", "40"],
                ],
                [myGroups, myVars],
            ];

            function transformData(dataValue, dateFormat, dateFormat1) {
                var dataValue = data[0];
                var json = {};
                var isKey1Date = false;
                var isKey2Date = false;

                if (isDateFormat(dataValue[0][0])) {
                    isKey1Date = true;
                }
                if (isDateFormat(dataValue[0][1])) {
                    isKey2Date = true;
                }

                var uniqueKey1 = [];
                var uniqueKey2 = [];

                var response = [];

                dataValue.forEach((d) => {
                    var key1 = d[0];
                    var key2 = d[1];

                    if (isKey1Date) {
                        key1 = getDateFormattedData(key1, dateFormat);
                    }

                    if (!json[key1]) {
                        json[key1] = {};
                    }

                    if (isKey2Date) {
                        key2 = getDateFormattedData(key2, dateFormat);
                    }

                    if (!json[key1][key2]) {
                        json[key1][key2] = 0;
                    }

                    if (!uniqueKey1.includes(key1)) {
                        uniqueKey1.push(key1);
                    }

                    if (!uniqueKey2.includes(key2)) {
                        uniqueKey2.push(key2);
                    }

                    var value = d[2];
                    json[key1][key2] += +value;
                });

                if (isKey1Date) {
                    uniqueKey1 = sortDatesArray(uniqueKey1, dateFormat);
                }
                if (isKey2Date) {
                    uniqueKey2 = sortDatesArray(uniqueKey2, dateFormat1);
                }

                console.log(json);
                uniqueKey1.forEach((key1) => {
                    console.log(key1);
                    uniqueKey2.forEach((key2) => {
                        console.log(json[key1][key2]);
                        if (json[key1][key2]) {
                            response.push([key1, key2, json[key1][key2]]);
                        }
                    });
                });

                console.log(response);

                return [response, [uniqueKey1, uniqueKey2]];
            }

            function drawChart(data, plottingConfiguration = {}) {
                window.data = data;
                let {
                    d3colorPalette:
                        d3Colors = defaultD3Config.d3SequentialDefaultTheme,
                    paddingInner,
                    markerShape,
                    curveType,
                    dateFormat = defaultD3Config.dateFormat,
                    dateFormat1 = defaultD3Config.dateFormat,
                } = plottingConfiguration;

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                console.log({ dateFormat, dateFormat1 });
                var [dataValues, [myGroups, myVars]] = transformData(
                    data,
                    dateFormat,
                    dateFormat1
                );

                // var [dataValues, [myGroups, myVars]] = data;

                // set the dimensions and margins of the graph
                d3.selectAll("#my_dataviz").html("");
                (margin = { top: 30, right: 30, bottom: 70, left: 60 }),
                    (width =
                        window.innerWidth - margin.left - margin.right - 20),
                    (height =
                        window.innerHeight - margin.top - margin.bottom - 70);

                // var margin = { top: 30, right: 30, bottom: 30, left: 30 },
                //     width = 1300 - margin.left - margin.right,
                //     height = 600 - margin.top - margin.bottom;

                // append the svg object to the body of the page
                var svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    );

                // Build X scales and axis:
                var x = d3
                    .scaleBand()
                    .range([0, width])
                    .domain(myGroups)
                    .padding(0);
                svg.append("g")
                    .attr("class", "x-axis")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + height + ")"
                    )
                    .call(d3.axisBottom(x).tickSizeOuter(0));

                // Build Y scales and axis:
                var y = d3
                    .scaleBand()
                    .range([height, 0])
                    .domain(myVars)
                    .padding(0.003);
                svg.append("g")
                    .attr("class", "y-axis")
                    .call(d3.axisLeft(y).tickSizeOuter(0));

                // Build color scale
                var myColor = d3
                    .scaleLinear()
                    .range([d3Colors[0], d3Colors[d3Colors.length - 1]])
                    .domain(
                        d3.extent(dataValues, function (d) {
                            return +d[2];
                        })
                    );

                svg.selectAll()
                    .data(dataValues, function (d) {
                        return d[0] + ":" + d[1];
                    })
                    .enter()
                    .append("rect")
                    .attr("x", function (d) {
                        return x(d[0]);
                    })
                    .attr("y", function (d) {
                        return y(d[1]);
                    })
                    .attr("width", x.bandwidth())
                    .attr("height", y.bandwidth())
                    .style("fill", function (d) {
                        return myColor(d[2]);
                    })
                    .attr("class", function (d, i) {
                        return "heatmap" + i;
                    })
                    .on("mouseover mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + margin.left;
                        var y_pos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            .style("left", x_pos + "px")
                            .style("top", y_pos + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            .html(
                                "Group: " +
                                    d[0] +
                                    "<br/>Variable: " +
                                    d[1] +
                                    "<br/>Value: " +
                                    d[2]
                            );
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.select(".heatmap" + i).style("fill", myColor(d[2]));
                    });

                a = document.querySelectorAll(".x-axis text");
                var textWidth = (a[0] && a[0].getBBox().height) || 20;
                var barWidth = x.bandwidth();
                console.log(barWidth);

                removeAxisTicks("xAxis", dataValues, null);

                for (var i = 0; i < a.length; i++) {
                    if (i == 0 && barWidth < textWidth * 0.5) {
                        a[i].setAttribute("dy", "1em");
                        continue;
                    }
                    if (barWidth < textWidth * 0.5) {
                        a[i].setAttribute("dy", "0.8em");
                    }
                }

                if (barWidth < 50) {
                    setXaxisWidth();
                }

                function setXaxisWidth() {
                    var allYAxisTicks =
                        document.querySelectorAll(".x-axis text");
                    var maxWidth = 0;
                    for (var i = 0; i < allYAxisTicks.length; i++) {
                        var tick = allYAxisTicks[i];
                        var width = tick && tick.getBBox().width;
                        if (width > maxWidth) {
                            maxWidth = width;
                        }
                    }

                    extraHeightWorked = true;
                    maxWidth = maxWidth < 60 ? maxWidth : 60;
                    extraHeight = maxWidth;

                    d3.select(".x-axis").attr("text-anchor", "right");
                    d3.selectAll(".x-axis text")
                        .attr("transform", "rotate(-90)")
                        .attr("dy", "0.3em")
                        .attr("text-anchor", "end")
                        // .attr("x", "-" + (maxWidth + 3))
                        .attr("x", "-" + 20)
                        // .attr("font-size", fontSize)
                        .attr("y", "8");
                }
            }

            drawChart(data);
        </script>
    </body>
</html>
