<html>
    <head>
        <meta charset="utf-8" />

        <!-- Load d3.js -->

        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>

        <title>Heatmap</title>
        <link rel="stylesheet" href="Data/general.css" />
        <style type="text/css">
            body {
                padding: 0;
                margin: 0;
            }

            #tooltip {
                font-size: 14px;
                font-family: Arial, Helvetica, sans-serif;
                min-width: fit-content;
                max-width: max-content;
            }

            #my_dataviz {
                overflow-x: scroll;
                margin-left: 102px;
                height: 100vh;
            }

            #xAxisLabelId {
                position: fixed;
                bottom: 15px;
                z-index: -1;
                height: 40px;
                /* background-color: red; */
            }
            /* #legend{
                display: flex;
                flex-direction: column;
            } */
        </style>
    </head>
    <body>
        <!-- Create a div where the graph will take place -->
        <!-- <div id="my_dataviz" style="text-align: center"></div> -->
        <div id="mainChartWindow" style="display: flex">
            <div id="yAxisDiv"></div>
            <div id="my_dataviz"></div>
            <div id="xAxisLabelId" style="position: fixed" ;></div>
        </div>
        <div id="tooltip"></div>

        <div id="legend"></div>

        <script>
            // Spectral color range

            var extraHeightWorked = false;
            var redrawn = false;
            var extraHeight = 0;

            var d3colors = [
                "#ffffff",
                "#f7fbff",
                "#f6faff",
                "#f5fafe",
                "#f5f9fe",
                "#f4f9fe",
                "#f3f8fe",
                "#f2f8fd",
                "#f2f7fd",
                "#f1f7fd",
                "#f0f6fd",
                "#eff6fc",
                "#eef5fc",
                "#eef5fc",
                "#edf4fc",
                "#ecf4fb",
                "#ebf3fb",
                "#eaf3fb",
                "#eaf2fb",
                "#e9f2fa",
                "#e8f1fa",
                "#e7f1fa",
                "#e7f0fa",
                "#e6f0f9",
                "#e5eff9",
                "#e4eff9",
                "#e3eef9",
                "#e3eef8",
                "#e2edf8",
                "#e1edf8",
                "#e0ecf8",
                "#e0ecf7",
                "#dfebf7",
                "#deebf7",
                "#ddeaf7",
                "#ddeaf6",
                "#dce9f6",
                "#dbe9f6",
                "#dae8f6",
                "#d9e8f5",
                "#d9e7f5",
                "#d8e7f5",
                "#d7e6f5",
                "#d6e6f4",
                "#d6e5f4",
                "#d5e5f4",
                "#d4e4f4",
                "#d3e4f3",
                "#d2e3f3",
                "#d2e3f3",
                "#d1e2f3",
                "#d0e2f2",
                "#cfe1f2",
                "#cee1f2",
                "#cde0f1",
                "#cce0f1",
                "#ccdff1",
                "#cbdff1",
                "#cadef0",
                "#c9def0",
                "#c8ddf0",
                "#c7ddef",
                "#c6dcef",
                "#c5dcef",
                "#c4dbee",
                "#c3dbee",
                "#c2daee",
                "#c1daed",
                "#c0d9ed",
                "#bfd9ec",
                "#bed8ec",
                "#bdd8ec",
                "#bcd7eb",
                "#bbd7eb",
                "#b9d6eb",
                "#b8d5ea",
                "#b7d5ea",
                "#b6d4e9",
                "#b5d4e9",
                "#b4d3e9",
                "#b2d3e8",
                "#b1d2e8",
                "#b0d1e7",
                "#afd1e7",
                "#add0e7",
                "#acd0e6",
                "#abcfe6",
                "#a9cfe5",
                "#a8cee5",
                "#a7cde5",
                "#a5cde4",
                "#a4cce4",
                "#a3cbe3",
                "#a1cbe3",
                "#a0cae3",
                "#9ec9e2",
                "#9dc9e2",
                "#9cc8e1",
                "#9ac7e1",
                "#99c6e1",
                "#97c6e0",
                "#96c5e0",
                "#94c4df",
                "#93c3df",
                "#91c3df",
                "#90c2de",
                "#8ec1de",
                "#8dc0de",
                "#8bc0dd",
                "#8abfdd",
                "#88bedc",
                "#87bddc",
                "#85bcdc",
                "#84bbdb",
                "#82bbdb",
                "#81badb",
                "#7fb9da",
                "#7eb8da",
                "#7cb7d9",
                "#7bb6d9",
                "#79b5d9",
                "#78b5d8",
                "#76b4d8",
                "#75b3d7",
                "#73b2d7",
                "#72b1d7",
                "#70b0d6",
                "#6fafd6",
                "#6daed5",
                "#6caed5",
                "#6badd5",
                "#69acd4",
                "#68abd4",
                "#66aad3",
                "#65a9d3",
                "#63a8d2",
                "#62a7d2",
                "#61a7d1",
                "#5fa6d1",
                "#5ea5d0",
                "#5da4d0",
                "#5ba3d0",
                "#5aa2cf",
                "#59a1cf",
                "#57a0ce",
                "#569fce",
                "#559ecd",
                "#549ecd",
                "#529dcc",
                "#519ccc",
                "#509bcb",
                "#4f9acb",
                "#4d99ca",
                "#4c98ca",
                "#4b97c9",
                "#4a96c9",
                "#4895c8",
                "#4794c8",
                "#4693c7",
                "#4592c7",
                "#4492c6",
                "#4391c6",
                "#4190c5",
                "#408fc4",
                "#3f8ec4",
                "#3e8dc3",
                "#3d8cc3",
                "#3c8bc2",
                "#3b8ac2",
                "#3a89c1",
                "#3988c1",
                "#3787c0",
                "#3686c0",
                "#3585bf",
                "#3484bf",
                "#3383be",
                "#3282bd",
                "#3181bd",
                "#3080bc",
                "#2f7fbc",
                "#2e7ebb",
                "#2d7dbb",
                "#2c7cba",
                "#2b7bb9",
                "#2a7ab9",
                "#2979b8",
                "#2878b8",
                "#2777b7",
                "#2676b6",
                "#2574b6",
                "#2473b5",
                "#2372b4",
                "#2371b4",
                "#2270b3",
                "#216fb3",
                "#206eb2",
                "#1f6db1",
                "#1e6cb0",
                "#1d6bb0",
                "#1c6aaf",
                "#1c69ae",
                "#1b68ae",
                "#1a67ad",
                "#1966ac",
                "#1865ab",
                "#1864aa",
                "#1763aa",
                "#1662a9",
                "#1561a8",
                "#1560a7",
                "#145fa6",
                "#135ea5",
                "#135da4",
                "#125ca4",
                "#115ba3",
                "#115aa2",
                "#1059a1",
                "#1058a0",
                "#0f579f",
                "#0e569e",
                "#0e559d",
                "#0e549c",
                "#0d539a",
                "#0d5299",
                "#0c5198",
                "#0c5097",
                "#0b4f96",
                "#0b4e95",
                "#0b4d93",
                "#0b4c92",
                "#0a4b91",
                "#0a4a90",
                "#0a498e",
                "#0a488d",
                "#09478c",
                "#09468a",
                "#094589",
                "#094487",
                "#094386",
                "#094285",
                "#094183",
                "#084082",
                "#083e80",
                "#083d7f",
                "#083c7d",
                "#083b7c",
                "#083a7a",
                "#083979",
                "#083877",
                "#083776",
                "#083674",
                "#083573",
                "#083471",
                "#083370",
                "#08326e",
                "#08316d",
                "#08306b",
            ];

            var d3colors = [
                "#f7fbff",
                "#9ecae1",
                "#deebf7",
                "#c6dbef",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
                "#9ecae1",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
                "#9ecae1",
                "#6baed6",
                "#4292c6",
                "#2171b5",
                "#08519c",
                "#08306b",
                "#f7fbff",
                "#deebf7",
                "#c6dbef",
            ];

            function transformData(
                dataValue,
                dataColumns = {},
                dateFormat,
                dateFormat1
            ) {
                var dataValue = data[0];

                var json = {};
                var isKey1Date = false;
                var isKey2Date = false;

                // [Tag: Date Change]
                var { xAxisColumnDetails = [{}], yAxisColumnDetails = [{}] } =
                    dataColumns;

                // [Tag: Date Change]
                if (xAxisColumnDetails[0].itemType == "Date") {
                    isKey1Date = true;
                    dateFormat = xAxisColumnDetails[0].dateFormat;
                }
                // [Tag: Date Change]
                if (yAxisColumnDetails[0].itemType == "Date") {
                    isKey2Date = true;
                    dateFormat1 = yAxisColumnDetails[0].dateFormat;
                }

                var uniqueKey1 = [];
                var uniqueKey2 = [];

                var response = [];

                dataValue.forEach((d) => {
                    var key1 = d[0];
                    var key2 = d[1];

                    if (isKey1Date) {
                        key1 = getDateFormattedData(key1, dateFormat);
                    }

                    if (!json[key1]) {
                        json[key1] = {};
                    }

                    if (isKey2Date) {
                        key2 = getDateFormattedData(key2, dateFormat1);
                    }

                    if (!json[key1][key2]) {
                        json[key1][key2] = 0;
                    }

                    if (!uniqueKey1.includes(key1)) {
                        uniqueKey1.push(key1);
                    }

                    if (!uniqueKey2.includes(key2)) {
                        uniqueKey2.push(key2);
                    }

                    var value = d[2];
                    json[key1][key2] += +value;
                });

                if (isKey1Date) {
                    uniqueKey1 = sortDatesArray(uniqueKey1, dateFormat);
                }
                if (isKey2Date) {
                    uniqueKey2 = sortDatesArray(uniqueKey2, dateFormat1);
                }

                uniqueKey1.forEach((key1) => {
                    uniqueKey2.forEach((key2) => {
                        if (json[key1][key2]) {
                            response.push([key1, key2, json[key1][key2]]);
                        }
                    });
                });


                return [response, [uniqueKey1, uniqueKey2]];
            }

            function drawChart(data, plottingConfiguration = {}) {
                if (!redrawn) {
                    extraHeight = 0;
                }
                window.data = data;

                let {
                    d3colorPalette:
                        d3Colors = defaultD3Config.d3SequentialDefaultTheme,
                    paddingInner,
                    markerShape,
                    curveType,
                    toolTip,
                    dateFormat = defaultD3Config.dateFormat,
                    dateFormat1 = defaultD3Config.dateFormat,
                    legendConfig = defaultD3Config.defaultLegendConfig,
                    labelConfig = defaultD3Config.defaultlabelConfig,
                    gridConfig = defaultD3Config.defaultGridConfig,
                    dataColumns, // [Tag: Date Change]
                    // font size
                    xLabelfontSize = defaultD3Config.fontSize,
                    yLabelfontSize = defaultD3Config.fontSize,
                    xTickfontSize = defaultD3Config.fontSize,
                    yTickfontSize = defaultD3Config.fontSize,
                    dataLabelfontSize = defaultD3Config.fontSize,
                    // font family
                    xLabelfontFamily = defaultD3Config.fontFamily,
                    yLabelfontFamily = defaultD3Config.fontFamily,
                    xTickfontFamily = defaultD3Config.fontFamily,
                    yTickfontFamily = defaultD3Config.fontFamily,
                    dataLabelfontFamily = defaultD3Config.fontFamily,
                    // font color
                    xLabelfontColor = defaultD3Config.fontColor,
                    yLabelfontColor = defaultD3Config.fontColor,
                    xTickfontColor = defaultD3Config.fontColor,
                    yTickfontColor = defaultD3Config.fontColor,
                    dataLabelColor = defaultD3Config.fontColor,
                    // xaxis setting
                    xAxisConfig = defaultD3Config.xAxisConfig,
                    yAxisConfig = defaultD3Config.yAxisConfig,
                } = plottingConfiguration;
                window.xLabelfontSize = xLabelfontSize;
                window.yLabelfontSize = yLabelfontSize;
                window.xTickfontSize = xTickfontSize;
                window.yTickfontSize = yTickfontSize;
                window.dataLabelfontSize = dataLabelfontSize;

                window.xLabelfontFamily = xLabelfontFamily;
                window.yLabelfontFamily = yLabelfontFamily;
                window.xTickfontFamily = xTickfontFamily;
                window.yTickfontFamily = yTickfontFamily;
                window.dataLabelfontFamily = dataLabelfontFamily;

                window.xLabelfontColor = xLabelfontColor;
                window.yLabelfontColor = yLabelfontColor;
                window.xTickfontColor = xTickfontColor;
                window.yTickfontColor = yTickfontColor;
                window.dataLabelColor = dataLabelColor;
                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                var [dataValues, [myGroups, myVars]] = transformData(
                    data,
                    dataColumns, // [Tag: Date Change]
                    dateFormat,
                    dateFormat1
                );
                let {
                    xlabel,
                    xboldLabel,
                    xitalicLabel,
                    xboldTick,
                    xitalicTick,
                    xaxisStatus,
                } = xAxisConfig;
                let {
                    ylabel,
                    yboldLabel,
                    yitalicLabel,
                    yboldTick,
                    yitalicTick,
                    yaxisStatus,
                } = yAxisConfig;
                window.yboldLabel = yboldLabel;
                window.xboldLabel = xboldLabel;
                window.xitalicLabel = xitalicLabel;
                window.yitalicLabel = yitalicLabel;
                if (!xAxisConfig.xlabel && !yAxisConfig.ylabel) {
                    [xAxisLabel, yAxisLabel, valueLabel] = data[2];
                } else {
                    [xAxisLabel, yAxisLabel, valueLabel] = [
                        xAxisConfig.xlabel,
                        yAxisConfig.ylabel,
                        data[2][2],
                    ];
                }
                // [xAxisLabel, yAxisLabel, valueLabel] = data[2] || [
                //     "xAxisLabel",
                //     "yAxisLabel",
                //     "Value",
                // ];
                if (!toolTip) {
                    toolTip = {
                        textColumn1: xAxisLabel,
                        textColumn2: yAxisLabel,
                        colorData: valueLabel,
                    };
                }

                var [minValue, maxValue] = d3.extent(dataValues, function (d) {
                    return +d[2];
                });


                // var [dataValues, [myGroups, myVars]] = data;
                let { legendStatus, legendPosition } = legendConfig;
                let { gridStatus } = gridConfig;
                let { labelStatus, labelFormat } = labelConfig;

                // set the dimensions and margins of the graph
                d3.selectAll("#my_dataviz").html("");
                d3.selectAll("#yAxisDiv").html("");

                d3.select("#xAxisLabelId").style("bottom", 0);
                (margin = { top: 30, right: 30, bottom: 70, left: 60 }),
                    (width =
                        window.innerWidth - margin.left - margin.right - 20),
                    (height =
                        window.innerHeight -
                        margin.top -
                        margin.bottom -
                        20 -
                        extraHeight);

                // var margin = { top: 30, right: 30, bottom: 30, left: 30 },
                //     width = 1300 - margin.left - margin.right,
                //     height = 600 - margin.top - margin.bottom;

                const yAxisWidth =
                    document.querySelector("#yAxisDiv").clientWidth;
                // append the svg object to the body of the page

                // legends code starts
                d3.select("#legend").html("").style("padding", "");
                if (legendStatus) {
                    d3.select("#legend").html("");

                    // d3.select("#legend")
                    //     .append("p")
                    //     .html(xAxisLabel + "&nbsp;")
                    //     .style("font-weight", "bold")
                    //     .style("margin", "auto")
                    //     .style("position", "sticky");

                    d3.select("#legend")
                        // .selectAll("div")
                        // .data([data[1][0]])
                        // .enter()
                        .append("div")
                        // .html((d, i) => {
                        //     return (
                        //         '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                        //         d3Colors[i % d3Colors.length] +
                        //         ';">  </div>' +
                        //         "<span style='margin-left: 5px; max-width: 160px'>" +
                        //         d +
                        //         "</span>"
                        //     );
                        // })
                        .html((d, i) => {
                            if (1) {
                                return (
                                    '<div style="height: 310px;"><div class="minMaxValue">' +
                                    minValue +
                                    '</div><div style="width: 15px; height: 200px; margin-top:2px; border: 1px solid grey; background-image: linear-gradient(' +
                                    d3Colors[0] +
                                    "," +
                                    d3Colors[1] +
                                    // d3Colors[i % d3Colors.length] +
                                    ');"> </div><div class="minMaxValue">' +
                                    maxValue +
                                    "</div></div>"
                                );
                            }
                        })
                        .style("display", "flex")
                        .style("padding", "2px");
                }

                // legends code ends

                // legends height ,width elements
                var legendElement = document.querySelector("#legend");
                var legendHeight = legendElement.offsetHeight;
                var legendWidth = legendElement.offsetWidth;

                d3.select("#legend").attr("style", null);
                d3.select("#mainChartWindow").attr("style", null);
                d3.select("#xAxisLabelId").style("bottom", 20);

                // legends code starts
                if (legendStatus) {
                    if (
                        legendHeight <
                        document.querySelector("html").offsetHeight
                    ) {
                        topPosition = "calc(50vh - " + legendHeight / 2 + "px)";
                    } else {
                        topPosition = 0;
                    }
                    rightPosition = "calc(50vw - " + legendWidth / 2 + "px)";

                    //  var widthOld = (document.querySelector("#my_dataviz").clientWidth) ;
                    var widthOld =
                        document.querySelector("html").clientWidth - 72;
                    var heightOld = document.querySelector("html").clientHeight;

                    // legendElement.style.padding = "10px";
                    legendElement.style.border = "1px solid black";
                    d3.selectAll("#my_dataviz").style("margin-top", 0 + "px");

                    switch (legendPosition) {
                        case "left":
                            width -= 10;
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", topPosition)
                                .style("right", "auto")
                                // .style("bottom", "auto")
                                .style("left", "0px")

                                // .style("right", "5px")
                                .style("display", "block")
                                .style("max-height", "100vh")
                                .style("overflow", "scroll")
                                .style("border", "none")
                                .style("position", "fixed");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            var legendWidth = legendElement.offsetWidth;
                            // margin.left += 100;
                            // width -= 100;
                            // d3.select("#my_dataviz svg").attr("width", width + margin.left + margin.right);

                            d3.select("#mainChartWindow").attr("style", null);

                            d3.select("#mainChartWindow").style(
                                "width",
                                widthOld - legendWidth + yAxisWidth
                            );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                legendWidth + "px"
                            );
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh)"
                            );

                            break;
                        case "top":
                            d3.select("#mainChartWindow").attr("style", null);
                            // margin.top += 50;
                            height -= 70;
                            width -= 2;
                            y_pos_x_label = 57;
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "-150px")
                                .style("right", rightPosition)
                                .style("bottom", "auto")
                                .style("left", "auto")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow", "scroll")
                                .style("transform", "rotate(-90deg)")
                                .style("border", "none");
                            d3.selectAll(".minMaxValue")
                                .style("transform", "rotate(90deg)")
                                .style("margin-top", "15px")
                                .style("margin-right", "0px")
                                .style("position", "relative")
                                .style("right", "10px");

                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 72px) "
                            );
                            d3.selectAll("#my_dataviz").style(
                                "margin-top",
                                50 + "px"
                            );

                            // d3.selectAll("#legend div").style(
                            //     "padding",
                            //     "2px 4px"
                            // );
                            break;
                        case "bottom":
                            height -= 50; // use legend client height
                            margin.bottom += 10;
                            var legendWidth = legendElement.offsetWidth;
                            y_pos_x_label = 20;

                            d3.select("#xAxisLabelId").style("bottom", "60px");
                            d3.select("#mainChartWindow").attr("style", null);

                            // d3.select("#mainChartWindow").style("width", width);
                            //  d3.select("#mainChartWindow").style("height",heightOld-80 );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                0
                            );
                            d3.selectAll(".minMaxValue").style(
                                "transform",
                                "rotate(90deg)"
                            );
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "auto")
                                .style("right", rightPosition)
                                .style("bottom", "-100px")
                                .style("transform", "rotate(-90deg)")
                                // .style("left", margin.left + "px")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow", "scroll")
                                .style("border", "none");
                            d3.selectAll(".minMaxValue")
                                .style("transform", "rotate(90deg)")
                                .style("margin-top", "15px")
                                .style("margin-right", "0px")
                                .style("position", "relative")
                                .style("right", "10px");

                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 42px)"
                            );

                            break;
                        // For Right Legened
                        case "right":
                        default:
                            width -= 10;

                            // d3.select("#my_dataviz").style("width", width + margin.left + margin.right);
                            var legendWidth = legendElement.offsetWidth;

                            d3.select("#legend")
                                .attr("style", null)
                                .style("right", "0px")
                                .style("left", "auto")
                                .style("position", "fixed")
                                .style("top", topPosition)
                                .style("max-height", "100vh")
                                .style("overflow", "scroll")
                                .style("border", "none")
                                .style("bottom", "auto")
                                .style("display", "block");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap");
                            // .style("overflow", "hidden")
                            // .style("text-overflow", "ellipsis");
                            d3.selectAll(".minMaxValue")
                                // .style("transform", "rotate(90deg)")
                                // .style("margin-top", "15px")
                                // .style("margin-right", "0px")
                                .style("position", "relative");
                            // .style("right", "10px");

                            d3.select("#mainChartWindow").attr("style", null);
                            d3.select("#mainChartWindow").style(
                                "width",
                                widthOld - legendWidth + yAxisWidth - 10 + "px"
                            );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                0
                            );
                            d3.select("#xAxisLabelId").style(
                                "bottom",
                                10 + "px"
                            );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh)"
                            );
                    }
                }

                if (legendPosition == "left" || legendPosition == "right") {
                    var legendWidth = legendElement.offsetWidth;
                    width -= legendWidth;
                }

                // legends code ends
                var svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width - 25 + margin.right)
                    .attr(
                        "height",
                        height + margin.top + margin.bottom + extraHeight
                    )
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + 0 + "," + margin.top + ")"
                    );
                // Build X scales and axis:
                var x = d3
                    .scaleBand()
                    .range([0, width])
                    .domain(myGroups)
                    .padding(0);
                svg.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).tickSizeOuter(0));

                // Build Y scales and axis:
                var y = d3
                    .scaleBand()
                    .range([height, 0])
                    .domain(myVars)
                    .padding(0.003);

                // Build color scale
                var myColor = d3
                    .scaleLinear()
                    .range([d3Colors[0], d3Colors[d3Colors.length - 1]])
                    .domain(
                        d3.extent(dataValues, function (d) {
                            return +d[2];
                        })
                    );
                // var yAxis = d3
                //     .axisLeft(yScale)
                //     .tickSize(0)
                //     .ticks(yaxisTicks)
                //     .tickFormat(d3.format(".2s"));
                d3.select("#yAxisDiv")
                    .append("svg")
                    .attr("width", "102")
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g") //add group to leave margin for axis
                    .attr(
                        "transform",
                        "translate(" +
                            (margin.left + 41) +
                            "," +
                            margin.top +
                            ")"
                    )
                    .append("g")
                    .attr("class", "y-axis")
                    // svg.append("g")
                    //     .attr("class", "y-axis")
                    .call(d3.axisLeft(y).tickSizeOuter(0))
                    .call(y);

                d3.selectAll(".x-axis text")
                    .attr("font-size", xTickfontSize)
                    .attr("font-family", xTickfontFamily)
                    .attr("font-weight", xboldTick ? "bold" : "regular")
                    .attr("font-style", xitalicTick ? "italic" : "regular")
                    .attr("fill", xTickfontColor)
                    .attr("y", 8);
                d3.selectAll("#yAxisDiv text")
                    .attr("font-size", yTickfontSize)
                    .attr("font-family", yTickfontFamily)
                    .attr("font-weight", yboldTick ? "bold" : "regular")
                    .attr("font-style", yitalicTick ? "italic" : "regular")
                    .attr("fill", yTickfontColor);
                if (xaxisStatus) {
                    d3.selectAll("g .x-axis").attr("style", "display: block");
                } else {
                    d3.selectAll("g .x-axis").attr("style", "display: none");
                }
                if (yaxisStatus) {
                    d3.selectAll("g .y-axis").attr("style", "display: block");
                } else {
                    d3.selectAll("g .y-axis").attr("style", "display: none");
                }

                svg.selectAll()
                    .data(dataValues, function (d) {
                        return d[0] + ":" + d[1];
                    })
                    .enter()
                    .append("rect")
                    .attr("x", function (d) {
                        return x(d[0]);
                    })
                    .attr("y", function (d) {
                        return y(d[1]);
                    })
                    .attr("width", x.bandwidth())
                    .attr("height", y.bandwidth())
                    .style("fill", function (d) {
                        return myColor(d[2]);
                    })
                    .style("stroke-width", 0.5)
                    // TODO:
                    .style("stroke", gridStatus ? "grey" : "none")
                    .attr("class", function (d, i) {
                        return "heatmap" + i;
                    })
                    .on("mouseover mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + margin.left;
                        var y_pos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            // .style("left", x_pos + "px")
                            .style("top", y_pos - 45 + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            // .html(
                            //     "Group: " +
                            //         d[0] +
                            //         "<br/>Variable: " +
                            //         d[1] +
                            //         "<br/>Value: " +
                            //         d[2]
                            // );
                            .html(function () {
                                var textValue = d.y0 - d.y1;
                                if (d.y1 < 0) {
                                    textValue = d.y1 - d.y0;
                                }

                                return (
                                    "<div class='arrowTooltip'></div>" +
                                    "<span style='color:grey;''>" +
                                    toolTip.textColumn1 +
                                    ":&nbsp;&nbsp;" +
                                    "</span>" +
                                    "<span style='float: right;'>" +
                                    d[0] +
                                    "</span>" +
                                    "<br/> <br/>" +
                                    "<span style='color:grey;''>" +
                                    toolTip.textColumn2 +
                                    ":&nbsp;&nbsp;" +
                                    "</span>" +
                                    "<span style='float: right;'>" +
                                    d[1] +
                                    "</span>" +
                                    "<br/> <br/>" +
                                    "<span style='color:grey;''>" +
                                    toolTip.colorData +
                                    ":" +
                                    "</span>" +
                                    "<span style='float: right;margin-left: 15px;'>" +
                                    d[2] +
                                    "</span>"
                                );
                            });
                        var scrollVal =
                            document.querySelector("#my_dataviz").scrollLeft;

                        if (
                            x_pos - scrollVal >
                            document.documentElement.clientWidth -
                                document.querySelector("#tooltip").clientWidth -
                                20
                        ) {
                            d3.select("#tooltip").style(
                                "left",
                                x_pos -
                                    scrollVal -
                                    document.querySelector("#tooltip")
                                        .clientWidth +
                                    0 +
                                    "px"
                            );

                            d3.select(".arrowTooltip")
                                //  document.querySelector("#tooltip:before")
                                // .style("height","50px";"width","50px";"background-color","red";")

                                .attr(
                                    "style",
                                    "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';right: -12px; transform: rotate(-90deg)!important;bottom: 22px; position: absolute;"
                                );
                        } else {
                            d3.select("#tooltip").style(
                                "left",
                                x_pos - scrollVal + 55 + "px"
                            );

                            d3.select(".arrowTooltip").attr(
                                "style",
                                "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                            );
                        }
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.select(".heatmap" + i).style("fill", myColor(d[2]));
                    });

                a = document.querySelectorAll(".x-axis text");
                var textWidth = (a[0] && a[0].getBBox().height) || 20;
                var barWidth = x.bandwidth();

                removeAxisTicks("xAxis", dataValues, null);
                removeAxisTicks("yAxis", dataValues, null);

                for (var i = 0; i < a.length; i++) {
                    if (i == 0 && barWidth < textWidth * 0.5) {
                        a[i].setAttribute("dy", "1em");
                        continue;
                    }
                    if (barWidth < textWidth * 0.5) {
                        a[i].setAttribute("dy", "0.8em");
                    }
                }

                if (barWidth < 50) {
                    setXaxisWidth();
                }

                var yAxisDiv = document.querySelector("#yAxisDiv svg");
                // yAxisDiv && yAxisDiv.setAttribute("width", maxWidth);

                // document.querySelector("#my_dataviz").style["margin-left"] =
                //     maxWidth + "px !important";

                // yAxisDiv &&
                //     yAxisDiv.setAttribute(
                //         "transform",
                //         "translate(" + (maxWidth - margin.left) + "," + 0 + ")"
                //     );
                if (labelStatus) {
                    //    var boxClasses = document.querySelectorAll("[class^='heatmap']");

                    //    Array.from(boxClasses).forEach(boxClass =>{
                    //        boxClass.parentElement

                    //        .append("text")
                    //         .attr("class", "axis label");

                    //    })
                    svg.selectAll()
                        .data(dataValues, function (d) {
                            return d[0] + ":" + d[1];
                        })
                        .enter()
                        .append("text")
                        .attr("font-family", dataLabelfontFamily)
                        .attr("font-size", dataLabelfontSize)
                        .attr("fill", dataLabelColor)
                        .text(function (d) {
                            return labelFormatSet(d[2], labelFormat);
                        })
                        .attr("x", function (d) {
                            return x(d[0]) + x.bandwidth() / 2 - 20;
                        })
                        .attr("y", function (d) {
                            return y(d[1]) + y.bandwidth() / 2 + 6;
                        });

                    d3.selectAll("#yAxisDiv text")
                        .attr("font-size", yTickfontSize)
                        .attr("font-family", yTickfontFamily)
                        .attr("fill", yTickfontColor);
                    d3.selectAll(".x-axis text")
                        .attr("font-size", xTickfontSize)
                        .attr("font-family", xTickfontFamily)
                        .attr("fill", xTickfontColor)
                        .attr("y", 8);

                    // svg.append("g")
                    //     .attr("class", "axis label")
                    //     // .attr("transform", "translate(0," + 100 + ")")
                    //     .attr("font-family", xTickfontFamily)

                    //     // .call(xAxis.tickSize(0));
                    //     .call(d3.axisBottom(x).tickSizeOuter(0));
                    // // .call(d3.axisLeft(y).tickSizeOuter(0));

                    // // .attr("transform", "translate(0,0)");
                    // var labelSelector =
                    //     document.querySelectorAll(".axis.label text");

                    // labelSelector.forEach((label, i) => {
                    //     var labelValue = label.textContent;
                    //     // var labelYPosition = yScale(data[0][1][i])
                    //     console.log(data[0]);
                    //     label.setAttribute("y", 200);
                    //     //  label.textContent = textColumn2[1];
                    //     label.textContent = "ijhcv";
                    //     // label.textContent = data[0][0][2];
                    // });
                }

                setLabel(
                    xAxisLabel,
                    "x_label",
                    d3
                        .select("#xAxisLabelId")
                        .append("svg")
                        .attr("width", window.innerWidth, "height", 150),
                    30,
                    false
                );
                setLabel(yAxisLabel, "y_label", d3.select("svg"), false);

                a = document.querySelectorAll(".x-axis text");
                for (var i = 0; i < a.length; i++) {
                    if (a[i] && a[i].innerHTML) {
                        var singleCharacterLength =
                            a[i].getBBox().width / a[i].innerHTML.length;

                        var maxWidth =
                            document.querySelector(".x-axis").getBBox().width >
                            72
                                ? 72
                                : document.querySelector(".x-axis").getBBox()
                                      .width;

                        var numOfCharacters = maxWidth / singleCharacterLength;

                        if (a[i].innerHTML.length > numOfCharacters) {
                            a[i].innerHTML =
                                a[i].innerHTML.substr(0, numOfCharacters - 3) +
                                "...";
                        }
                    }
                }

                function setXaxisWidth() {
                    var allYAxisTicks =
                        document.querySelectorAll(".x-axis text");
                    var maxWidth = 0;
                    for (var i = 0; i < allYAxisTicks.length; i++) {
                        var tick = allYAxisTicks[i];
                        var width = tick && tick.getBBox().width;
                        if (width > maxWidth) {
                            maxWidth = width;
                        }
                    }

                    extraHeightWorked = true;
                    maxWidth = maxWidth < 60 ? maxWidth : 60;
                    extraHeight = maxWidth;

                    d3.select(".x-axis").attr("text-anchor", "right");
                    d3.selectAll(".x-axis text")
                        .attr("transform", "rotate(-90)")
                        .attr("dy", "0.3em")
                        .attr("text-anchor", "end")
                        // .attr("x", "-" + (maxWidth + 3))
                        .attr("x", "-" + 20)
                        // .attr("font-size", fontSize)
                        .attr("y", "8");
                }

                if (extraHeightWorked && !redrawn) {
                    extraHeightWorked = false;
                    redrawn = true;
                    drawChart(window.data, plottingConfiguration);
                }

                if (extraHeightWorked && redrawn) {
                    extraHeightWorked = false;
                    redrawn = false;
                }
            }
        </script>
    </body>
</html>
