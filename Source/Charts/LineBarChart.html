<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Line Bar Chart</title>
        <link rel="icon" href="logo.png" type="image/png" sizes="32x32" />

        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <link rel="stylesheet" href="Data/general.css" />

        <style>
            .line {
                fill: none;
                stroke: #bd7fbe;
                stroke-width: 1;
            }
        </style>
    </head>

    <body>
        <div style="text-align: center">
            <div id="my_dataviz"></div>
        </div>
        <div id="tooltip"></div>

        <script>
            // Color Pallets - Set 3
            const d3colors = [
                "#8DD3C9",
                "#FFFFAA",
                "#B8BED6",
                "#F98171",
                "#78B5D1",
                "#FFB15B",
                "#B4E061",
                "#FDCDE5",
                "#DAD9D4",
                "#BD7FBE",
                "#CDE9C1",
                "#FFEA77",
            ];

            var dataset = [
                [
                    ["a", 703, 1902],
                    ["b", 1473, 3341],
                    ["c", 863, 1935],
                    ["d", 1494, 3008],
                    ["e", 965, 1743],
                    ["f", 568, 1271],
                    ["g", 189, 626],
                    ["i", 731, 1443],
                    ["j", 306, 630],
                    ["k", 899, 2556],
                    ["l", 231, 880],
                    ["m", 262, 589],
                    ["n", 429, 1497],
                    ["o", 322, 749],
                    ["p", 315, 720],
                    ["q", 228, 522],
                    ["r", 436, 1391],
                    ["s", 287, 613],
                    ["t", 419, 932],
                    ["u", 296, 612],
                    ["v", 343, 855],
                ],
                ["Label 1", "Line Data", "bar Fa"],
            ];

            function drawChart(data, plottingConfiguration = {}) {
                window.data = data[0];
                var data = data[0];

                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                    timeParseFormat,
                    dateFormat,
                } = plottingConfiguration;
                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3[d3colorPalette];

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                if (!timeParseFormat) {
                    timeParseFormat = defaultD3Config.defaultTimeParseFormat;
                }

                if (!dateFormat) {
                    dateFormat = defaultD3Config.dateFormat;
                }

                d3.selectAll("#my_dataviz").html("");
                let margin = { top: 30, right: 140, bottom: 70, left: 50 },
                    width = window.innerWidth - margin.left - margin.right - 20,
                    height =
                        window.innerHeight - margin.top - margin.bottom - 20;

                yaxisTicks = height / 100;

                var xScale = d3
                    .scaleBand()
                    .rangeRound([0, width - 20])
                    .padding(0.1)
                    .domain(
                        data.map(function (d) {
                            return d[0];
                        })
                    );

                yScale = d3
                    .scaleLinear()
                    .rangeRound([height, 0])
                    .domain([
                        0,
                        d3.max(data, function (d) {
                            return d[2];
                        }),
                    ]);

                yScale2 = d3
                    .scaleLinear()
                    .rangeRound([height, 0])
                    .domain([
                        0,
                        d3.max(data, function (d) {
                            return d[1];
                        }),
                    ]);

                var svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);

                var g = svg
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    );

                // axis-x
                bottomAxis = g
                    .append("g")
                    .attr("class", "axis axis--x x-axis")
                    .attr("transform", "translate(0," + height + ")");

                if (isDateFormat(data[0])) {
                    bottomAxis.call(
                        d3
                            .axisBottom(xScale)
                            .tickSizeOuter(0)
                            .ticks(data.length)
                            .tickFormat(d3.timeFormat(dateFormat))
                    );
                } else {
                    bottomAxis.call(
                        d3
                            .axisBottom(xScale)
                            .tickSizeOuter(0)
                            .ticks(data.length)
                    );
                }

                // axis-y
                g.append("g")
                    .attr("class", "axis axis--y y-axis")
                    .call(d3.axisLeft(yScale).tickSizeOuter(0));

                g.append("g")
                    .attr("class", "axis axis--y y-axis")
                    .attr("transform", "translate(" + (width - 20) + ", 0)")
                    .call(d3.axisRight(yScale2).tickSizeOuter(0));

                var bar = g.selectAll("rect").data(data).enter().append("g");

                // bar chart
                bar.append("rect")
                    .attr("x", function (d) {
                        return xScale(d[0]);
                    })
                    .attr("y", function (d) {
                        return yScale(d[2]);
                    })
                    .attr("width", xScale.bandwidth())
                    .attr("height", function (d) {
                        return height - yScale(d[2]);
                    })
                    .attr("fill", d3colors[0])
                    .attr("class", function (d, i) {
                        return "bar";
                    })

                    .on("mouseover mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + 150;
                        var y_pos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            .style("left", x_pos + "px")
                            .style("top", y_pos + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            .text(d[1] + ", " + d[2]);
                        d3.selectAll(".bar").style("opacity", 0.3);
                        d3.select(this).style("opacity", 1);
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.selectAll(".bar").style("opacity", 1);
                    });

                // line chart
                var line = d3
                    .line()
                    .x(function (d, i) {
                        return xScale(d[0]) + xScale.bandwidth() / 2;
                    })
                    .y(function (d) {
                        return yScale2(d[1]);
                    });

                bar.append("path")
                    .attr("class", "line") // Assign a class for styling
                    .attr("d", line(data)); // 11. Calls the line generator

                bar.append("circle") // Uses the enter().append() method
                    .attr("class", "dot") // Assign a class for styling
                    .style("fill", d3colors[9])
                    .attr("cx", function (d, i) {
                        return xScale(d[0]) + xScale.bandwidth() / 2;
                    })
                    .attr("cy", function (d) {
                        return yScale2(d[1]);
                    })
                    .attr("r", 5)
                    .on("mouseover mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + 150;
                        var y_pos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            .style("left", x_pos + "px")
                            .style("top", y_pos + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            .html(d[0] + ": " + d[1] + ", " + d[2]);
                        d3.selectAll(".dot").style("opacity", 0.3);
                        d3.selectAll(".line").style("opacity", 0.3);
                        d3.select(this).style("opacity", 1).attr("r", 10);
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.selectAll(".dot").style("opacity", 1).attr("r", 5);
                        d3.selectAll(".line").style("opacity", 1);
                    });
            }

            drawChart(dataset);
        </script>
    </body>
</html>
