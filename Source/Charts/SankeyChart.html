<!DOCTYPE html>
<html>
    <head>
        <title>Sankey Chart</title>
        <!-- <link href="Data/style.css" rel="stylesheet" /> -->
        <link rel="icon" href="logo.png" type="image/png" sizes="32x32" />
        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>

        <style>
            .link {
                fill: none;
                stroke: #000;
                stroke-opacity: 0.2;
            }
            .link:hover {
                stroke-opacity: 0.5;
            }
        </style>
        <script src="./Data/sankeySingle.js"></script>
    </head>
    <body>
        <div id="my_dataviz"></div>

        <script>
            // // set the dimensions and margins of the graph
            // var margin = { top: 10, right: 10, bottom: 10, left: 10 },
            //     width = 450 - margin.left - margin.right,
            //     height = 480 - margin.top - margin.bottom;

            // append the svg object to the body of the page

            // load the data
            var data = {
                nodes: [
                    {
                        node: 0,
                        name: "node0",
                    },
                    {
                        node: 1,
                        name: "node1",
                    },
                    {
                        node: 2,
                        name: "node2",
                    },
                    {
                        node: 3,
                        name: "node3",
                    },
                    {
                        node: 4,
                        name: "node4",
                    },
                ],
                links: [
                    {
                        source: 0,
                        target: 2,
                        value: 7,
                    },
                    {
                        source: 1,
                        target: 2,
                        value: 3,
                    },
                    {
                        source: 1,
                        target: 3,
                        value: 2,
                    },
                    {
                        source: 0,
                        target: 4,
                        value: 2,
                    },
                    {
                        source: 2,
                        target: 3,
                        value: 5,
                    },
                    {
                        source: 2,
                        target: 4,
                        value: 2,
                    },
                    {
                        source: 3,
                        target: 4,
                        value: 4,
                    },
                ],
            };

            function drawChart(graph, plottingConfiguration = {}) {
                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                    timeParseFormat,
                } = plottingConfiguration;
                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3colorPalette;

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                var color = d3.scaleOrdinal(d3Colors);
                d3.selectAll("#my_dataviz").html("");
                const margin = { top: 30, right: 30, bottom: 70, left: 60 },
                    width = window.innerWidth - margin.left - margin.right - 20,
                    height =
                        window.innerHeight - margin.top - margin.bottom - 20;

                var svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    );

                // Color scale used

                // Set the sankey diagram properties
                var sankey = d3
                    .sankey()
                    .nodeWidth(36)
                    .nodePadding(290)
                    .size([width, height]);

                // Constructs a new Sankey generator with the default settings.
                sankey.nodes(graph.nodes).links(graph.links).layout(1);

                // add in the links
                var link = svg
                    .append("g")
                    .selectAll(".link")
                    .data(graph.links)
                    .enter()
                    .append("path")
                    .attr("class", "link")
                    .attr("d", sankey.link())
                    .style("stroke-width", function (d) {
                        return Math.max(1, d.dy);
                    })
                    .sort(function (a, b) {
                        return b.dy - a.dy;
                    });

                // add in the nodes
                var node = svg
                    .append("g")
                    .selectAll(".node")
                    .data(graph.nodes)
                    .enter()
                    .append("g")
                    .attr("class", "node")
                    .attr("transform", function (d) {
                        return "translate(" + d.x + "," + d.y + ")";
                    })
                    .call(
                        d3
                            .drag()
                            .subject(function (d) {
                                return d;
                            })
                            .on("start", function () {
                                this.parentNode.appendChild(this);
                            })
                            .on("drag", dragmove)
                    );

                // add the rectangles for the nodes
                node.append("rect")
                    .attr("height", function (d) {
                        return d.dy;
                    })
                    .attr("width", sankey.nodeWidth())
                    .style("fill", function (d) {
                        return (d.color = color(d.name.replace(/ .*/, "")));
                    })
                    .style("stroke", function (d) {
                        return d3.rgb(d.color).darker(2);
                    })
                    // Add hover text
                    .append("title")
                    .text(function (d) {
                        debugger;
                        return (
                            d.name +
                            "\n" +
                            "There is " +
                            d.value +
                            " stuff in this node"
                        );
                    });

                // add in the title for the nodes
                node.append("text")
                    .attr("x", -6)
                    .attr("y", function (d) {
                        return d.dy / 2;
                    })
                    .attr("dy", ".35em")
                    .attr("text-anchor", "end")
                    .attr("transform", null)
                    .text(function (d) {
                        return d.name;
                    })
                    .filter(function (d) {
                        return d.x < width / 2;
                    })
                    .attr("x", 6 + sankey.nodeWidth())
                    .attr("text-anchor", "start");

                // the function for moving the nodes
                function dragmove(d) {
                    d3.select(this).attr(
                        "transform",
                        "translate(" +
                            d.x +
                            "," +
                            (d.y = Math.max(
                                0,
                                Math.min(height - d.dy, d3.event.y)
                            )) +
                            ")"
                    );
                    sankey.relayout();
                    link.attr("d", sankey.link());
                }
            }

            // drawChart(data);

            window.addEventListener("resize", function () {
                drawChart(data);
            });
        </script>
    </body>
</html>
