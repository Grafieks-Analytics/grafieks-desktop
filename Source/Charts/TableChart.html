<!DOCTYPE html>
<html>
    <!DOCTYPE html>
    <head>
        <meta charset="utf-8" />
        <title>Table</title>

        <script src="./Data/d3DefaultConfig.js"></script>

        <link href="./Data/tabulator.min.css" rel="stylesheet" />
        <script type="text/javascript" src="./Data/tabulator.min.js"></script>
        <link rel="stylesheet" href="./Data/tabulator_style.css" />
        <script src="./Data/utils.js"></script>

        <style>
            body {
                margin: 0px;
                padding: 0px;
            }
            #my_dataviz {
                margin-top: -4px;
            }
        </style>
    </head>

    <body>
        <div id="my_dataviz" style="padding: 0 10px"></div>
        <script>
            function generateNewTr(row, type = "td") {
                var tr = document.createElement("tr");
                var rowValues = Object.values(row);
                for (var i = 0; i < rowValues.length; i++) {
                    var td = document.createElement(type);
                    td.innerText = rowValues[i];
                    tr.appendChild(td);
                }
                return tr;
            }

            function addNewRow(table) {
                var tr = document.createElement("tr");
                for (var i = 0; i < 3; i++) {
                    var td = document.createElement("td");
                    td.innerText = "Test" + i;
                    tr.appendChild(td);
                }
                table.row.add(tr);
            }

            function addHeader() {
                var table = document.querySelector("thead");
                table.appendChild(generateNewTr(window.data[2], "th"));
            }

            function addFooter() {
                var table = document.querySelector("tfoot");
                table.appendChild(generateNewTr(window.data[1], "th"));
            }

            function getColumnNamesConfigArray(data) {
                return data.map((d) => ({ data: d }));
            }

            function setCompact(compactStatus) {
                if (compactStatus) {
                    document.querySelector("table").classList.add("compact");
                } else {
                    document.querySelector("table").classList.remove("compact");
                }
            }
            function grandTotalStatus(totalStatus) {
                if (totalStatus) {
                    document.querySelectorAll("tfoot").forEach((e) => {
                        e.style.display = "table-footer-group";
                    });
                } else {
                    document.querySelectorAll("tfoot").forEach((e) => {
                        e.style.display = "none";
                    });
                }
            }
            function searchToggle(searchStatus) {
                if (searchStatus) {
                    document.getElementById("example_filter").style.display =
                        "block";
                } else {
                    document.getElementById("example_filter").style.display =
                        "none";
                }
            }

            function init() {
                document.querySelector(
                    "#my_dataviz"
                ).innerHTML = `<table id="example" class="ui celled table very compact">
                            <thead></thead>
                            <tbody></tbody>
                            <tfoot></tfoot>
                        </table>`;

                // removeCellBorder();
                // removeHoverBackground();
                // removeRowAlternateColor();
                // setCompact(false);
            }

            function clearChart() {
                init();
            }

            function drawChart(data, plotConfiguration = {}) {
                window.data = data;
                if (window.tableInstance) {
                    tableInstance.destroy();
                }
                init();
                let {
                    defaultCellBorderStatus,
                    defaultCellHoverStatus,
                    defaultCompactStatus,
                    defaultSearchStatus,
                    defaultRowAlternateStatus,
                    defaultBatchsize,
                    defaultGrandTotalStatus,
                } = defaultD3Config.defaultTableChartConfig;
                let {
                    cellBorderStatus = defaultCellBorderStatus,
                    hoverStatus = defaultCellHoverStatus,
                    compactStatus = defaultCompactStatus,
                    searchStatus = defaultSearchStatus,
                    rowAlternateStatus = defaultRowAlternateStatus,
                    batchSize = defaultBatchsize,
                    totalStatus = defaultGrandTotalStatus,
                } = plotConfiguration;

                // addHeader();
                // addFooter();

                if (!cellBorderStatus) {
                    removeCellBorder();
                } else {
                    addCellBorder();
                }

                if (hoverStatus) {
                    addHoverBackground();
                } else {
                    removeHoverBackground();
                }

                if (rowAlternateStatus) {
                    addRowAlternateColor();
                } else {
                    removeRowAlternateColor();
                }

                setCompact(compactStatus);
                grandTotalStatus(totalStatus);

                // window.dataTableValues = createBatches(data[0], batchSize);
                window.counter = 0;

                //custom max min header filter
                //custom max min header filter
                var minMaxFilterEditor = function (
                    cell,
                    onRendered,
                    success,
                    cancel,
                    editorParams
                ) {
                    var end;

                    var container = document.createElement("span");

                    //create and style inputs
                    var start = document.createElement("input");
                    start.setAttribute("type", "number");
                    start.setAttribute("placeholder", "Min");

                    start.style.padding = "4px";
                    start.style.width = "50%";
                    start.style.boxSizing = "border-box";

                    start.value = cell.getValue();

                    function buildValues() {
                        success({
                            start: start.value,
                            end: end.value,
                        });
                    }

                    function keypress(e) {
                        if (e.keyCode == 13) {
                            buildValues();
                        }

                        if (e.keyCode == 27) {
                            cancel();
                        }
                    }

                    end = start.cloneNode();
                    end.setAttribute("placeholder", "Max");

                    start.addEventListener("change", buildValues);
                    start.addEventListener("blur", buildValues);
                    start.addEventListener("keydown", keypress);

                    end.addEventListener("change", buildValues);
                    end.addEventListener("blur", buildValues);
                    end.addEventListener("keydown", keypress);

                    container.appendChild(start);
                    container.appendChild(end);

                    return container;
                };

                //custom max min filter function
                function minMaxFilterFunction(
                    headerValue,
                    rowValue,
                    rowData,
                    filterParams
                ) {
                    //headerValue - the value of the header filter element
                    //rowValue - the value of the column in this row
                    //rowData - the data for the row being filtered
                    //filterParams - params object passed to the headerFilterFuncParams property

                    if (rowValue) {
                        if (headerValue.start != "") {
                            if (headerValue.end != "") {
                                return (
                                    rowValue >= headerValue.start &&
                                    rowValue <= headerValue.end
                                );
                            } else {
                                return rowValue >= headerValue.start;
                            }
                        } else {
                            if (headerValue.end != "") {
                                return rowValue <= headerValue.end;
                            }
                        }
                    }

                    return true; //must return a boolean, true if it passes the filter.
                }

                var table = new Tabulator("#example", {
                    layout: "fitColumns",
                    height: "calc(100vh - 26px)",
                    movableColumns: true,
                    columns: data[2].map((d, i) => {
                        var obj = { title: d, field: d };
                        if (data[1][i] !== "") {
                            console.log("Value", data[1][i]);
                            obj["bottomCalc"] = "sum";

                            (obj.headerFilter = minMaxFilterEditor),
                                (obj.headerFilterFunc = minMaxFilterFunction);
                            obj.headerFilterLiveFilter = false;
                        } else {
                            obj.headerFilter = "input";
                        }
                        return obj;
                    }),
                });
                // var tableData = [
                //     {id:1, name:"Billy Bob", age:"12", gender:"male", height:1, col:"red", dob:"", cheese:1},
                //     {id:2, name:"Mary May", age:"1", gender:"female", height:2, col:"blue", dob:"14/05/1982", cheese:true},
                // ]

                table.setData(data[0]);

                // window.tableInstance = $("#example").DataTable({
                //     scrollY: "calc(100vh - 180px)",
                //     bPaginate: false,
                //     // scroller: {
                //     //     loadingIndicator: true,
                //     // },
                //     scroller: true,
                //     deferRender: true,
                //     data: window.dataTableValues[window.counter++],
                //     bInfo: false,
                //     responsive: false
                // });

                // setLazyLoadHandler();
                // searchToggle(searchStatus);
            }

            drawChart(data);

            function updateTable() {
                addDataToRow();
            }

            function addCellBorder() {
                document.querySelector("#cellBorderStyle") &&
                    document.querySelector("#cellBorderStyle").remove();
            }

            function removeCellBorder() {
                addCellBorder();
                var styleTag = document.createElement("style");
                styleTag.id = "cellBorderStyle";
                styleTag.innerHTML = " td{ border: 0 !important; }";
                document.head.appendChild(styleTag);
            }

            function removeHoverBackground() {
                document.querySelector("#cellHoverStyle") &&
                    document.querySelector("#cellHoverStyle").remove();
            }

            function addHoverBackground() {
                var styleTag = document.createElement("style");
                styleTag.id = "cellHoverStyle";
                styleTag.innerHTML =
                    "td:hover { background-color: #d9d9d988; }";
                document.head.appendChild(styleTag);
            }

            function removeRowAlternateColor() {
                document.querySelector("#alternateRow") &&
                    document.querySelector("#alternateRow").remove();
            }

            function addRowAlternateColor() {
                var styleTag = document.createElement("style");
                styleTag.id = "alternateRow";
                styleTag.innerHTML =
                    ".tabulator-row-odd { background-color: #d9d9d933; }";
                document.head.appendChild(styleTag);
            }

            function setLazyLoadHandler() {
                var tableScrollBody = document.querySelector(
                    ".dataTables_scrollBody"
                );
                tableScrollBody.addEventListener("scroll", function (event) {
                    var element = event.target;
                    if (!window.dataTableValues[window.counter]) {
                        return;
                    }
                    if (
                        element.scrollTop + element.clientHeight + 100 >
                        element.scrollHeight
                    ) {
                        console.log("Adding new data");
                        window.scrollBarPosition = Math.abs(
                            element.clientHeight - element.scrollTop
                        );
                        updateTable();
                    }
                });
            }

            function addDataToRow() {
                tableInstance.rows
                    .add(window.dataTableValues[window.counter++])
                    .draw();
            }
        </script>
    </body>
</html>
