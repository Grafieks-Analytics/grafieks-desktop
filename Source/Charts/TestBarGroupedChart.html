<html>
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <div id="bar_cont"></div>
    <script>
        const data = [
                {
                    model_name: "f1",
                    field1: 19,
                    field2: 83,
                    field3: 100,
                    field4: 30,
                },
                {
                    model_name: "f2",
                    field1: 67,
                    field2: 29,
                    field3: 100,
                    field4: 130,
                },
                {
                    model_name: "f3",
                    field1: 10,
                    field3: 100,
                },
                {
                    model_name: "f4",
                    field1: 98,
                    field2: 43,
                    field3: 100,
                },
            ],
            all_keys = ["field1", "field2", "field3", "field4"];

        const container = d3.select("#bar_cont");
        // width = 500,
        // height = 300,
        // margin = { top: 30, right: 20, bottom: 30, left: 50 },
        // barPadding = 0.2;

        var margin = { top: 40, right: 0, bottom: 20, left: 70 };
        var width = window.innerWidth - margin.left - margin.right - 70;
        var height = window.innerHeight - margin.top - margin.bottom;
        var barPadding = 0.2;

        const svg = container
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const xScale0 = d3
            .scaleBand()
            .range([0, width - margin.left - margin.right])
            .padding(barPadding);
        const yScale = d3
            .scaleLinear()
            .range([height - margin.top - margin.bottom, 0]);

        const xAxis = d3.axisBottom(xScale0);
        const yAxis = d3.axisLeft(yScale);

        xScale0.domain(data.map((d) => d.model_name));
        yScale.domain([0, d3.max(data, (d) => d3.max(all_keys, (k) => d[k]))]);

        svg.selectAll(".groups")
            .data(data)
            .enter()
            .append("g")
            .attr("class", "model_name")
            .each(function (group_data) {
                const bar_data = getBars(group_data),
                    x_offset = groupOffset(group_data),
                    group_keys = bar_data.map((d) => d.name);
                xScale1 = d3
                    .scaleBand()
                    .domain(group_keys)
                    .range([0, xScale0.bandwidth() - x_offset * 2])
                    .padding(barPadding);

                d3.select(this)
                    .attr(
                        "transform",
                        (d) =>
                            `translate(${xScale0(d.model_name) + x_offset},0)`
                    )
                    .selectAll(".bar")
                    .data(bar_data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .style("fill", "#80b1d3")
                    .attr("x", (d) => xScale1(d.name))
                    .attr("y", (d) => yScale(d.value))
                    .attr("width", xScale1.bandwidth())
                    .attr("height", (d) => {
                        return (
                            height -
                            margin.top -
                            margin.bottom -
                            yScale(d.value)
                        );
                    });
            });

        // Add the X Axis
        svg.append("g")
            .attr("class", "x axis")
            .attr(
                "transform",
                `translate(0,${height - margin.top - margin.bottom})`
            )
            .call(xAxis);

        // Add the Y Axis
        svg.append("g").attr("class", "y axis").call(yAxis);

        var maxWidth = 0;
        getMaxWidth();

        function getMaxWidth() {
            var a = document.querySelectorAll(".model_name");
            for (var i = 0; i < a.length; i++) {
                if (maxWidth < a[i].getBBox().width) {
                    maxWidth = a[i].getBBox().width;
                }
            }
        }

        console.log({ maxWidth });

        var a = document.querySelectorAll(".model_name");
        for (var i = 0; i < a.length; i++) {}

        function getBars(d) {
            const bars = [];
            all_keys.forEach((k) => {
                if (d.hasOwnProperty(k)) {
                    bars.push({ name: k, value: d[k], data: d });
                }
            });
            return bars;
        }

        function groupOffset(d) {
            const groupElementsCount = all_keys.reduce(
                    (acc, k) => (d.hasOwnProperty(k) ? (acc += 1) : acc),
                    0
                ),
                allElementsCount = all_keys.length,
                groupWidth = xScale0.bandwidth(),
                x_offset =
                    ((1 - groupElementsCount / allElementsCount) * groupWidth) /
                    2;

            return x_offset;
        }
    </script>
</html>
