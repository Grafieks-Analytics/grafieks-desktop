<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <!-- external libs from cdnjs -->

        <script
            type="text/javascript"
            src="./Data/jquery-3.5.1.min.js"
        ></script>

        <script type="text/javascript" src="./Data/jquery-ui.min.js"></script>

        <!-- <script type="text/javascript" src="./Data/pivot.min.js"></script> -->
        <script
            type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/pivottable/2.14.0/pivot.min.js"
        ></script>

        <link rel="stylesheet" type="text/css" href="./Data/pivot.min.css" />

        <script
            type="text/javascript"
            src="./Data/multifact-pivottable.js"
        ></script>

        <link rel="stylesheet" href="Data/general.css" />

        <!-- PivotTable.js libs from cdnjs -->

        <style>
            .pvtAxisContainer,
            .pvtVals,
            .pvtRenderer {
                display: none !important;
            }
        </style>
    </head>
    <body>
        <script>
            var plottingConfiguration = {
                pivotTableConfiguration: {
                    cols: ["Gender"],
                    rows: ["Department", "Program", "Fee Paid"],
                    values: ["English Marks", "History Marks", "Maths Marks"],
                },
            };

            var data = [
                [
                    "Student Name",
                    "Gender",
                    "Maths Marks",
                    "English Marks",
                    "History Marks",
                    "Fee Paid",
                    "Department",
                    "Program",
                ],

                ["Clint West", "MALE", "3", "3", "5", "N", "Biotech", "UG"],
                [
                    "Johnathan Howard",
                    "FEMALE",
                    "4",
                    "6",
                    "5",
                    "N",
                    "Biotech",
                    "PG",
                ],
                [
                    "Johnathan Howard",
                    "FEMALE",
                    "4",
                    "6",
                    "5",
                    "N",
                    "Biotech",
                    "yNPG",
                ],
                [
                    "Johnathan Howard",
                    "FEMALE",
                    "4",
                    "6",
                    "5",
                    "Y",
                    "Biotech",
                    "yNPG",
                ],
                [
                    "Chantal Norton",
                    "FEMALE",
                    "10",
                    "6",
                    "4",
                    "Y",
                    "Biotech",
                    "PG",
                ],
                [
                    "Alfie-James John",
                    "MALE",
                    "1",
                    "4",
                    "4",
                    "Y",
                    "Biotech",
                    "UG",
                ],
                [
                    "Lucy Lawrence",
                    "FEMALE",
                    "10",
                    "5",
                    "4",
                    "Y",
                    "Biotech",
                    "UG",
                ],
                ["Adrian Rose", "FEMALE", "8", "3", "6", "Y", "Biotech", "UG"],
                ["Anja Britt", "FEMALE", "8", "3", "3", "Y", "Biotech", "UG"],
                [
                    "Caoimhe Mccullough",
                    "FEMALE",
                    "8",
                    "6",
                    "5",
                    "Y",
                    "Biotech",
                    "UG",
                ],
                ["Ameer Hobbs", "MALE", "3", "3", "6", "Y", "Biotech", "PG"],
                [
                    "Nicolas Villanueva",
                    "MALE",
                    "1",
                    "2",
                    "1",
                    "Y",
                    "Biotech",
                    "PG",
                ],
                ["Ishaaq Ware", "MALE", "1", "2", "2", "Y", "Biotech", "PG"],
            ];

            function drawChart(data, plottingConfiguration = {}) {
                let { pivotTableConfiguration } = plottingConfiguration;

                var { cols, rows, values } = pivotTableConfiguration;

                var aggMap = {};
                values.forEach((d, i) => {
                    aggMap[i] = {
                        aggType: "Sum",
                        arguments: [d],
                        name: d,
                    };
                });

                var customAggs = {};
                customAggs[
                    "Multifact Aggregators"
                ] = $.pivotUtilities.multifactAggregatorGenerator(aggMap, []);
                // customAggs["Total Subtotal"] =
                //     $.pivotUtilities.subtotal_renderers["Table With Subtotal"];

                // var dataClass = $.pivotUtilities.SubtotalPivotData;
                // console.log(dataClass);
                // var renderer =
                //     $.pivotUtilities.subtotal_renderers["Table With Subtotal"];

                var config = {
                    // dataClass,
                    cols,
                    rows,
                    rowOrder: "key_a_to_z",
                    colOrder: "key_a_to_z",
                    aggregatorName: "Multifact Aggregators",

                    rendererName: "GT Table",
                    rendererOptions: {
                        aggregations: {
                            defaultAggregations: aggMap,
                        },
                    },
                    // renderer,
                    showUI: false,
                };

                $.pivotUtilities.customAggs = customAggs;

                config.aggregators = $.extend(
                    $.pivotUtilities.aggregators,
                    $.pivotUtilities.customAggs
                );

                config.renderers = $.extend(
                    $.pivotUtilities.renderers,
                    $.pivotUtilities.gtRenderers
                );

                var renderPivot = function (data) {
                    $("#output").pivotUI(data, config);
                };

                renderPivot(data);
            }
        </script>
        <div class="container">
            <div>
                <div id="output" style="margin: 30px"></div>
            </div>
        </div>

        <script>
            drawChart(data, plottingConfiguration);

            function leftTotal(totalSubColumns) {
                var totalColumn = $(".pvtTotalLabel");
                var column1 = $("th.pvtColLabel");

                const firstRow = $("thead:first-child")[0].rows[0].children;
                var totalColumns = 0;

                for (var i = 0; i < firstRow.length; i++) {
                    var cell = firstRow[i];
                    var colspanAttritubeValue = cell.colSpan || 0;
                    if (
                        !colspanAttritubeValue ||
                        !(
                            cell.className.includes("pvtTotalLabel") ||
                            cell.className.includes("pvtColLabel")
                        )
                    ) {
                        continue;
                    }
                    totalColumns += colspanAttritubeValue;
                }

                $(column1.get(0)).before(totalColumn.get(0));

                var a = $("td.rowTotal");
                totalSubColumns = totalSubColumns || 3;

                var trsBefore = $("td[data-value]");
                for (var i = 0; i < trsBefore.length; i += totalColumns) {
                    var row = $(trsBefore).splice(i, totalColumns);
                    var lastSubColumns = row.splice(-3);
                    for (var j = 0; j < totalSubColumns; j++) {
                        trsBefore.get(i).before(lastSubColumns[j]);
                    }
                }
            }

            function rightTotal(totalSubColumns) {
                const firstRow = $("thead:first-child")[0].rows[0].children;
                var totalColumns = 0;

                // find totalColumns
                for (var i = 0; i < firstRow.length; i++) {
                    var cell = firstRow[i];
                    var colspanAttritubeValue = cell.colSpan || 0;
                    if (
                        !colspanAttritubeValue ||
                        !(
                            cell.className.includes("pvtTotalLabel") ||
                            cell.className.includes("pvtColLabel")
                        )
                    ) {
                        continue;
                    }
                    totalColumns += colspanAttritubeValue;
                }

                // Move header
                var totalColumn = $(".pvtTotalLabel");
                var column1 = $("tr:first-child th.pvtColLabel");
                $(column1.get(column1.length - 1)).after(totalColumn.get(0));

                // move data table
                totalSubColumns = totalSubColumns || 3;
                var trsBefore = $("td[data-value]");
                for (var i = 0; i < trsBefore.length; i += totalColumns) {
                    var row = $(trsBefore).splice(i, totalColumns);
                    var lastSubColumns = row.splice(-3);
                    var lastColumn = lastSubColumns[totalSubColumns - 1];
                    for (var j = 0; j < totalSubColumns; j++) {
                        var column = trsBefore.get(i + j);
                        lastColumn.after(column);
                        lastColumn = trsBefore.get(i + j);
                    }
                }
            }

            function topTotal() {
                var firstRow = $(".pvtTable tbody tr:first-child");
                var lastRow = $(".pvtTable tbody th.pvtTotalLabel")[0]
                    .parentElement;
                $(firstRow.get(0)).after(lastRow);
            }

            function bottomTotal() {
                var lastRow = $(".pvtTable tbody tr:last-child");
                var firstRow = $(".pvtTable tbody th.pvtTotalLabel")[0]
                    .parentElement;
                $(lastRow.get(0)).after(firstRow);
            }

            function subTotal() {
                console.clear();

                flag = false;
                var subtotalData = {};

                var tableRows = $(".pvtTable tbody tr");

                var firstTableRow = $(tableRows[1]).find("th.pvtRowLabel");
                var totalRowColumns =
                    (firstTableRow && firstTableRow.length) || 0;

                var totalSubRows = totalRowColumns - 1;
                var totalColumns = tableRows[1].children.length;

                console.log({ totalColumns, totalRowColumns, totalSubRows });

                stack = [[], [], []];

                var subTotalRow = [];
                var parents = [];
                var lastLevel = 0;

                var parentRow = null;
                for (var i = 1; i < tableRows.length; i++) {
                    var tableRow = tableRows[i];

                    var cellValues = tableRow.children;
                    var initPoint = totalColumns - cellValues.length;

                    var totalTraversing = totalRowColumns - initPoint;
                    for (var j = 0; j < totalTraversing; j++) {
                        var level = j + initPoint;
                        console.log({ level });

                        if (
                            (!level || lastLevel != level) &&
                            totalSubRows > level
                        ) {
                            parents.push({ level, tableRow });
                            lastLevel = level;
                        }

                        var rowHeading = cellValues[j];
                        var rowSpan = rowHeading.rowSpan;
                        var colSpan = rowHeading.colSpan;

                        if (
                            (rowHeading.innerText &&
                                subTotalRow.length &&
                                level < totalSubRows) ||
                            rowHeading.className.includes("pvtColTotalLabel")
                        ) {
                            console.log("Subtotal Checkpoint");
                            var targetRow = tableRows[i - 1];

                            if (!parentRow) {
                                parentRow = parents.splice(-1)[0];
                            }
                            console.log("Parent Row", parentRow);

                            subtotalData[level] = {
                                parentRow,
                                columnNumber: j,
                            };

                            if (rowHeading.innerText == "Totals") {
                                console.log({ targetRow });
                                processSubtotal(
                                    parentRow,
                                    targetRow,
                                    subtotalData,
                                    level,
                                    totalRowColumns,
                                    initPoint,
                                    totalColumns,
                                    subTotalRow,
                                    totalSubRows,
                                    totalColumns
                                );
                            } else {
                                processSubtotal(
                                    parentRow,
                                    targetRow,
                                    subtotalData,
                                    level,
                                    totalRowColumns,
                                    initPoint,
                                    totalColumns,
                                    subTotalRow,
                                    totalSubRows,
                                    totalColumns
                                );
                                parentRow = { tableRow };
                            }
                            if (!flag) {
                                delete subtotalData[level];
                            }
                            subTotalRow = [];
                        }
                    }

                    for (
                        var j = totalRowColumns - initPoint, k = 0;
                        j < cellValues.length;
                        j++, k++
                    ) {
                        if (
                            subTotalRow.length !=
                            totalColumns - totalRowColumns
                        ) {
                            var value = +cellValues[j].innerText || 0;
                            subTotalRow.push(+value);
                        } else {
                            var lastValue =
                                +subTotalRow[k] +
                                +(cellValues[j].innerText || 0);
                            subTotalRow[k] = +lastValue;
                        }
                    }
                }

                console.log(parents);
            }

            function processSubtotal(
                parentRow,
                targetRow,
                subtotalData,
                level,
                totalRowColumns,
                initPoint,
                totalColumns,
                subTotalRow,
                totalSubRows,
                totalColumns
            ) {
                console.log({ subTotalRow, targetRow, subtotalData, level });

                if (level == totalSubRows) {
                    level = totalSubRows - 1;
                }
                if (!parentRow) {
                    return;
                }
                var parentRow = parentRow.tableRow;
                var currentRowTotalLength = parentRow.children.length;
                var changeColumn = false;
                if (totalColumns != currentRowTotalLength) {
                    changeColumn = true;
                }
                for (var i = level; i >= 0; i--) {
                    var columnIndex = i;
                    if (changeColumn) {
                        columnIndex = i - 1;
                    }
                    if (columnIndex < 0) {
                        continue;
                    }
                    var column = parentRow.children[columnIndex];
                    column.rowSpan = column.rowSpan + 1;
                }

                var trRow = document.createElement("tr");

                console.log("Uodate Column", targetRow.children[level - 1]);
                console.log(
                    "Update column",
                    targetRow.children[level - 1].colSpan
                );
                console.log(
                    "Update column",
                    targetRow.children[level - 1].rowSpan
                );

                var th = document.createElement("th");
                th.className = "pvtRowLabel";
                th.setAttribute(
                    "colspan",
                    targetRow.children[level - 1].colSpan
                );
                th.setAttribute(
                    "rowspan",
                    targetRow.children[level - 1].rowSpan
                );
                th.innerHTML = "Sub Total";
                trRow.appendChild(th);

                for (var i = 0; i < subTotalRow.length; i++) {
                    var td = document.createElement("td");
                    td.className = "pvtVal row1 col0 stat0";
                    td.innerHTML =
                        "<span><span>" + subTotalRow[i] + "</span></span>";
                    trRow.appendChild(td);
                }

                $(targetRow).after(trRow);
            }

            function addSubTotalRow(
                currentRow,
                subTotalRow,
                colSpan,
                rowSpan,
                columnNumber
            ) {
                console.log(currentRow);
                var tr = document.createElement("tr");

                var th = document.createElement("th");
                th.className = "pvtRowLabel";
                th.setAttribute("colspan", colSpan);
                th.setAttribute("rowspan", rowSpan);
                th.innerHTML = "Sub Total";
                tr.appendChild(th);

                for (var i = 0; i < subTotalRow.length; i++) {
                    var td = document.createElement("td");
                    td.className = "pvtVal row1 col0 stat0";
                    td.innerHTML =
                        "<span><span>" + subTotalRow[i] + "</span></span>";
                    tr.appendChild(td);
                }
                $(currentRow).before(tr);
                console.log(currentRow, subTotalRow);
            }
        </script>
    </body>
</html>
