<!DOCTYPE html>

<head>
    <meta charset="utf-8" />

    <!-- Load d3.js -->
    <script src="./Data/d3.v4.min.js"></script>

    <!-- Color scale -->
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>

    <script src="Data/d3-scale-chromatic.v1.min.js"></script>
    <script src="./Data/min/numeral.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <title>Pie Chart</title>
    <style>
        /* svg {
            -webkit-filter: drop-shadow(0px 3px 3px rgba(0, 0, 0, 0.3));
            filter: drop-shadow(0px 3px 3px rgba(0, 0, 0, 0.25));
        } */
        body {
            overflow: hidden;
        }
        #my_dataviz {
            margin-left: 0px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Create a div where the graph will take place -->
    <div id="my_dataviz"></div>
    <div id="tooltip"></div>
    <div id="legend"></div>

    <script>
        // var data = { a: 9, b: 20, c: 30, d: 8, e: 12, g: 45 };

        // var data = {
        //     Accessories: 938,
        //     Appliances: 1060,
        //     Art: 2756,
        //     Binders: 2114,
        //     Bookcases: 8016,
        //     Chairs: 6906,
        //     Envelopes: 1134,
        //     Fasteners: 160,
        //     Furnishings: 2398,
        //     Labels: 192,
        //     Paper: 1198,
        //     Phones: 8372,
        //     Storage: 4638,
        //     Supplies: 132,
        //     Tables: 10230,
        // };
        // var data = [
        //     {
        //         Accessories: 938,
        //         Appliances: 1060,
        //         Art: 2756,
        //         Binders: 2114,
        //         Bookcases: 8016,
        //         Chairs: 6906,
        //         Envelopes: 1134,
        //         Fasteners: 160,
        //         Furnishings: 2398,
        //         Labels: 192,
        //         Paper: 1198,
        //         Phones: 8372,
        //         Storage: 4638,
        //         Supplies: 132,
        //         Tables: 10230,
        //     },
        //     ["sub-category", "sales"],
        // ];
        var data = [
            {
                "2020-01-01": 120,
                "2020-02-01": 120,
                "2020-03-01": 120,
                "2020-04-01": 120,

                "2021-01-01": 120,
                "2021-02-02": 120,
                "2021-03-03": 120,
                "2021-04-01": 120
            },
            ["order-date", "sales"]
        ];

        data = [
            {
                Furniture: 741999.7952914548,
                "Office Supplies Supplies Supplies": 719047.0319998885,
                Technology: 836154.0329775356
            },
            ["Category", "Sales"]
        ];

        function transformData(dataValues, dataColumns = {}, dateFormat) {
            var isKey1Date = false;

            var { xAxisColumnDetails = [], colorByData = [] } = dataColumns;

            if (xAxisColumnDetails.length && xAxisColumnDetails[0].itemType == "Date") {
                isKey1Date = true;
            }

            if (!isKey1Date) {
                return dataValues;
            }
            var json = {};
            var uniqueKey = [];
            Object.keys(dataValues[0]).forEach((d) => {
                var key = getDateFormattedData(d, dateFormat);
                if (!uniqueKey.includes(key)) {
                    uniqueKey.push(key);
                }

                if (!json[key]) {
                    json[key] = 0;
                }

                console.log(dataValues[0][d]);
                json[key] += dataValues[0][d];
            });

            var jsonKeys = Object.keys(json).filter((d) => {
                if (json[d] < 0) {
                    return false;
                }
                return true;
            });

            var finalJson = {};
            jsonKeys.forEach((d) => {
                finalJson[d] = json[d];
            });

            dataValues[0] = finalJson;

            return dataValues;
        }

        function drawChart(data, plottingConfiguration = {}) {
            let {
                d3colorPalette = defaultD3Config.d3ColorPalette,
                paddingInner,
                dataColumns,
                legendConfig = defaultD3Config.defaultLegendConfig,
                labelConfig = defaultD3Config.defaultlabelConfig,
                dateFormat = defaultD3Config.dateFormat,
                innerRadius = defaultD3Config.innerRadius,
                toolTip,
                dataLabelfontSize = defaultD3Config.fontSize,
                dataLabelfontFamily = defaultD3Config.fontFamily,
                dataLabelColor = defaultD3Config.fontColor
            } = plottingConfiguration;
            window.dataLabelfontSize = dataLabelfontSize;
            window.dataLabelfontFamily = dataLabelfontFamily;
            window.dataLabelfontSize = dataLabelfontSize;

            d3Colors = d3colorPalette;
            var data = transformData(data, dataColumns, dateFormat);
            // set the dimensions and margins of the graph
            var margin = constants.chartMargins;
            var width = window.innerWidth;
            var height = window.innerHeight;

            let { legendStatus, legendPosition } = legendConfig;
            let { labelStatus, labelFormat } = labelConfig;

            d3.select("#legend").html("").style("padding", "");

            var translateSvgTop = 0;
            var translateSvgLeft = 0;

            [xAxisLabel, yAxisLabel] = data[1];

            if (!toolTip) {
                toolTip = {
                    textColumn1: xAxisLabel,
                    textColumn2: yAxisLabel
                };
            }

            if (window.innerWidth < 400) {
                legendPosition = "top";
            }

            // Adding Legend here
            d3.select("#legend").attr("style", null);
            legendGenerate(legendStatus, legendPosition, 0, width, margin, height, Object.keys(data[0]));

            // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
            var legendElement = document.querySelector("#legend");
            var legendWidth = (legendElement && legendElement.offsetWidth) || 0;
            var legendHeight = (legendElement && legendElement.offsetHeight) || 0;

            switch (legendPosition) {
                case "top":
                    height -= legendHeight;
                    translateSvgTop = legendHeight + 5;
                    break;
                case "bottom":
                    height -= legendHeight;
                    translateSvgTop = -(legendHeight + 5);
                    break;
                case "right":
                    width -= legendWidth;
                    translateSvgLeft = 0;
                    break;
                case "left":
                    width -= legendWidth;
                    translateSvgLeft = legendWidth;
            }

            // ******* Actual Radius Formula
            var radius = Math.min(width, height) / 2;
            radius = radius * 0.8;

            if (labelStatus && (legendPosition == "top" || legendPosition == "bottom")) {
                radius = Math.abs(radius - (Math.min(radius * 0.3), 57));
                if(radius < 25){
                    radius = 25;
                }
            } else if (labelStatus && (legendPosition == "right" || legendPosition == "left")) {
                radius = radius * 0.62;
                // radius = radius - translateSvgLeft / 2;
            }
            innerRadius = radius * innerRadius;

            d3.selectAll("#my_dataviz").html("");
            // append the svg object to the div called 'my_dataviz'
            var svg = d3
                .select("#my_dataviz")
                .append("svg")
                .attr("width", width + translateSvgLeft)
                .attr("height", height + translateSvgTop)
                .append("g")
                .attr(
                    "transform",
                    "translate(" + (width / 2 + translateSvgLeft) + "," + (height / 2 + translateSvgTop) + ")"
                );

            // set the color scale
            var color = d3.scaleOrdinal().domain(Object.keys(data[0])).range(d3Colors);
            var totalSum = arraySum(Object.values(data[0]));

            // Compute the position of each group on the pie:
            var pie = d3
                .pie()
                .value(function (d) {
                    return d.value;
                })
                .sort(function (a, b) {
                    return d3.ascending(a.key, b.key);
                }); // This make sure that group order remains the same in the pie chart

            var data_ready = pie(d3.entries(data[0]));

            // map to data
            var u = svg.selectAll("path").data(data_ready);
            var arcOver = d3.arc().innerRadius(innerRadius).outerRadius(radius);

            // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
            u.enter()
                .append("path")
                .merge(u)
                // .transition()
                // .duration(1000)
                .attr("d", d3.arc().innerRadius(innerRadius).outerRadius(radius))
                .attr("fill", function (d) {
                    this.setAttribute("data-label-name", d.data.key);
                    this.setAttribute("data-value", d.data.value);
                    this.setAttribute("data-percentage", ((d.data.value / totalSum) * 100).toFixed(2));

                    return color(d.data.key);
                })
                .attr("class", function (d, i) {
                    return "pie";
                })
                .attr("stroke", "white")
                .style("stroke-width", "0.2px")
                .style("opacity", 1)
                .on("mouseover mousemove", function (d, i) {
                    var x_pos = d3.mouse(this)[0] + width / 2 + 15;
                    var y_pos = d3.mouse(this)[1] + height / 2 + 8;
                    xValue = this.getAttribute("data-value");
                    percentageValue = this.getAttribute("data-percentage");

                    d3.select("#tooltip")
                        .style("left", x_pos + "px")
                        .style("top", y_pos + "px")
                        .style("display", "block")
                        // .text(d.data.key);
                        .html(function () {
                            // var textValue = d.y0 - d.y1;
                            // if (d.y1 < 0) {
                            //     textValue = d.y1 - d.y0;
                            // }

                            return (
                                "<div class='arrowTooltip'></div>" +
                                "<span style='color:grey;''>" +
                                toolTip.textColumn1 +
                                ":&nbsp;&nbsp;" +
                                "</span>" +
                                "<span style='float: right;'>" +
                                d.data.key +
                                "</span>" +
                                "<br/> <br/>" +
                                "<span style='color:grey;''>" +
                                toolTip.textColumn2 +
                                ":" +
                                "</span>" +
                                "<span style='float: right;margin-left: 15px;'>" +
                                xValue +
                                "<span>" +
                                " (" +
                                // (percentageValue &&
                                //     Math.round(+percentageValue)) +
                                percentageValue +
                                "%)" +
                                "</span>" +
                                "</span>"
                            );
                        });

                    d3.select(".arrowTooltip").attr(
                        "style",
                        "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                    );
                    // d3.selectAll(".pie").style("opacity", 0.3);
                    d3.select(this)
                        // .select("path")
                        .transition()
                        .duration(50)
                        .attr(
                            "d",
                            d3
                                .arc()
                                .innerRadius(innerRadius + 0)
                                .outerRadius(radius * 1.1)
                        );
                    d3.select(this).style("opacity", 1);
                })

                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");
                    d3.select(this)
                        // .select("path")
                        .transition()
                        .duration(200)
                        .attr("d", d3.arc().innerRadius(innerRadius).outerRadius(radius));

                    d3.selectAll(".pie").style("opacity", 1);
                });

            // remove the group that is not present anymore
            u.exit().remove();

            var data_ready = pie(d3.entries(data[0]));

            // The arc generator
            var arc = d3
                .arc()
                .innerRadius(radius * 0.5) // This is the size of the donut hole
                .outerRadius(radius * 0.8);

            // Another arc that won't be drawn. Just for labels positioning
            var outerArc = d3
                .arc()
                .innerRadius(radius * 1.1)
                .outerRadius(radius * 0.9);
            if (labelStatus) {
                // Add the polylines between chart and labels:
                percentageValuePrev = (data_ready[0].data.value / totalSum) * 100;
                data_ready[0].showLabel = false;
                for (var i = 0; i < data_ready.length; i++) {
                    percentageValueNext = (data_ready[i].data.value / totalSum) * 100;
                    if (percentageValueNext < 3 && percentageValuePrev < 3) {
                        data_ready[i].showLabel = false;
                    } else {
                        data_ready[i].showLabel = true;
                    }
                }
                svg.selectAll("allPolylines")
                    .data(data_ready)
                    .enter()
                    .append("polyline")
                    .attr("stroke", "#242B2E")
                    .style("fill", "none")
                    .attr("stroke-width", 1)
                    .attr("points", function (d) {
                        if (!d.showLabel) {
                            return [0, 0, 0];
                        }
                        var posA = outerArc.centroid(d); // line insertion in the slice
                        // posA[1]= outerArc.centroid(d)[1]-20;
                        // posA[0]= outerArc.centroid(d)[0];
                        // var abc = posA * 2;
                        var posB = outerArc.centroid(d); // line break: we use the other arc generator that has been built only for that
                        var posC = outerArc.centroid(d); // Label position = almost the same as posB
                        var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2; // we need the angle to see if the X position will be at the extreme right or extreme left
                        posC[0] = radius * 1.1 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left
                        return [posA, posB, posC];
                    });

                // Add the polylines between chart and labels:
                // Add the polylines between chart and labels:
                svg.selectAll("allLabels")
                    .data(data_ready)
                    .enter()
                    .append("text")
                    .attr("font-family", dataLabelfontFamily)
                    .attr("font-size", dataLabelfontSize)
                    .attr("fill", dataLabelColor)
                    .text(function (d) {
                        if (!d.showLabel) {
                            return "";
                        }
                        return (
                            labelFormatSet(d.data.value, labelFormat) +
                            " (" +
                            ((d.data.value / totalSum) * 100).toFixed(2) +
                            "%)"
                        );
                    })
                    .attr("transform", function (d) {
                        var pos = outerArc.centroid(d);
                        var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        pos[0] = radius * 1.1 * (midangle < Math.PI ? 1 : -1);
                        return "translate(" + pos + ")";
                    })
                    .style("text-anchor", function (d) {
                        var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                        return midangle < Math.PI ? "start" : "end";
                    });
            }
            var legendWidth = document.querySelector("#legend").offsetWidth;
            if (legendWidth <= window.innerWidth - 50) {
                console.log(window.innerWidth);
                console.log({ legendWidth });
                rightPosition = "calc(45vw - " + legendWidth / 2 + "px)";
            } else {
                rightPosition = 0;
            }
            if (legendPosition == "top" || legendPosition == "bottom") {
                d3.select("#legend").style("right", rightPosition);
            }
        }

        // Initialize the plot with the first dataset
        // drawChart(data, {});

        // var timer;
        // window.addEventListener("resize", function () {
        //     clearTimeout(timer);
        //     timer = setTimeout(function () {
        //         window.clearChart && clearChart();
        //         drawChart(window.data);
        //     }, 200);
        // });
        // console.log("Resize");
    </script>
</body>
