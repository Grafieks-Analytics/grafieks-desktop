<!DOCTYPE html>

<head>
    <meta charset="utf-8" />

    <!-- Load d3.js -->
    <script src="./Data/d3.v4.min.js"></script>

    <!-- Color scale -->
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>

    <script src="Data/d3-scale-chromatic.v1.min.js"></script>
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script> -->
    <script src="./Data/min/numeral.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <title>Pie Chart</title>
    <style>
        /* svg {
            -webkit-filter: drop-shadow(0px 3px 3px rgba(0, 0, 0, 0.3));
            filter: drop-shadow(0px 3px 3px rgba(0, 0, 0, 0.25));
        } */
    </style>
</head>
<body>
    <!-- Create a div where the graph will take place -->
    <div id="my_dataviz"></div>
    <div id="tooltip"></div>
    <div id="legend"></div>

    <script>
        // var data = { a: 9, b: 20, c: 30, d: 8, e: 12, g: 45 };

        // var data = {
        //     Accessories: 938,
        //     Appliances: 1060,
        //     Art: 2756,
        //     Binders: 2114,
        //     Bookcases: 8016,
        //     Chairs: 6906,
        //     Envelopes: 1134,
        //     Fasteners: 160,
        //     Furnishings: 2398,
        //     Labels: 192,
        //     Paper: 1198,
        //     Phones: 8372,
        //     Storage: 4638,
        //     Supplies: 132,
        //     Tables: 10230,
        // };

        var data = [
            {
                Accessories: 938,
                Appliances: 1060,
                Art: 2756,
                Binders: 2114,
                Bookcases: 8016,
                Chairs: 6906,
                Envelopes: 1134,
                Fasteners: 160,
                Furnishings: 2398,
                Labels: 192,
                Paper: 1198,
                Phones: 8372,
                Storage: 4638,
                Supplies: 132,
                Tables: 10230,
            },
            ["sub_category", "sales"],
        ];

        function transformData(dataValues, dateFormat) {
            var isKey1Date = false;

            if (isDateFormat(Object.keys(dataValues[0])[0])) {
                isKey1Date = true;
            }

            if (!isKey1Date) {
                return dataValues;
            }
            var json = {};
            var uniqueKey = [];
            Object.keys(dataValues[0]).forEach((d) => {
                var key = getDateFormattedData(d, dateFormat);
                if (!uniqueKey.includes(key)) {
                    uniqueKey.push(key);
                }

                if (!json[key]) {
                    json[key] = 0;
                }

                console.log(dataValues[0][d]);
                json[key] += dataValues[0][d];
            });

            var jsonKeys = Object.keys(json).filter((d) => {
                if (json[d] < 0) {
                    return false;
                }
                return true;
            });

            var finalJson = {};
            jsonKeys.forEach((d) => {
                finalJson[d] = json[d];
            });

            dataValues[0] = finalJson;

            return dataValues;
        }

        function drawChart(data, plottingConfiguration = {}) {
            let {
                d3colorPalette,
                paddingInner,
                legendConfig = defaultD3Config.defaultLegendConfig,
                labelConfig,
                innerRadius,
                toolTip,
                dataLabelfontSize = defaultD3Config.fontSize,
                dateFormat = defaultD3Config.dateFormat,

                dataLabelfontFamily = defaultD3Config.fontFamily,
                dataLabelColor = defaultD3Config.fontColor,
            } = plottingConfiguration;
            window.dataLabelfontSize = dataLabelfontSize;
            window.dataLabelfontFamily = dataLabelfontFamily;
            window.dataLabelfontSize = dataLabelfontSize;

            var data = transformData(data, dateFormat);

            if (!d3colorPalette) {
                d3colorPalette = defaultD3Config.d3ColorPalette;
            }
            if (!labelConfig) {
                labelConfig = defaultD3Config.defaultlabelConfig;
            }

            const d3Colors = d3colorPalette;
            // set the dimensions and margins of the graph
            var margin = { top: 30, right: 30, bottom: 70, left: 60 },
                width = window.innerWidth - margin.left - margin.right + 80,
                height = window.innerHeight - margin.top - margin.bottom - 20;

            if (!legendConfig) {
                legendConfig = { legendStatus: true };
            }

            if (!innerRadius) {
                innerRadius = defaultD3Config.innerRadius;
            }
            let { legendStatus, legendPosition } = legendConfig;
            let { labelStatus, labelFormat } = labelConfig;
            d3.select("#legend").html("").style("padding", "");

            var translateSvg = 0;
            var translateSvgTop = 100;
            var xAxisLabel = data[1][0];
            var yAxisLabel = data[1][1];
            if (!toolTip) {
                toolTip = {
                    textColumn1: xAxisLabel,
                    textColumn2: yAxisLabel,
                };
            }

            if (legendStatus) {
                // d3.select("#legend").html("");
                d3.select("#legend")
                    .append("p")
                    .html(xAxisLabel + "&nbsp;")
                    .style("font-weight", "bold")
                    .style("margin", "auto")
                    .style("position", "sticky");
                d3.select("#legend")
                    .selectAll("div")
                    .data(Object.keys(data[0]))
                    .enter()
                    .append("div")
                    .html((d, i) => {
                        return (
                            '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                            d3Colors[i % d3Colors.length] +
                            ';">  </div>' +
                            "<span style='margin-left: 5px; max-width: 80px'>" +
                            d +
                            "</span>"
                        );
                    })
                    .style("display", "flex")
                    .style("padding", "2px");
            }

            d3.select("#legend").attr("style", null);
            if (legendStatus) {
                var legendHeight =
                    document.querySelector("#legend").offsetHeight;
                var legendElement = document.querySelector("#legend");

                // topPosition = "calc(50vh - " + legendHeight + "px)";
                console.log({ legendHeight });
                console.log(window.innerHeight);

                if (legendHeight < window.innerHeight) {
                    console.log({ legendHeight });
                    topPosition = "calc(50vh - " + legendHeight / 2 + "px)";
                } else {
                    topPosition = 0;
                }

                legendElement.style.padding = "10px";

                switch (legendPosition) {
                    case "left":
                        // margin.left += 100;
                        // width -= 100;
                        translateSvg += 150;
                        d3.select("#legend")
                            .attr("style", null)
                            .style("top", topPosition)
                            .style("right", "auto")
                            // .style("bottom", "auto")
                            .style("left", "0px")
                            .style("display", "block")
                            .style("max-height", "100vh")
                            .style("overflow", "scroll")
                            .style("border", "none")
                            .style("position", "fixed");
                        d3.selectAll("#legend div span")
                            .style("max-width", "160px")
                            .style("white-space", "nowrap")
                            .style("overflow", "hidden")
                            .style("text-overflow", "ellipsis");
                        break;
                    case "top":
                        // margin.top += 80;
                        height -= 10;
                        translateSvgTop += 60;
                        d3.select("#legend")
                            .attr("style", null)
                            .style("top", "10px")
                            // .style("right", rightPosition)
                            .style("bottom", "auto")
                            .style("left", "auto")
                            .style("display", "flex")
                            .style("max-width", "99vw")
                            .style("overflow", "scroll");
                        d3.selectAll("#legend div span")
                            .style("max-width", "160px")
                            .style("white-space", "nowrap")
                            .style("overflow", "hidden")
                            .style("text-overflow", "ellipsis");
                        d3.selectAll("#legend div").style("padding", "2px 4px");
                        break;
                    case "bottom":
                        height -= 60;
                        // margin.bottom += 80;
                        d3.select("#legend")
                            .attr("style", null)
                            .style("top", "auto")
                            // .style("right", rightPosition)
                            .style("bottom", "0px")
                            .style("left", "auto")
                            .style("display", "flex")
                            .style("max-width", "99vw")
                            .style("overflow", "scroll");
                        d3.selectAll("#legend div span")
                            .style("max-width", "160px")
                            .style("white-space", "nowrap")
                            .style("overflow", "hidden")
                            .style("text-overflow", "ellipsis");
                        d3.selectAll("#legend div").style("padding", "2px 4px");

                        break;
                    // For Right Legened
                    case "right":
                    default:
                        width -= 100;
                        d3.select("#legend")
                            .attr("style", null)
                            .style("right", "20px")
                            .style("left", "auto")
                            .style("top", topPosition)
                            .style("bottom", "auto")
                            .style("display", "block")
                            .style("max-height", "100vh")
                            .style("overflow", "scroll")
                            .style("border", "none")
                            .style("position", "fixed");
                        d3.selectAll("#legend div span")
                            .style("max-width", "160px")
                            .style("white-space", "nowrap")
                            .style("overflow", "hidden")
                            .style("text-overflow", "ellipsis");
                }
            }

            // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
            // var radius = Math.min(width, height) / 2;
            var radius =(Math.min(width, height) / 2)-30;
            console.log({ radius });

            d3.selectAll("#my_dataviz").html("");
            // append the svg object to the div called 'my_dataviz'
            var svg = d3
                .select("#my_dataviz")
                .append("svg")
                .attr("width", width)
                .attr("height", height + 80)
                .append("g")
                .attr(
                    "transform",
                    "translate(" +
                        (width + translateSvg) / 2 +
                        "," +
                        (height + translateSvgTop) / 2 +
                        ")"
                );

            // set the color scale
            var color = d3
                .scaleOrdinal()
                .domain(Object.keys(data))
                .range(d3Colors);
            var totalSum = arraySum(Object.values(data[0]));

            // Compute the position of each group on the pie:
            var pie = d3
                .pie()
                .value(function (d) {
                    return d.value;
                })
                .sort(function (a, b) {
                    return d3.ascending(a.key, b.key);
                }); // This make sure that group order remains the same in the pie chart

            var data_ready = pie(d3.entries(data[0]));
            // console.log(data_ready);

            // map to data
            var u = svg.selectAll("path").data(data_ready);
            var arcOver = d3
                .arc()
                .innerRadius(0 + 5)
                .outerRadius(radius + 5);

            // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
            u.enter()
                .append("path")
                .merge(u)
                // .transition()
                // .duration(1000)
                .attr("d", d3.arc().innerRadius(0).outerRadius(radius))
                .attr("fill", function (d) {
                    this.setAttribute("data-label-name", d.data.key);
                    this.setAttribute("data-value", d.data.value);
                    this.setAttribute(
                        "data-percentage",
                        ((d.data.value / totalSum) * 100).toFixed(2)
                    );

                    return color(d.data.key);
                })
                .attr("class", function (d, i) {
                    return "pie";
                })
                .attr("stroke", "white")
                .style("stroke-width", "0.2px")
                .style("opacity", 1)
                .on("mouseover mousemove", function (d, i) {
                    var x_pos = d3.mouse(this)[0] + width / 2 + 15;
                    var y_pos = d3.mouse(this)[1] + height / 2 + 8;
                    xValue = this.getAttribute("data-value");
                    percentageValue = this.getAttribute("data-percentage");

                    d3.select("#tooltip")
                        .style("left", x_pos + "px")
                        .style("top", y_pos + "px")
                        .style("display", "block")
                        // .text(d.data.key);
                        .html(function () {
                            // var textValue = d.y0 - d.y1;
                            // if (d.y1 < 0) {
                            //     textValue = d.y1 - d.y0;
                            // }

                            return (
                                "<div class='arrowTooltip'></div>" +
                                "<span style='color:grey;''>" +
                                toolTip.textColumn1 +
                                ":&nbsp;&nbsp;" +
                                "</span>" +
                                "<span style='float: right;'>" +
                                d.data.key +
                                "</span>" +
                                "<br/> <br/>" +
                                "<span style='color:grey;''>" +
                                toolTip.textColumn2 +
                                ":" +
                                "</span>" +
                                "<span style='float: right;margin-left: 15px;'>" +
                                xValue +
                                "<span>" +
                                " (" +
                                // (percentageValue &&
                                //     Math.round(+percentageValue)) +
                                percentageValue +
                                "%)" +
                                "</span>" +
                                "</span>"
                            );
                        });

                    d3.select(".arrowTooltip").attr(
                        "style",
                        "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                    );
                    // d3.selectAll(".pie").style("opacity", 0.3);
                    d3.select(this)
                        // .select("path")
                        .transition()
                        .duration(50)
                        .attr(
                            "d",
                            d3
                                .arc()
                                .innerRadius(0)
                                .outerRadius(radius + 20)
                        );
                    d3.select(this).style("opacity", 1);
                })

                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");
                    d3.select(this)
                        // .select("path")
                        .transition()
                        .duration(200)
                        .attr("d", d3.arc().innerRadius(0).outerRadius(radius));

                    d3.selectAll(".pie").style("opacity", 1);
                });

            // remove the group that is not present anymore
            u.exit().remove();

            var data_ready = pie(d3.entries(data[0]));

            // The arc generator
            var arc = d3
                .arc()
                .innerRadius(radius * 0.5) // This is the size of the donut hole
                .outerRadius(radius * 0.8);

            // Another arc that won't be drawn. Just for labels positioning
            var outerArc = d3
                .arc()
                .innerRadius(radius * 1.1)
                .outerRadius(radius * 0.9);
            if (labelStatus) {
                // Add the polylines b etween chart and labels:
                percentageValuePrev =
                    (data_ready[0].data.value / totalSum) * 100;
                data_ready[0].showLabel = false;
                for (var i = 0; i < data_ready.length; i++) {
                    percentageValueNext =
                        (data_ready[i].data.value / totalSum) * 100;

                    if (percentageValueNext < 3 && percentageValuePrev < 3) {
                        data_ready[i].showLabel = false;
                    } else {
                        data_ready[i].showLabel = true;
                    }
                }
                svg.selectAll("allPolylines")
                    .data(data_ready)
                    .enter()
                    .append("polyline")
                    .attr("stroke", "#242B2E")
                    .style("fill", "none")
                    .attr("stroke-width", 1)
                    .attr("points", function (d) {
                        if (!d.showLabel) {
                            return [
                                [0, 0],
                                [0, 0],
                                [0, 0],
                            ];
                        }
                        var posA = outerArc.centroid(d); // line insertion in the slice
                        // posA[1]= outerArc.centroid(d)[1]-20;
                        // posA[0]= outerArc.centroid(d)[0];
                        // var abc = posA * 2;
                        console.log({ posA });
                        var posB = outerArc.centroid(d); // line break: we use the other arc generator that has been built only for that
                        var posC = outerArc.centroid(d); // Label position = almost the same as posB
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2; // we need the angle to see if the X position will be at the extreme right or extreme left
                        posC[0] = radius * 1.1 * (midangle < Math.PI ? 1 : -1); // multiply by 1 or -1 to put it on the right or on the left
                        return [posA, posB, posC];
                    });

                // Add the polylines between chart and labels:
                // Add the polylines between chart and labels:
                svg.selectAll("allLabels")
                    .data(data_ready)
                    .enter()
                    .append("text")
                    .attr("font-family", dataLabelfontFamily)
                    .attr("font-size", dataLabelfontSize)
                    .attr("fill", dataLabelColor)
                    .text(function (d) {
                        console.log(d.data.key);
                        if (!d.showLabel) {
                            return "";
                        }
                        return (
                            labelFormatSet(d.data.value, labelFormat) +
                            " (" +
                            ((d.data.value / totalSum) * 100).toFixed(2) +
                            "%)"
                        );
                    })
                    .attr("transform", function (d) {
                        var pos = outerArc.centroid(d);
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2;
                        pos[0] = radius * 1.12 * (midangle < Math.PI ? 1 : -1);
                        return "translate(" + pos + ")";
                    })
                    .style("text-anchor", function (d) {
                        var midangle =
                            d.startAngle + (d.endAngle - d.startAngle) / 2;
                        return midangle < Math.PI ? "start" : "end";
                    });
            }
            var legendWidth = document.querySelector("#legend").offsetWidth;
            console.log({ legendWidth });
            if (legendWidth <= window.innerWidth - 50) {
                console.log(window.innerWidth);
                console.log({ legendWidth });
                rightPosition = "calc(45vw - " + legendWidth / 2 + "px)";
            } else {
                rightPosition = 0;
            }
            if (legendPosition == "top" || legendPosition == "bottom") {
                d3.select("#legend").style("right", rightPosition);
            }
        }

        // Initialize the plot with the first dataset
        drawChart(data);
    </script>
</body>
