<html>
    <head>
        <style>
            body {
                font: 10px sans-serif;
            }
            .arc path {
                stroke: #fff;
            }
        </style>
        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <script src="Data/funnel.js"></script>

        <link rel="stylesheet" href="Data/general.css" />

        <title>Funnel Chart</title>
    </head>
    <body>
        <div
            id="my_dataviz"
            style="text-align: center; padding-top: 50px"
        ></div>
        <div id="tooltip"></div>
        <script>
            // Color Pallets - Set 3
            const d3colors = [
                "#8DD3C9",
                "#FFFFAA",
                "#B8BED6",
                "#F98171",
                "#78B5D1",
                "#FFB15B",
                "#B4E061",
                "#FDCDE5",
                "#DAD9D4",
                "#BD7FBE",
                "#CDE9C1",
                "#FFEA77",
            ];

            var data = [
                { sales_process: "Leads1", value: "70" },
                { sales_process: "Leads32", value: "175" },
                { sales_process: "Leads12", value: "105" },
                { sales_process: "Phone Calls", value: "61" },
                { sales_process: "Leads23", value: "135" },
                { sales_process: "Pitches", value: "46" },
                { sales_process: "Negotiations", value: "29" },
                { sales_process: "Final Closure", value: "15" },
            ];

            function drawChart(root, plottingConfiguration = {}) {
                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                } = plottingConfiguration;
                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3[d3colorPalette];

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                console.log();
                d3.selectAll("#my_dataviz").html("");
                (margin = { top: 30, right: 30, bottom: 70, left: 60 }),
                    (width =
                        window.innerWidth - margin.left - margin.right - 20),
                    (height =
                        window.innerHeight - margin.top - margin.bottom - 20);

                var width = 700,
                    height = 450,
                    radius = Math.min(width, height) / 2;

                console.log(d3colors);
                // var color = d3.scale.ordinal().range(d3colors);
                var color = d3.scaleOrdinal().range(d3Colors);

                var svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width)
                    .attr("height", height)
                    .append("g");
                var funnel = d3
                    .funnel()
                    .size([width, height])
                    .mouth([100, 100])
                    .value(function (d) {
                        return d.value;
                    });

                var line = d3
                    .line()
                    .x(function (d, i) {
                        return d.x;
                    })
                    .y(function (d, i) {
                        return d.y;
                    })
                    .curve(d3.curveLinear);

                var g = svg
                    .selectAll(".funnel-group")
                    .data(funnel(data))
                    .enter()
                    .append("g")
                    .attr("class", "funnel-group");

                g.append("path")
                    .attr("d", function (d) {
                        return line(d.coordinates);
                    })
                    .style("fill", function (d) {
                        return color(d.sales_process);
                    })
                    .attr("class", function (d, i) {
                        return "funnel";
                    })
                    .on("mousemove", function (d, i) {
                        var x_pos = d3.mouse(this)[0] + 300;
                        var y_pos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            .style("left", x_pos + "px")
                            .style("top", y_pos + "px")
                            .style("display", "block")
                            .style("z-index", 1000)
                            .style("postion", "absolute")
                            .html(
                                "Sales Process: " +
                                    d.sales_process +
                                    "<br/>Value: " +
                                    d.value
                            );
                        d3.selectAll(".funnel").style("opacity", 0.3);
                        d3.select(this).style("opacity", 1).attr("r", 10);
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.selectAll(".funnel").style("opacity", 1);
                    });

                g.append("text").attr({
                    y: function (d, i) {
                        if (d.coordinates.length === 4) {
                            return (
                                (d.coordinates[0].y - d.coordinates[1].y) / 2 +
                                d.coordinates[1].y +
                                5
                            );
                        } else {
                            return (
                                (d.coordinates[0].y + d.coordinates[1].y) / 2 +
                                10
                            );
                        }
                    },
                    x: function (d, i) {
                        return width / 2;
                    },
                });

                console.log(g);

                d3.select("body")
                    .append("table")
                    .attr({
                        id: "footer",
                        width: width + "px",
                    });
            }

            drawChart(data);
        </script>
    </body>
</html>
