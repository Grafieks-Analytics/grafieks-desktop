<html>
    <head>
        <style>
            body {
                font: 10px sans-serif;
            }
            .arc path {
                stroke: #fff;
            }
        </style>

        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <script src="./Data/min/numeral.min.js"></script>
        <script src="./Data/d3-funnel.min.js"></script>

        <style>
            #tooltip {
                font-size: 14px;
                font-family: Arial, Helvetica, sans-serif;
                min-width: fit-content;
                max-width: max-content;
                padding: 8px;
            }
        </style>
    </head>

    <body>
        <div id="my_dataviz" style="text-align: center; margin-top: 40px"></div>
        <div id="tooltip"></div>
        <div id="legend"></div>

        <script>
            var data = [
                [
                    {
                        key: "Bookcases",
                        value: 8016,
                    },
                    {
                        key: "Chairs",
                        value: 6906,
                    },
                    {
                        key: "Labels",
                        value: 192,
                    },
                    {
                        key: "Tables",
                        value: 10230,
                    },
                    {
                        key: "Storage",
                        value: 4638,
                    },
                    {
                        key: "Furnishings",
                        value: 2398,
                    },
                    {
                        key: "Art",
                        value: 2756,
                    },
                    {
                        key: "Phones",
                        value: 8372,
                    },
                    {
                        key: "Binders",
                        value: 2114,
                    },
                    {
                        key: "Appliances",
                        value: 1060,
                    },
                    {
                        key: "Paper",
                        value: 1198,
                    },
                    {
                        key: "Envelopes",
                        value: 1134,
                    },
                    {
                        key: "Accessories",
                        value: 938,
                    },
                    {
                        key: "Fasteners",
                        value: 160,
                    },
                    {
                        key: "Supplies",
                        value: 132,
                    },
                ],
                ["Sub_Category", "Sales"],
            ];

            var chart = new D3Funnel("#my_dataviz");

            function drawChart(data, plottingConfiguration = {}) {
                try {
                    window.data = data;
                    clearChart();
                    console.log(data);
                    var [data, label] = data;

                    data = sortArraysOfObjectByValue(data, "value");
                    data.forEach((d) => {
                        d.label = d.label || d.key;
                    });

                    let {
                        d3colorPalette = defaultD3Config.d3ColorPalette,
                        dynamicHeight = defaultD3Config.defaultDynamicHeight,
                        bottomPinch = defaultD3Config.defaultBottomPinch,
                        labelConfig = defaultD3Config.defaultlabelConfig,
                        legendConfig = defaultD3Config.defaultLegendConfig,
                        dataLabelfontSize = defaultD3Config.fontSize,
                        dataLabelfontFamily = defaultD3Config.fontFamily,
                        dataLabelColor = defaultD3Config.fontColor,
                    } = plottingConfiguration;
                    let { labelStatus, labelFormat } = labelConfig;
                    let { legendStatus, legendPosition } = legendConfig;
                    window.dataLabelfontSize = dataLabelfontSize;
                    window.dataLabelfontFamily = dataLabelfontFamily;
                    window.dataLabelColor = dataLabelColor;
                    d3Colors = d3colorPalette;
                    // documentation for options
                    // https://github.com/jakezatecky/d3-funnel/blob/master/README.md

                    var colorValues =
                        parseInt(data.length / d3colorPalette.length) + 1;

                    for (var i = 0; i < colorValues; i++) {
                        if (d3colorPalette.length < data.length) {
                            d3colorPalette.push(...d3colorPalette);
                        }
                    }

                    const options = {
                        block: {
                            dynamicHeight,
                            minHeight: 15,
                            fill: {
                                scale: d3colorPalette,
                            },
                        },
                        chart: {
                            bottomPinch: Math.min(bottomPinch, data.length),
                            curve: {
                                enabled: false,
                            },
                            width: window.innerWidth / 2,
                            height: window.innerHeight - 80,
                        },
                        tooltip: {
                            enabled: false,
                        },
                        label: {
                            enabled: labelStatus,
                            fill: dataLabelColor,
                            fontSize: dataLabelfontSize,
                            fontFamily: dataLabelfontFamily,
                        },
                    };

                    chart.draw(data, options);
                    //  const note = document.querySelector(".d3-funnel-tooltip");
                    // note.style.backgroundColor = "yellow";
                    // document.querySelector("d3-funnel-tooltip")
                    // legends code starts
                    d3.select("#legend").html("").style("padding", "");
                    if (legendStatus) {
                        d3.select("#legend").html("");

                        d3.select("#legend")
                            .append("p")
                            .html(label[0] + "&nbsp;")
                            .style("font-weight", "bold")
                            .style("margin", "auto")
                            .style("position", "sticky");

                        console.log(data);

                        d3.select("#legend")
                            .selectAll("div")
                            .data(data)
                            .enter()
                            .append("div")
                            .html((d, i) => {
                                return (
                                    '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                                    d3Colors[i % d3Colors.length] +
                                    // "red" +
                                    ';">  </div>' +
                                    "<span style='margin-left: 5px; max-width: 160px'>" +
                                    d.key +
                                    "</span>"
                                );
                            })
                            .style("display", "flex")
                            .style("padding", "2px");
                    }

                    // legends code ends

                    // legends height ,width elements
                    var legendElement = document.querySelector("#legend");
                    var legendHeight = legendElement.offsetHeight;
                    var legendWidth = legendElement.offsetWidth;

                    // const yAxisWidth =
                    //     document.querySelector("#yAxisDiv").clientWidth;

                    d3.select("#legend").attr("style", null);
                    d3.select("#mainChartWindow").attr("style", null);
                    d3.select("#xAxisLabelId").style("bottom", 20);

                    // legends code starts
                    if (legendStatus) {
                        if (
                            legendHeight <
                            document.querySelector("html").offsetHeight
                        ) {
                            topPosition =
                                "calc(50vh - " + legendHeight / 2 + "px)";
                        } else {
                            topPosition = 0;
                        }

                        rightPosition =
                            "calc(50vw - " + legendWidth / 2 + "px)";

                        //  var widthOld = (document.querySelector("#my_dataviz").clientWidth) ;
                        var widthOld =
                            document.querySelector("html").clientWidth - 72;
                        var heightOld =
                            document.querySelector("html").clientHeight;

                        // legendElement.style.padding = "10px";
                        legendElement.style.border = "1px solid black";
                        // d3.selectAll("#my_dataviz").style("margin-top", 0 + "px");

                        switch (legendPosition) {
                            case "left":
                                d3.select("#legend")
                                    .attr("style", null)
                                    .style("top", topPosition)
                                    .style("right", "auto")
                                    // .style("bottom", "auto")
                                    .style("left", "0px")
                                    // .style("right", "5px")
                                    .style("display", "block")
                                    .style("max-height", "100vh")
                                    // .style("overflow", "scroll")
                                    .style("border", "none")
                                    .style("position", "fixed");
                                d3.selectAll("#legend div span")
                                    .style("max-width", "160px")
                                    .style("white-space", "nowrap")
                                    .style("overflow", "hidden")
                                    .style("text-overflow", "ellipsis");

                                var legendWidth = legendElement.offsetWidth;
                                // margin.left += 100;
                                // width -= 100;
                                // d3.select("#my_dataviz svg").attr("width", width + margin.left + margin.right);

                                // d3.select("#mainChartWindow").attr("style", null);

                                // d3.select("#mainChartWindow").style(
                                //     "width",
                                //     widthOld - legendWidth + yAxisWidth
                                // );
                                // d3.select("#mainChartWindow").style(
                                //     "margin-left",
                                //     legendWidth + "px"
                                // );
                                // d3.select("#xAxisLabelId").style(
                                //     "bottom",
                                //     10 + "px"
                                // );
                                // d3.selectAll("#my_dataviz").style(
                                //     "height",
                                //     "calc(100vh)"
                                // );

                                break;
                            case "top":
                                // d3.select("#mainChartWindow").attr("style", null);
                                // margin.top += 50;
                                // height -= 50;
                                y_pos_x_label = 57;
                                // console.log({rightPosition});
                                d3.select("#legend")
                                    .attr("style", null)
                                    .style("top", "10px")
                                    .style("right", rightPosition)
                                    .style("bottom", "auto")
                                    .style("position", "absolute")
                                    .style("left", "auto")
                                    .style("display", "flex")
                                    .style("max-width", "99vw")
                                    // .style("overflow", "scroll")
                                    .style("border", "none");
                                d3.selectAll("#legend div span")
                                    .style("max-width", "160px")
                                    .style("white-space", "nowrap")
                                    .style("overflow", "hidden")
                                    .style("text-overflow", "ellipsis");
                                // d3.select("#xAxisLabelId").style(
                                //     "bottom",
                                //     10 + "px"
                                // );
                                // d3.selectAll("#my_dataviz").style(
                                //     "height",
                                //     "calc(100vh - 72px) "
                                // );
                                // d3.selectAll("#my_dataviz").style(
                                //     "margin-top",
                                //     50 + "px"
                                // );

                                // d3.selectAll("#legend div").style(
                                //     "padding",
                                //     "2px 4px"
                                // );
                                break;
                            case "bottom":
                                // height -= 50; // use legend client height
                                // margin.bottom += 10;
                                var legendWidth = legendElement.offsetWidth;
                                y_pos_x_label = 20;

                                // d3.select("#xAxisLabelId").style("bottom", "60px");
                                // d3.select("#mainChartWindow").attr("style", null);

                                // d3.select("#mainChartWindow").style("width", width);
                                //  d3.select("#mainChartWindow").style("height",heightOld-80 );
                                // d3.select("#mainChartWindow").style(
                                //     "margin-left",
                                //     0
                                // );
                                d3.select("#legend")
                                    .attr("style", null)
                                    .style("top", "auto")
                                    .style("right", rightPosition)
                                    .style("bottom", "0px")
                                    // .style("left", margin.left + "px")
                                    .style("display", "flex")
                                    .style("max-width", "99vw")
                                    // .style("overflow", "scroll")
                                    .style("border", "none");

                                d3.selectAll("#legend div span")
                                    .style("max-width", "160px")
                                    .style("white-space", "nowrap")
                                    .style("overflow", "hidden")
                                    .style("text-overflow", "ellipsis");
                                // d3.selectAll("#my_dataviz").style(
                                //     "height",
                                //     "calc(100vh - 42px)"
                                // );

                                break;
                            // For Right Legened
                            case "right":
                            default:
                                // width -= 220;
                                // d3.select("#my_dataviz").style("width", width + margin.left + margin.right);
                                var legendWidth = legendElement.offsetWidth;

                                d3.select("#legend")
                                    .attr("style", null)
                                    .style("right", "0px")
                                    .style("left", "auto")
                                    .style("position", "fixed")
                                    .style("top", topPosition)
                                    .style("max-height", "100vh")
                                    // .style("overflow", "scroll")
                                    .style("border", "none")
                                    .style("bottom", "auto")
                                    .style("display", "block");
                                d3.selectAll("#legend div span")
                                    .style("max-width", "160px")
                                    .style("white-space", "nowrap")
                                    .style("overflow", "hidden")
                                    .style("text-overflow", "ellipsis");

                            // d3.select("#mainChartWindow").attr("style", null);
                            // d3.select("#mainChartWindow").style(
                            //     "width",
                            //     widthOld - legendWidth  - 10 + "px"
                            // );
                            // d3.select("#mainChartWindow").style(
                            //     "margin-left",
                            //     0
                            // );
                            // d3.select("#xAxisLabelId").style(
                            //     "bottom",
                            //     10 + "px"
                            // );
                            // d3.selectAll("#my_dataviz").style(
                            //     "height",
                            //     "calc(100vh)"
                            // );
                        }
                    }

                    // if (legendPosition == "left" || legendPosition == "right") {
                    //     var legendWidth = legendElement.offsetWidth;
                    //     width -= legendWidth;
                    // }

                    // legends code ends

                    var funnelSvg = document.querySelectorAll("svg g");
                    funnelSvg.forEach((e) => {
                        e.addEventListener("mouseout", (event) => {
                            d3.select("#tooltip").style("display", "none");
                            // .html("");
                        });
                        e.addEventListener("mousemove", (event) => {
                            // console.log(event.target);
                            // console.log(
                            //     e.querySelector("text tspan").innerHTML
                            // );
                            var value = e.querySelector("text tspan").innerHTML;
                            var valueTooltip = value.split(":");

                            // console.log(event.clientX);
                            d3.select("#tooltip")
                                .style("position", "absolute")
                                .style("left", event.clientX + 20 + "px")
                                .style("top", event.clientY - 30 + "px")
                                .style("display", "block")
                                .style("pointer-events", "none")
                                .style("background-color", "white")
                                .html(function () {
                                    return (
                                        "<div class='arrowTooltip'></div>" +
                                        "<span style='color:grey;''>" +
                                        label[0] +
                                        ":&nbsp;&nbsp;" +
                                        "</span>" +
                                        "<span style='float: right;'>" +
                                        valueTooltip[0] +
                                        "</span>" +
                                        "<br/> <br/>" +
                                        "<span style='color:grey;''>" +
                                        label[1] +
                                        ":" +
                                        "</span>" +
                                        "<span style='float: right;margin-left: 15px;'>" +
                                        valueTooltip[1] +
                                        "</span>"
                                    );
                                });
                            d3.select(".arrowTooltip").attr(
                                "style",
                                "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                            );
                        });
                    });

                    // abg.forEach((e) => {
                    //     e.addEventListener("mouseover", (event) => {
                    //         console.log(e.querySelector("text"));
                    //         console.log(event);
                    //     });
                    // });
                } catch (error) {
                    console.log(error);
                }
            }

            // drawChart(data);
        </script>
    </body>
</html>
