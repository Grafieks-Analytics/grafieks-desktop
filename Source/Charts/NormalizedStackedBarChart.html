<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Load d3.js -->

    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <title>100% Stacked Bar</title>
</head>
<body>
    <div id="my_dataviz"></div>
    <div id="tooltip"></div>

    <script>
        // Color Pallets - Set 3
        const d3colors = [
            "#8DD3C9",
            "#FFFFAA",
            "#B8BED6",
            "#F98171",
            "#78B5D1",
            "#FFB15B",
            "#B4E061",
            "#FDCDE5",
            "#DAD9D4",
            "#BD7FBE",
            "#CDE9C1",
            "#FFEA77",
        ];

        var data = [
            {
                name: "Active",
                totalHours: 180,
                leftHours: 25,
            },
            {
                name: "Cancel",
                totalHours: 150,
                leftHours: 42,
            },
            {
                name: "Arrive",
                totalHours: 250,
                leftHours: 120,
                test: 100,
            },
            {
                name: "Contract",
                totalHours: 300,
                leftHours: 120,
            },
        ];

        // var data = [
        //     [
        //         ["Active", 180, 25],
        //         ["Cancel", 150, 42],
        //         ["Arrive", 250, 120],
        //         ["Contract", 300, 120],
        //     ],
        //     ["Name", "Total Hours", "Left Hours"],
        // ];

        function drawChart(data, plottingConfiguration = {}) {
            window.data = data;
            var dataValues = data[0];

            let {
                d3colorPalette,
                paddingInner,
                markerShape,
                curveType,
                timeParseFormat,
                dateFormat,
            } = plottingConfiguration;
            if (!d3colorPalette) {
                d3colorPalette = defaultD3Config.d3ColorPalette;
            }
            d3Colors = d3colorPalette;

            if (!paddingInner) {
                paddingInner = defaultD3Config.defaultPaddingInner;
            }

            if (!timeParseFormat) {
                timeParseFormat = defaultD3Config.defaultTimeParseFormat;
            }

            if (!dateFormat) {
                dateFormat = defaultD3Config.dateFormat;
            }

            d3.selectAll("#my_dataviz").html("");
            let margin = { top: 30, right: 140, bottom: 70, left: 50 },
                width = window.innerWidth - margin.left - margin.right - 20,
                height = window.innerHeight - margin.top - margin.bottom - 20;

            yaxisTicks = height / 100;

            var svg = d3
                .select("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            g = svg
                .append("g")
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            var x = d3
                .scaleBand()
                .rangeRound([0, width])
                .paddingInner(0.1)
                .align(0.2);

            var y = d3.scaleLinear().range([height, 0]);

            var z = d3.scaleOrdinal().range(d3Colors);

            var stack = d3
                .stack()
                .order(d3.stackOrderNone)
                .offset(d3.stackOffsetExpand);

            // data = data[0];
            data.forEach(function (d) {
                d.satisfied = d.totalHours - d.leftHours;
            });
            data.sort(function (a, b) {
                return b.totalHours - a.totalHours;
            });

            x.domain(
                data.map(function (d) {
                    return d.name;
                })
            );
            z.domain(["leftHours", "satisfied"]);
            g.append("g")
                .attr("class", "axis axis--x x-axis")
                .attr("transform", "translate(0," + height + ")")
                .call(d3.axisBottom(x).tickSizeOuter(0));

            g.append("g")
                .attr("class", "axis axis--y y-axis")
                .call(d3.axisLeft(y).ticks(10, "%").tickSizeOuter(0));

            g.append("g")
                .attr("class", "grid")
                .style("stroke-width", "1")
                .call(make_y_gridlines().tickSize(-width).tickFormat(""));

            var serie = g
                .selectAll(".serie")
                .data(stack.keys(["leftHours", "satisfied"])(data))
                .enter()
                .append("g")
                .attr("class", "serie")
                .attr("fill", function (d) {
                    return z(d.key);
                });

            serie
                .selectAll("rect")
                .data(function (d) {
                    return d;
                })
                .enter()
                .append("rect")
                .attr("x", function (d) {
                    return x(d.data.name);
                })
                .attr("y", function (d) {
                    return y(d[1]);
                })
                .attr("height", function (d) {
                    return y(d[0]) - y(d[1]);
                })
                .attr("class", "bar")
                .attr("width", x.bandwidth())
                .on("mouseover mousemove", function (d, i) {
                    var x_pos = d3.mouse(this)[0] + margin.left;
                    var y_pos = d3.mouse(this)[1] - margin.bottom;

                    d3.select("#tooltip")
                        .style("left", x_pos + "px")
                        .style("top", y_pos + "px")
                        .style("display", "block")
                        .html(
                            "Total Hours:" +
                                d.data.totalHours +
                                "<br/>Left Hours: " +
                                d.data.leftHours +
                                "<br/>Satisfied Hours: " +
                                d.data.satisfied
                        );
                    d3.selectAll(".bar").style("opacity", 0.3);
                    d3.select(this).style("opacity", 1);
                })
                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");
                    d3.selectAll(".bar").style("opacity", 1);
                });

            var legend = serie
                .append("g")
                .attr("class", "legend")
                .attr("transform", function (d) {
                    var d = d[d.length - 1];
                    return (
                        "translate(" +
                        (x(d.data.name) + x.bandwidth()) +
                        "," +
                        (y(d[0]) + y(d[1])) / 2 +
                        ")"
                    );
                });

            legend
                .append("line")
                .attr("x1", -6)
                .attr("x2", 6)
                .attr("stroke", "#000");

            legend
                .append("text")
                .attr("x", 9)
                .attr("dy", "0.35em")
                .attr("fill", "#000")
                .style("font", "10px sans-serif")
                .text(function (d) {
                    return d.key;
                });

            // Generate Grid starts

            function make_x_gridlines() {
                return d3.axisBottom(x).ticks(8);
            }
            function make_y_gridlines() {
                return d3.axisLeft(y).ticks(5);
            }
        }

        // drawChart(data);

        // Generate Grid ends
    </script>
</body>
