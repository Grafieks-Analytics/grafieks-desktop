<!DOCTYPE html>
<meta charset="utf-8" />

<head>
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />
    <style>
        body {
            overflow-y: hidden;
            /* overflow-x: hidden; */
        }

        .title {
            font: 15px sans-serif;
        }

        .legend {
            font: 10px sans-serif;
        }

        .axis path,
        .axis line {
            fill: none;
            shape-rendering: crispEdges;
            stroke-width: 1px;
        }

        .x.axis.path {
            display: none;
        }

        .line {
            fill: none;
            /* stroke: black; */
            stroke-width: 1.2px;
        }

        #tooltip {
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;
        }

        #legend {
            font-size: 14px;
            font-family: Arial, Helvetica, sans-serif;

            background-color: #fff;
            position: absolute;
            border: 1px solid #cccccc;
        }

        #tooltip:before {
            border: solid;
            border-color: white transparent;
            border-width: 12px 6px 0 6px;
            content: "";
            left: -12px;
            transform: rotate(90deg) !important;

            bottom: 22px;
            position: absolute;
        }
    </style>
</head>

<body>
    <div style="display: flex">
        <div id="yAxisDiv"></div>
        <div id="my_dataviz"></div>
    </div>
    <div id="tooltip"></div>
    <div id="legend"></div>

    <script>
        var extraHeightWorked = false;
        var redrawn = false;
        var extraHeight = 0;

        function transformData(dataValue, dateFormat, dateFormat1) {
            json = {};
            var isKey1Date = false;
            var isKey2Date = false;

            if (isDateFormat(dataValue[0][1])) {
                isKey1Date = true;
            }
            if (isDateFormat(dataValue[0][0])) {
                isKey2Date = true;
            }

            var uniqueKey2 = [];
            dataValue.forEach((d) => {
                if (isKey1Date) {
                    var key = getDateFormattedData(d[1], dateFormat);
                } else {
                    var key = d[1];
                }

                if (!json[key]) {
                    json[key] = {};
                }
                if (isKey2Date) {
                    var key2 = getDateFormattedData(d[0], dateFormat1);
                } else {
                    var key2 = d[0];
                }
                if (!uniqueKey2.includes(key2)) {
                    uniqueKey2.push(key2);
                }

                var value = d[2];

                if (!json[key][key2]) {
                    json[key][key2] = 0;
                }

                json[key][key2] += +value;
            });

            var response = [];
            var allKeys = uniqueKey2;

            var sortedKeys = sortDates(json, dateFormat);
            const response1 = sortedKeys.map((d) => {
                return { ...json[d], key: d };
            });
            console.log({ response1 });

            for (var key in json) {
                if (Object.keys(json[key]).length < allKeys.length) {
                    allKeys.forEach((d) => {
                        if (!json[key][d]) {
                            json[key][d] = 0;
                        }
                    });
                }
                response.push({ ...json[key], key });
            }

            return [response, allKeys, data[2]];
        }

        function drawChart(data, plottingConfiguration = {}) {
            if (!redrawn) {
                extraHeight = 0;
            }
            window.data = data;

            var timeFormat = d3.timeFormat("%m-%Y");
            var parseDate = d3.timeParse("%Y");
            var tooltipColumn1 = "test1";
            var tooltipColumn2 = "test2";

            let {
                d3colorPalette,
                paddingInner,
                markerShape,
                curveType,
                dateFormat,
                dateFormat1,
                chartType,
                toolTip,
                legendConfig,
                standardThresholdWidth,
            } = plottingConfiguration;

            if (!d3colorPalette) {
                d3colorPalette = defaultD3Config.d3ColorPalette;
            }
            d3Colors = d3colorPalette;

            if (!paddingInner) {
                paddingInner = defaultD3Config.defaultPaddingInner;
            }

            if (!dateFormat) {
                dateFormat = defaultD3Config.dateFormat;
            }

            if (!dateFormat1) {
                dateFormat1 = defaultD3Config.dateFormat;
            }

            if (!chartType) {
                chartType = defaultD3Config.chartType;
            }

            if (!standardThresholdWidth) {
                standardThresholdWidth = defaultD3Config.standardThresholdWidth;
            }

            let { top, right, bottom, left } = constants.chartMargins;
            if (window.innerHeight < 400) {
                top = top / 2;
                right = right / 2;
                // bottom = bottom / 2;
            }
            var margin = { top, right, bottom, left };
            var width = window.innerWidth - margin.left - margin.right - 50;

            var [data, keys, labels] = transformData(
                data[0],
                dateFormat,
                dateFormat1
            );

            if (!legendConfig) {
                legendConfig = { legendStatus: false };
            }

            let { legendStatus, legendPosition } = legendConfig;

            if (legendStatus) {
                var legendHeight =
                    document.querySelector("#legend").offsetHeight;
                var legendElement = document.querySelector("#legend");

                topPosition = "calc(50vh - " + legendHeight + "px)";
                legendElement.style.padding = "10px";

                switch (legendPosition) {
                    case "left":
                        margin.left += 80;
                        width -= 50;
                        d3.select("#legend")
                            .style("top", topPosition)
                            .style("right", "auto")
                            .style("bottom", "auto")
                            .style("left", "20px")
                            .style("display", "block");
                        break;
                    case "top":
                        margin.top += 10;
                        height -= 100;
                        d3.select("#legend")
                            .style("top", "20px")
                            .style("right", "auto")
                            .style("bottom", "auto")
                            .style("left", "35%")
                            .style("display", "flex");
                        d3.selectAll("#legend div").style("padding", "2px 4px");
                        break;
                    case "bottom":
                        height -= 80;
                        margin.bottom += 30;
                        d3.select("#legend")
                            .style("top", "auto")
                            .style("right", "auto")
                            .style("bottom", "40px")
                            .style("left", "35%")
                            .style("display", "flex");
                        break;
                    // For Right Legened
                    case "right":
                    default:
                        width -= 50;
                        d3.select("#legend")
                            .style("right", "20px")
                            .style("left", "auto")
                            .style("top", topPosition)
                            .style("bottom", "auto")
                            .style("display", "block");
                }
            }

            d3.select("#legend").html("").style("padding", "");

            if (legendStatus) {
                d3.select("#legend").html("");
                d3.select("#legend")
                    .selectAll("div")
                    .data(keys)
                    .enter()
                    .append("div")
                    .html((d, i) => {
                        return (
                            '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                            d3Colors[i] +
                            ';">  </div>' +
                            "<span style='margin-left: 5px; max-width: 80px'>" +
                            d +
                            "</span>"
                        );
                    })
                    .style("display", "flex")
                    .style("padding", "5px");
            }

            if (!toolTip) {
                toolTip = {
                    textColumn1: labels[0],
                    textColumn2: labels[1],
                };
            }

            if (chartType == constants.chartType.STANDARD) {
                width = data.length * standardThresholdWidth;
            }

            var height =
                window.innerHeight - margin.top - margin.bottom - extraHeight;
            yaxisTicks = height / 70;

            var x = d3
                .scaleBand()
                .range([0, width])
                .domain(
                    data.map((d) => {
                        return d.key;
                    })
                )
                .padding(paddingInner)
                .paddingInner(paddingInner);

            var y = d3.scaleLinear().range([height, margin.top]);
            var center = d3.scaleLinear().range([0, width]);
            var color = d3.scaleOrdinal().range(d3Colors);

            var xAxis = d3.axisBottom(x);
            var yAxis = d3.axisLeft(y).ticks(yaxisTicks);

            var centerLine = d3.axisTop(center).ticks(0);

            data.forEach(function (d) {
                var y0_positive = 0;
                var y0_negative = 0;

                d.components = keys.map(function (key) {
                    if (d[key] >= 0) {
                        return {
                            key,
                            y1: y0_positive,
                            y0: (y0_positive += d[key]),
                        };
                    } else if (d[key] < 0) {
                        return {
                            key,
                            y0: y0_negative,
                            y1: (y0_negative += d[key]),
                        };
                    }
                });
            });

            var y_min = d3.min(data, function (d) {
                return d3.min(
                    d.components.map((d1) => {
                        return d1.y1;
                    })
                );
            });

            var y_max = d3.max(data, function (d) {
                return d3.max(
                    d.components.map((d1) => {
                        return d1.y0;
                    })
                );
            });

            if (y_min > 0) {
                y_min = 0;
            }

            y.domain([y_min, y_max]).nice();
            color.domain(keys);
            const barWidth = x.bandwidth();

            clearChart();

            //add svg with margin !important
            //this is svg is actually group
            var svg = d3
                .selectAll("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr(
                    "height",
                    height + extraHeight + margin.top + margin.bottom
                )
                .append("g")
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            svg.append("g")
                .attr("class", "x-axis axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis.tickSize(0));

            d3.select("#yAxisDiv")
                .append("svg")
                .attr("width", "72")
                .attr("height", height + margin.top + margin.bottom)
                .append("g") //add group to leave margin for axis
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                )
                .append("g")
                .attr("class", "y-axis")
                .call(yAxis.tickSize(-width));

            svg.append("g")
                .attr("class", "y axis grid")
                .call(yAxis.tickSize(-width));

            svg.append("g")
                .attr("class", "centerline")
                .attr("transform", "translate(0," + y(0) + ")")
                .call(centerLine.tickSize(0));

            var entry = svg
                .selectAll(".entry")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "g")
                .attr("transform", function (d) {
                    return "translate(" + x(d.key) + ", 0)";
                });

            entry
                .selectAll("rect")
                .data(function (d) {
                    return d.components;
                })
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("width", x.bandwidth())
                .attr("y", function (d) {
                    return y(d.y0);
                })
                .attr("height", function (d) {
                    return Math.abs(y(d.y0) - y(d.y1));
                })
                .style("fill", function (d) {
                    return color(d.key);
                })
                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");
                    d3.selectAll(".bar").style("opacity", 1);
                })
                .on("mouseover mousemove", function (d, i) {
                    let xpos1 = d3.mouse(this)[0] + margin.left;

                    var parentElement = this.parentElement;

                    const matrix =
                        window.getComputedStyle(parentElement).transform;

                    const matrixValues = matrix
                        .match(/matrix.*\((.+)\)/)[1]
                        .split(", ");

                    xpos1 += +matrixValues[4] || 0;

                    let ypos = d3.mouse(this)[1] - 20;

                    d3.select("#tooltip")
                        .style("left", xpos1 + "px")
                        .style("top", ypos + "px")
                        .style("display", "block")
                        .style("position", "absolute")
                        .html(function () {
                            var textValue = d.y0 - d.y1;
                            if (d.y1 < 0) {
                                textValue = d.y1 - d.y0;
                            }

                            return (
                                "<span style='color:grey;''>" +
                                toolTip.textColumn1 +
                                ":" +
                                "</span>" +
                                "<span style='float: right;'>" +
                                d.key +
                                "</span>" +
                                "<br/> <br/>" +
                                "<span style='color:grey;''>" +
                                toolTip.textColumn2 +
                                ":" +
                                "</span>" +
                                "<span style='float: right;margin-left: 15px;'>" +
                                textValue.toFixed(3) +
                                "</span>"
                            );
                        });

                    d3.selectAll(".bar").style("opacity", 0.3);
                    d3.select(this).style("opacity", 1);
                });

            setYaxisWidth();

            if (chartType == constants.chartType.FIT_WIDTH && barWidth < 40) {
                setXaxisWidth();
            }

            if (chartType == constants.chartType.STANDARD) {
                setStandardTickWidths();
            }

            function setStandardTickWidths() {
                var a = document.querySelectorAll(".x-axis .tick text");

                for (var i = 0; i < a.length; i++) {
                    var singleCharacterLength =
                        a[i].getBBox().width / a[i].innerHTML.length;
                    var numOfCharacters = Math.floor(
                        barWidth / singleCharacterLength
                    );

                    var tick = a[i];

                    var tickWidth = tick && tick.getBBox().width;
                    if (tickWidth > barWidth) {
                        var tickValue = tick.innerHTML;
                        tickValue =
                            tickValue &&
                            tickValue.substr(0, numOfCharacters - 3) + "...";
                        tick.innerHTML = tickValue;
                    }
                }
            }

            function setXaxisWidth() {
                var allYAxisTicks =
                    document.querySelectorAll(".x-axis .tick text");
                var maxWidth = 0;
                for (var i = 0; i < allYAxisTicks.length; i++) {
                    var tick = allYAxisTicks[i];
                    var width = tick.getBBox().width;
                    if (width > maxWidth) {
                        maxWidth = width;
                    }
                }

                extraHeightWorked = true;
                maxWidth = maxWidth < 100 ? maxWidth : 100;
                extraHeight = maxWidth;

                d3.select(".x-axis").attr("text-anchor", "right");

                d3.selectAll(".x-axis text")
                    .attr("transform", "rotate(-90)")
                    .attr("dy", "0.3em")
                    .attr("x", "-" + (maxWidth + 3))
                    .attr("y", "0");
            }

            function make_x_gridlines(x) {
                return d3.axisBottom(x).ticks(yaxisTicks);
            }
            function make_y_gridlines(y) {
                return d3.axisLeft(y).ticks(yaxisTicks);
            }

            function getLeftAxisDistance() {
                var a = document
                    .querySelector(".tick")
                    .getAttribute("transform");
                a = a.replace("translate(", "");
                return a.substr(0, a.indexOf(","));
            }

            allXAxisTexts = document.querySelectorAll(".x-axis text");
            var textWidth = document
                .querySelector(".x-axis .tick text")
                .getBBox().height;

            if (
                chartType == constants.chartType.FIT_WIDTH &&
                x.bandwidth() < 40
            ) {
                for (var i = 0; i < allXAxisTexts.length; i++) {
                    if (!Math.floor(data.length * 0.02)) {
                        break;
                    }
                    if (i % Math.floor(data.length * 0.02) != 0) {
                        allXAxisTexts[i].remove();
                        continue;
                    }

                    if (allXAxisTexts[i] && allXAxisTexts[i].innerHTML) {
                        var singleCharacterLength =
                            allXAxisTexts[i].getBBox().width /
                            allXAxisTexts[i].innerHTML.length;

                        var numOfCharacters =
                            extraHeight / singleCharacterLength;

                        if (
                            allXAxisTexts[i].innerHTML &&
                            allXAxisTexts[i].innerHTML.length > numOfCharacters
                        ) {
                            if (Math.floor(numOfCharacters) > 3) {
                                allXAxisTexts[i].innerHTML =
                                    (allXAxisTexts[i].innerHTML &&
                                        allXAxisTexts[i].innerHTML.substr(
                                            0,
                                            numOfCharacters - 3
                                        )) + "...";
                            } else {
                                allXAxisTexts[i].innerHTML =
                                    (allXAxisTexts[i].innerHTML &&
                                        allXAxisTexts[i].innerHTML.substr(
                                            0,
                                            2
                                        )) + "...";
                            }
                        }
                    }

                    if (i == 0 && barWidth < textWidth * 0.5) {
                        allXAxisTexts[i].setAttribute("dy", "1em");
                        continue;
                    }
                    if (barWidth < textWidth * 0.5) {
                        allXAxisTexts[i].setAttribute("dy", "0.8em");
                    }
                }
            }

            if (extraHeightWorked && !redrawn) {
                extraHeightWorked = false;
                redrawn = true;
                drawChart(window.data, plottingConfiguration);
                var mainChart = document.querySelector("#my_dataviz svg");
                var heightValue = mainChart.getAttribute("height");
                heightValue = +heightValue + extraHeight;
                mainChart.setAttribute("height", heightValue);
            }

            if (extraHeightWorked && redrawn) {
                extraHeightWorked = false;
                redrawn = false;
            }

            setXAxisTicksDistance();
            function setYaxisWidth() {
                var allYAxisTicks = document.querySelectorAll(".y-axis .tick");
                var maxWidth = 72;
                for (var i = 0; i < allYAxisTicks.length; i++) {
                    var tick = allYAxisTicks[i];
                    var width = tick.getBBox().width + 25;
                    if (width > maxWidth) {
                        maxWidth = width;
                    }
                }

                var yAxisDiv = document.querySelector("#yAxisDiv svg");

                yAxisDiv.setAttribute("width", maxWidth);
                yAxisDiv.setAttribute(
                    "transform",
                    "translate(" + (maxWidth - margin.left) + "," + 0 + ")"
                );
            }

            function getDateFormattedData(dateValue, dateFormat) {
                return d3.timeFormat(dateFormat)(new Date(dateValue));
            }
        }
        // var data = [
        //     [
        //         ["Furniture", "Furniture", 27550],
        //         ["Furniture", "OfficeSupplies", 0],
        //         ["Furniture", "Technology", 0],
        //         ["OfficeSupplies", "Furniture", 0],
        //         ["OfficeSupplies", "OfficeSupplies", 13384],
        //         ["OfficeSupplies", "Technology", 0],
        //         ["Technology", "Furniture", 0],
        //         ["Technology", "Office Supplies", 0],
        //         ["Technology", "Technology", 9310],
        //     ],
        //     ["Furniture", "OfficeSupplies", "Technology"],
        //     ["Category", "Sales"],
        // ];
        // drawChart(data);
    </script>
</body>
