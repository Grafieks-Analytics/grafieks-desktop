<!DOCTYPE html>
<meta charset="utf-8" />

<head>
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />
    <style>
        .title {
            font: 15px sans-serif;
        }

        .legend {
            font: 10px sans-serif;
        }
        .axis path,
        .axis line {
            fill: none;
            shape-rendering: crispEdges;
            stroke-width: 1px;
        }

        .x.axis.path {
            display: none;
        }

        .line {
            fill: none;
            /* stroke: black; */
            stroke-width: 1.2px;
        }
    </style>
</head>
<body>
    <div style="display: flex">
        <div id="yAxisDiv"></div>
        <div id="my_dataviz"></div>
    </div>
    <div id="tooltip"></div>

    <script>
        var data = [
            [
                ["2018-08-05", "2018-08-05", "139.81"],
                ["2018-08-05", "2019-08-05", "100.81"],
                ["2018-08-05", "2019-08-05", "136.35"],
                ["2018-08-05", "2019-08-05", "143.22"],
                ["2012-08-05", "2019-08-05", "0"],
                ["2013-08-05", "2018-08-05", "241.64"],
                ["2014-08-05", "2019-08-05", "48.43"],
                ["2012-08-05", "2019-08-05", "54.43"],
                ["2011-08-05", "2018-08-05", "-211.31"],
                ["2013-08-05", "2019-08-05", "-200.36"],
                ["2013-08-05", "2019-08-05", "0"],
                ["2019-08-05", "2019-08-05", "321.31"],
                ["2019-08-05", "2013-08-05", "500.36"],
                ["2019-08-05", "2019-08-05", "103.7"],
                ["2019-08-05", "2019-08-05", "100.82"],
            ],
            ["2018-08-05", "2019-08-05", "2019-08-05", "2019-08-05"],
            ["2019", "2018"],
        ];

        var data = [
            [
                [
                    114880.0078125, 328449.21875, 0, 206965.5625, 0,
                    91705.3046875, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
                ],
                [
                    0, 0, 12486.3125, 0, 223843.703125, 0, 27118.76953125, 0,
                    203413, 107532.140625, 78479.1953125, 0, 16476.404296875,
                    3024.280029296875, 46673.53515625, 0, 0,
                ],
                [
                    0, 0, 0, 0, 0, 0, 0, 330006.6875, 0, 0, 0, 167380.234375, 0,
                    0, 0, 189238.53125, 149528.015625,
                ],
            ],
            ["Furniture", "OfficeSupplies", "Technology"],
            [
                "Bookcases",
                "Chairs",
                "Labels",
                "Tables",
                "Storage",
                "Furnishings",
                "Art",
                "Phones",
                "Binders",
                "Appliances",
                "Paper",
                "Accessories",
                "Envelopes",
                "Fasteners",
                "Supplies",
                "Machines",
                "Copiers",
            ],
        ];

        var extraHeightWorked = false;
        var redrawn = false;
        var extraHeight = 0;
        drawChart(data);

        function transformData(dataValue, dateFormat, dateFormat1) {
            json = {};
            var isKey1Date = false;
            var isKey2Date = false;

            if (isDateFormat(dataValue[0][1])) {
                isKey1Date = true;
            }
            if (isDateFormat(dataValue[0][0])) {
                isKey2Date = true;
            }

            var uniqueKey2 = [];
            dataValue.forEach((d) => {
                if (isKey1Date) {
                    var key = getDateFormattedData(d[1], dateFormat);
                } else {
                    var key = d[1];
                }

                if (!json[key]) {
                    json[key] = {};
                }
                if (isKey2Date) {
                    var key2 = getDateFormattedData(d[0], dateFormat1);
                } else {
                    var key2 = d[0];
                }
                if (!uniqueKey2.includes(key2)) {
                    uniqueKey2.push(key2);
                }

                var value = d[2];

                if (!json[key][key2]) {
                    json[key][key2] = 0;
                }

                json[key][key2] += +value;
            });

            var response = [];
            var allKeys = uniqueKey2;

            for (var key in json) {
                if (Object.keys(json[key]).length < allKeys.length) {
                    allKeys.forEach((d) => {
                        if (!json[key][d]) {
                            json[key][d] = 0;
                        }
                    });
                }
                response.push({ ...json[key], key });
            }

            // console.log(response);
            // debugger;
            return [response, allKeys, data[2]];
        }

        function drawChart(data, plottingConfiguration = {}) {
            window.data = data;

            // var keys = data[1];
            // var labels = data[2];

            var margin = { top: 20, right: 20, bottom: 30, left: 40 };
            var width = window.innerWidth - margin.left - margin.right - 50;
            var height = window.innerHeight - margin.top - margin.bottom - 50;
            yaxisTicks = height / 70;
            var timeFormat = d3.timeFormat("%m-%Y");

            let {
                d3colorPalette,
                paddingInner,
                markerShape,
                curveType,
                dateFormat,
                dateFormat1,
                chartType,
                standartThresholdWidth,
            } = plottingConfiguration;

            if (!d3colorPalette) {
                d3colorPalette = defaultD3Config.d3ColorPalette;
            }
            d3Colors = d3colorPalette;

            if (!paddingInner) {
                paddingInner = defaultD3Config.defaultPaddingInner;
            }

            if (!dateFormat) {
                dateFormat = defaultD3Config.dateFormat;
            }

            if (!dateFormat1) {
                dateFormat1 = defaultD3Config.dateFormat;
            }

            if (!chartType) {
                chartType = defaultD3Config.chartType;
            }

            if (!standartThresholdWidth) {
                standartThresholdWidth = defaultD3Config.standartThresholdWidth;
            }

            var margin = { top: 40, right: 20, bottom: 80, left: 70 };
            var width = window.innerWidth - margin.left - margin.right - 50;

            var [data, keys, labels] = transformData(
                data[0],
                dateFormat,
                dateFormat1
            );

            if (chartType == constants.chartType.STANDARD) {
                width = data.length * standartThresholdWidth;
            }

            var height =
                window.innerHeight - margin.top - margin.bottom - extraHeight;

            var x = d3
                .scaleBand()
                .range([0, width])
                .domain(
                    data.map((d) => {
                        return d.key;
                    })
                )
                .padding(paddingInner)
                .paddingInner(paddingInner);

            var y = d3.scaleLinear().range([height, margin.top]);
            var center = d3.scaleLinear().range([0, width]);
            var color = d3.scaleOrdinal().range(d3Colors);

            var xAxis = d3.axisBottom(x);
            var yAxis = d3.axisLeft(y).ticks(yaxisTicks);

            var centerLine = d3.axisTop(center).ticks(0);

            data.forEach(function (d) {
                var y0_positive = 0;
                var y0_negative = 0;

                d.components = keys.map(function (key) {
                    if (d[key] >= 0) {
                        return {
                            key,
                            y1: y0_positive,
                            y0: (y0_positive += d[key]),
                        };
                    } else if (d[key] < 0) {
                        return {
                            key,
                            y0: y0_negative,
                            y1: (y0_negative += d[key]),
                        };
                    }
                });
            });

            var y_min = d3.min(data, function (d) {
                return d3.min(
                    d.components.map((d1) => {
                        return d1.y1;
                    })
                );
            });

            var y_max = d3.max(data, function (d) {
                return d3.max(
                    d.components.map((d1) => {
                        return d1.y0;
                    })
                );
            });

            if (y_min > 0) {
                y_min = 0;
            }

            y.domain([y_min, y_max]).nice();
            color.domain(keys);
            const barWidth = x.bandwidth();

            d3.selectAll("#my_dataviz").html("");
            d3.selectAll("#yAxisDiv").html("");

            //add svg with margin !important
            //this is svg is actually group
            var svg = d3
                .selectAll("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            svg.append("g")
                .attr("class", "x-axis axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis.tickSize(0));

            d3.select("#yAxisDiv")
                .append("svg")
                .attr("width", "72")
                .attr("height", height + margin.top + margin.bottom)
                .append("g") //add group to leave margin for axis
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                )
                .append("g")
                .attr("class", "y-axis")
                .call(yAxis);

            svg.append("g")
                .attr("class", "y axis grid")
                .call(yAxis.tickSize(-width));

            svg.append("g")
                .attr("class", "centerline")
                .attr("transform", "translate(0," + y(0) + ")")
                .call(centerLine);

            var entry = svg
                .selectAll(".entry")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "g")
                .attr("transform", function (d) {
                    return "translate(" + x(d.key) + ", 0)";
                });

            entry
                .selectAll("rect")
                .data(function (d) {
                    return d.components;
                })
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("width", x.bandwidth())
                .attr("y", function (d) {
                    return y(d.y0);
                })
                .attr("height", function (d) {
                    return Math.abs(y(d.y0) - y(d.y1));
                })
                .style("fill", function (d) {
                    return color(d.key);
                })
                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");
                    d3.selectAll(".bar").style("opacity", 1);
                })
                .on("mouseover mousemove", function (d, i) {
                    let xpos1 = d3.mouse(this)[0] + margin.left;

                    var parentElement = this.parentElement;

                    const matrix =
                        window.getComputedStyle(parentElement).transform;

                    const matrixValues = matrix
                        .match(/matrix.*\((.+)\)/)[1]
                        .split(", ");

                    xpos1 += +matrixValues[4] || 0;

                    let ypos = d3.mouse(this)[1] - 20;

                    d3.select("#tooltip")
                        .style("left", xpos1 + "px")
                        .style("top", ypos + "px")
                        .style("display", "block")
                        .style("position", "absolute")
                        .text(function () {
                            var textValue = d.y0 - d.y1;
                            if (d.y1 < 0) {
                                textValue = d.y1 - d.y0;
                            }
                            return d.key + ":" + textValue.toFixed(3);
                        });

                    d3.selectAll(".bar").style("opacity", 0.3);
                    d3.select(this).style("opacity", 1);
                });

            setYaxisWidth();

            if (chartType == constants.chartType.FIT_WIDTH && barWidth < 40) {
                setXaxisWidth();
            }

            function setXaxisWidth() {
                var allYAxisTicks = document.querySelectorAll(".x-axis .tick");
                var maxWidth = 0;
                for (var i = 0; i < allYAxisTicks.length; i++) {
                    var tick = allYAxisTicks[i];
                    var width = tick.getBBox().width;
                    if (width > maxWidth) {
                        maxWidth = width;
                    }
                }

                extraHeightWorked = true;
                extraHeight = maxWidth;

                d3.select(".x-axis").attr("text-anchor", "right");

                d3.selectAll(".x-axis text")
                    .attr("transform", "rotate(-90)")
                    .attr("dy", "0.3em")
                    .attr("x", "-" + (maxWidth + 3))
                    .attr("y", "0");
            }

            function make_x_gridlines(x) {
                return d3.axisBottom(x).ticks(yaxisTicks);
            }
            function make_y_gridlines(y) {
                return d3.axisLeft(y).ticks(yaxisTicks);
            }

            function getLeftAxisDistance() {
                var a = document
                    .querySelector(".tick")
                    .getAttribute("transform");
                a = a.replace("translate(", "");
                return a.substr(0, a.indexOf(","));
            }

            function sortDates(dateDataset, dateFormat) {
                var parseTime = d3.timeParse(dateFormat);
                var dates = Object.keys(dateDataset);
                var newDataSet = [];
                dates.forEach((d) => {
                    d = new Date(parseTime(d)).getTime();
                    newDataSet.push(d);
                });
                dates = newDataSet.sort();
                dates = dates.map((d) => {
                    return d3.timeFormat(dateFormat)(new Date(d));
                });

                if (
                    dateFormat == "%b" ||
                    dateFormat == "%m" ||
                    dateFormat == "%B" ||
                    dateFormat == "%d"
                ) {
                    dates = dates.reverse();
                }
                return dates;
            }

            allXAxisTexts = document.querySelectorAll(".x-axis text");
            var textWidth = document
                .querySelector(".x-axis .tick text")
                .getBBox().height;

            if (chartType == constants.chartType.FIT_WIDTH) {
                for (var i = 0; i < allXAxisTexts.length; i++) {
                    if (!Math.floor(data.length * 0.02)) {
                        break;
                    }
                    if (i % Math.floor(data.length * 0.02) != 0) {
                        allXAxisTexts[i].remove();
                        continue;
                    }

                    if (i == 0 && barWidth < textWidth * 0.5) {
                        allXAxisTexts[i].setAttribute("dy", "1em");
                        continue;
                    }
                    if (barWidth < textWidth * 0.5) {
                        allXAxisTexts[i].setAttribute("dy", "0.8em");
                    }
                }
            }

            if (extraHeightWorked && !redrawn) {
                extraHeightWorked = false;
                redrawn = true;
                drawChart(window.data, plottingConfiguration);
            }

            if (extraHeightWorked && redrawn) {
                extraHeightWorked = false;
                redrawn = false;
            }

            function setYaxisWidth() {
                var allYAxisTicks = document.querySelectorAll(".y-axis .tick");
                var maxWidth = 72;
                for (var i = 0; i < allYAxisTicks.length; i++) {
                    var tick = allYAxisTicks[i];
                    var width = tick.getBBox().width + 25;
                    if (width > maxWidth) {
                        maxWidth = width;
                    }
                }

                var yAxisDiv = document.querySelector("#yAxisDiv svg");

                yAxisDiv.setAttribute("width", maxWidth);
                yAxisDiv.setAttribute(
                    "transform",
                    "translate(" + (maxWidth - margin.left) + "," + 0 + ")"
                );
            }

            function getDateFormattedData(dateValue, dateFormat) {
                return d3.timeFormat(dateFormat)(new Date(dateValue));
            }
        }
    </script>
</body>
