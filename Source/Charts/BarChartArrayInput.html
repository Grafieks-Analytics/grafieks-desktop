<!DOCTYPE html>
<head>
    <meta charset="utf-8" />

    <!-- Load d3.js -->
    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <style type="text/css">
        body {
            padding: 0;
            margin: 0;
        }
        .title {
            position: fixed;
            top: 0;
            right: 20px;
        }

    </style>
</head>
<body>
    <!-- Create a div where the graph will take place -->

    <div style="position: fixed; top: 0; right: 20px" id="timeTaken"></div>
    <div id="my_dataviz"></div>
    <div id="tooltip"></div>

    <script>
        var valueDateType = false;

    

        // Color Pallets - Set 3
        const d3colors = [
            "#8DD3C9",
            "#FFFFAA",
            "#B8BED6",
            "#F98171",
            "#78B5D1",
            "#FFB15B",
            "#B4E061",
            "#FDCDE5",
            "#DAD9D4",
            "#BD7FBE",
            "#CDE9C1",
            "#FFEA77",
        ];

        // var data = [
        //     [
        //         ["Nz", "Ind", "Aus"],
        //         [200, 800, 400],
        //     ],
        //     ["Countries", "Population"],
        // ];

        var data = [
            [
                ["2020-01-01", "2021-02-01", "2022-03-01"],
                [200, 800, 400],
            ],
            ["Countries", "Population"],
        ];

        // drawChart(data);

        function drawChart(data, plottingConfiguration = {}) {
            window.data = data;
            dataValues = data[0];

console.log(JSON.stringify(plottingConfiguration));

            var parseTime = d3.timeParse("%d-%b-%y");

            var dataValues = data[0];

            let {
                d3colorPalette,
                paddingInner,
                markerShape,
                curveType,
                dateFormat,
                xLabelFontSize,
            } = plottingConfiguration;
            if (!d3colorPalette) {
                d3colorPalette = defaultD3Config.d3ColorPalette;
            }
            d3Colors = d3[d3colorPalette];

            if (!paddingInner) {
                paddingInner = defaultD3Config.defaultPaddingInner;
            }

            if (!dateFormat) {
                dateFormat = defaultD3Config.dateFormat;
            } 
        
       

            d3.selectAll("#my_dataviz").html("");

            // set the dimensions and margins of the graph
            var margin = { top: 30, right: 30, bottom: 70, left: 60 },
                width = window.innerWidth - margin.left - margin.right - 10,
                height = window.innerHeight - margin.top - margin.bottom - 10;

            // append the svg object to the body of the page
            var svg = d3
                .selectAll("#my_dataviz")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr(
                    "transform",
                    "translate(" + margin.left + "," + margin.top + ")"
                );

            var xAxisBottom = svg
                .append("g")
                .attr("class", "x-axis")
                .attr("transform", "translate(0," + height + ")");

            var dataValues = data[0];

            if (isDateFormat(dataValues[0][0])) {
                valueDateType = true;
            }

            if (valueDateType) {
                dataValues[0].forEach((d, i) => {
                    dataValues[0][i] = new Date(dataValues[0][i]);
                });
            }

            var x = d3
                .scaleBand()
                .range([0, width])
                .domain(dataValues[0])
                .padding(paddingInner);

            if (valueDateType) {
                xAxisBottom
                    .call(
                        d3
                            .axisBottom(x)
                            .tickSize(0)
                            .ticks(10)
                            .tickFormat(d3.timeFormat(dateFormat))
                    )
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)")
                    .style("text-anchor", "end")
                    .style("margin-top", "5px");
            } else {
                console.log("NoDate");

                xAxisBottom
                    .call(d3.axisBottom(x).tickSize(0).ticks(10))
                    .selectAll("text")
                    .attr("transform", "translate(-10,0)")
                    .style("text-anchor", "end")
                    .style("margin-top", "5px");
            }

            svg.append("g")
                .attr("class", "grid")
                .attr("transform", "translate(0," + height + ")")
                .style("stroke-width", "1");

            // .call(make_x_gridlines().tickSize(0).tickFormat(""));

            // Add Y axis
            var y = d3
                .scaleLinear()
                .domain([0, Math.max(...dataValues[1])])
                .range([height, 0]);

            var yaxisTicks = height / 100;

            // Add the Y Axis
            svg.append("g")
                .call(d3.axisLeft(y).tickSize(0).ticks(yaxisTicks))
                .style("stroke-width", "0.5")
                .attr("class", "y-axis");

            svg.append("g")
                .attr("class", "grid")
                .style("stroke-width", "1")
                .call(make_y_gridlines().tickSize(-width).tickFormat(""));

            // Bars
            svg.selectAll("mybar")
                .data(dataValues[0])
                .enter()
                .append("rect")

                .attr("x", function (d, i) {
                    let value = dataValues[0][i];
                    if (isDateFormat(value)) {
                        valueDateType = true;
                    }
                    return x(dataValues[0][i]);
                })
                .attr("y", function (d, i) {
                    return y(dataValues[1][i]);
                })
                .attr("width", x.bandwidth())
                .attr("height", function (d, i) {
                    return height - y(dataValues[1][i]);
                })
                .attr("class", function (d, i) {
                    return "bar";
                })
                .attr("fill", d3Colors[4])

                .on("mouseout", function (d, i) {
                    d3.select("#tooltip").style("display", "none");

                    d3.selectAll(".bar").style("opacity", 1);
                })
                .on("mouseover mousemove", function (d, i) {
                    let xpos = d3.mouse(this)[0] + margin.left;
                    let ypos = d3.mouse(this)[1];

                    d3.select("#tooltip")
                        .style("left", xpos + "px")
                        .style("top", ypos + "px")
                        .style("display", "block")
                        .text(dataValues[1][i]);

                    d3.selectAll(".bar").style("opacity", 0.3);
                    d3.select(this).style("opacity", 1);
                });

            // Generate Grid starts

            const [xAxisLabel,yAxisLabel]=data[1];
           
            setLabel(xAxisLabel, "x_label", 20,30);
            setLabel(yAxisLabel, "y_label", 20,30);
        console.log("xLabelFontSize1" + xLabelFontSize)
            if(xLabelFontSize){
                  console.log("xLabelFontSize2" + xLabelFontSize)
              
                changeChartAttributes('.x_label', 'font-size',xLabelFontSize);

                
            }
            

            function make_x_gridlines() {
                return d3.axisBottom(x).ticks(8);
            }
            function make_y_gridlines() {
                return d3.axisLeft(y).ticks(yaxisTicks);
            }



            // Generate Grid ends
        }
    </script>
</body>
