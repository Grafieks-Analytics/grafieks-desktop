<html>
    <head>
        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <link rel="stylesheet" href="Data/general.css" />
        <style type="text/css">
            body {
                padding: 0;
                margin: 0;
                overflow-y: hidden;
                /* overflow-x: hidden; */
            }
            #yAxisDiv {
                position: fixed;
                background: #fff;
            }
            #my_dataviz {
                /* overflow-x: scroll; */
            }
        </style>
    </head>
    <body>
        <div style="display: flex">
            <div id="yAxisDiv"></div>
            <div id="my_dataviz"></div>
        </div>
        <div id="tooltip"></div>
        <script>
            var extraHeightWorked = false;
            var redrawn = false;
            var extraHeight = 0;

            function drawChart(data, plottingConfiguration = {}) {
                window.data = data;
                dataValues = data[0];

                var parseTime = d3.timeParse("%d-%b-%y");

                var dataValues = data[0];

                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                    dateFormat,
                    chartType,
                    standardThresholdWidth,
                } = plottingConfiguration;

                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3colorPalette;

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                if (!dateFormat) {
                    dateFormat = defaultD3Config.dateFormat;
                }

                if (!chartType) {
                    chartType = defaultD3Config.chartType;
                }

                if (!standardThresholdWidth) {
                    standardThresholdWidth =
                        defaultD3Config.standardThresholdWidth;
                }

                var margin = { top: 40, right: 20, bottom: 80, left: 70 };
                var width = window.innerWidth - margin.left - margin.right;

                var xAxisDataSet = dataValues[0];

                var xAxisDateWiseValues = {};

                var valueDateType = false;
                if (isDateFormat(xAxisDataSet[0])) {
                    valueDateType = true;
                }

                if (valueDateType) {
                    xAxisDataSet.forEach((d, i) => {
                        xAxisDataSet[i] = new Date(xAxisDataSet[i]);
                        var requiredTypeData = getDateFormattedData(
                            d,
                            dateFormat
                        );

                        if (!xAxisDateWiseValues[requiredTypeData]) {
                            xAxisDateWiseValues[requiredTypeData] = 0;
                        }

                        xAxisDateWiseValues[requiredTypeData] +=
                            dataValues[1][i];
                    });

                    var sortedKeys = sortDates(xAxisDateWiseValues, dateFormat);

                    dataValues[0] = sortedKeys;
                    dataValues[1] = sortedKeys.map(
                        (d, i) => xAxisDateWiseValues[d]
                    );
                    data[0] = dataValues;
                }

                if (chartType == constants.chartType.STANDARD) {
                    width = dataValues[0].length * standardThresholdWidth;
                }

                var height =
                    window.innerHeight -
                    margin.top -
                    margin.bottom -
                    extraHeight;

                d3.selectAll("#my_dataviz").html("");
                d3.selectAll("#yAxisDiv").html("");

                //add svg with margin !important
                //this is svg is actually group
                var svg = d3
                    .selectAll("#my_dataviz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr(
                        "height",
                        height + extraHeight + margin.top + margin.bottom
                    )
                    .append("g") //add group to leave margin for axis
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    );

                var dataset = dataValues[1];

                var maxHeight = d3.max(dataset, function (d) {
                    return Math.abs(d);
                });
                var minHeight = d3.min(dataset, function (d) {
                    return d;
                });

                if (minHeight > 0) {
                    minHeight = 0;
                }

                //set y scale
                var yScale = d3
                    .scaleLinear()
                    .rangeRound([0, height])
                    .domain([maxHeight, minHeight])
                    .nice();
                //show negative

                yaxisTicks = height / 70;

                //add x and y axis
                var yAxis = d3.axisLeft(yScale).tickSize(0).ticks(yaxisTicks);
                d3.select("#yAxisDiv")
                    .append("svg")
                    .attr("width", "72")
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g") //add group to leave margin for axis
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    )
                    .append("g")
                    .attr("class", "y-axis")
                    .call(yAxis);

                svg.append("g")
                    .attr("class", "grid")
                    .style("stroke-width", "1")
                    .call(
                        make_y_gridlines(yScale).tickSize(-width).tickFormat("")
                    );

                //add x axis
                var xScale = d3
                    .scaleBand()
                    .domain(dataValues[0])
                    .range([0, width])
                    .padding(paddingInner)
                    .paddingInner(paddingInner);

                //scaleBand is used for  bar chart

                /*if domain is specified, sets the domain to the specified array of values.
            The first element in domain will be mapped to the first band, the second domain value to the second band, and so on.
            Domain values are stored internally in a map from stringified value to index; the resulting index is then used to determine the band.
            Thus, a band scaleâ€™s values must be coercible to a string, and the stringified version of the domain value uniquely identifies the corresponding band.
            If domain is not specified, this method returns the current domain.*/

                var barpadding = 10;
                var bars = svg
                    .selectAll("rect")
                    .data(dataset)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", function (d, i) {
                        return xScale(dataValues[0][i]); //i*(width/dataset.length);
                    })
                    .attr("y", function (d) {
                        if (d < 0) {
                            return yScale(0);
                        } else {
                            return yScale(d);
                        }
                    }) //for bottom to top
                    .attr(
                        "width",
                        xScale.bandwidth() /*width/dataset.length-barpadding*/
                    )
                    .attr("height", function (d) {
                        var height = Math.abs(yScale(0) - yScale(Math.abs(d)));
                        if (!height) {
                            height = 1;
                        }
                        return height;
                    })
                    .attr("fill", d3Colors[4])
                    .on("mouseout", function (d, i) {
                        d3.select("#tooltip").style("display", "none");
                        d3.selectAll(".bar").style("opacity", 1);
                    })
                    .on("mouseover mousemove", function (d, i) {
                        let xpos = d3.mouse(this)[0] + margin.left;
                        let ypos = d3.mouse(this)[1];

                        d3.select("#tooltip")
                            .style("left", xpos + "px")
                            .style("top", ypos + "px")
                            .style("display", "block")
                            .text(dataset[i]);

                        d3.selectAll(".bar").style("opacity", 0.3);
                        d3.select(this).style("opacity", 1);
                    });

                var xAxis = d3.axisBottom(xScale);
                // if (valueDateType) {
                //     xAxis.tickFormat(d3.timeFormat(dateFormat));
                // }

                /*.tickFormat("");remove tick label*/

                svg.append("g")
                    .call(xAxis)
                    .attr("class", "x-axis")
                    .attr("transform", "translate(0," + height + ")");

                const [xAxisLabel, yAxisLabel] = data[1];

                setLabel(xAxisLabel, "x_label", false);
                setLabel(yAxisLabel, "y_label", false);

                // //add label for x axis and y axis
                // svg.append("text")
                //     .text("Y Label")
                //     .attr("x", 0 - height / 2)
                //     .attr("y", 0 - margin.left)
                //     .attr("dy", "1em")
                //     .style("text-anchor", "middle")
                //     .attr("transform", "rotate(-90)");
                // svg.append("text")
                //     .text("X Label")
                //     .attr("x", width / 2)
                //     .attr("y", height + margin.bottom)
                //     .style("text-anchor", "middle");

                setYaxisWidth();

                var barWidth = document.querySelector(".bar").getBBox().width;
                if (
                    chartType == constants.chartType.FIT_WIDTH &&
                    barWidth < 40
                ) {
                    setXaxisWidth();
                }

                function setXaxisWidth() {
                    var allYAxisTicks =
                        document.querySelectorAll(".x-axis .tick");
                    var maxWidth = 0;
                    for (var i = 0; i < allYAxisTicks.length; i++) {
                        var tick = allYAxisTicks[i];
                        var width = tick.getBBox().width;
                        if (width > maxWidth) {
                            maxWidth = width;
                        }
                    }

                    extraHeightWorked = true;
                    extraHeight = maxWidth;

                    d3.select(".x-axis").attr("text-anchor", "right");

                    d3.selectAll(".x-axis text")
                        .attr("transform", "rotate(-90)")
                        .attr("dy", "0.3em")
                        .attr("x", "-" + (maxWidth + 3))
                        .attr("y", "0");
                }

                a = document.querySelectorAll(".x-axis text");
                var textWidth = document
                    .querySelector(".x-axis .tick text")
                    .getBBox().height;

                if (chartType == constants.chartType.FIT_WIDTH) {
                    for (var i = 0; i < a.length; i++) {
                        if (!Math.floor(data[0][0].length * 0.02)) {
                            break;
                        }
                        if (i % Math.floor(data[0][0].length * 0.02) != 0) {
                            a[i].remove();
                            continue;
                        }

                        if (i == 0 && barWidth < textWidth * 0.5) {
                            a[i].setAttribute("dy", "1em");
                            continue;
                        }
                        if (barWidth < textWidth * 0.5) {
                            a[i].setAttribute("dy", "0.8em");
                        }
                    }
                }

                if (extraHeightWorked && !redrawn) {
                    extraHeightWorked = false;
                    redrawn = true;
                    drawChart(window.data, plottingConfiguration);
                }

                if (extraHeightWorked && redrawn) {
                    extraHeightWorked = false;
                    redrawn = false;
                }

                function setYaxisWidth() {
                    var allYAxisTicks =
                        document.querySelectorAll(".y-axis .tick");
                    var maxWidth = 72;
                    for (var i = 0; i < allYAxisTicks.length; i++) {
                        var tick = allYAxisTicks[i];
                        var width = tick.getBBox().width + 25;
                        if (width > maxWidth) {
                            maxWidth = width;
                        }
                    }

                    var yAxisDiv = document.querySelector("#yAxisDiv svg");

                    yAxisDiv.setAttribute("width", maxWidth);
                    yAxisDiv.setAttribute(
                        "transform",
                        "translate(" + (maxWidth - margin.left) + "," + 0 + ")"
                    );
                }

                function make_x_gridlines(x) {
                    return d3.axisBottom(x).ticks(8);
                }
                function make_y_gridlines(y) {
                    return d3.axisLeft(y).ticks(yaxisTicks);
                }
            }
        </script>
    </body>
</html>
