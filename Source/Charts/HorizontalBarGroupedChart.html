<!DOCTYPE html>
<html>
    <head>
        <script src="./Data/d3DefaultConfig.js"></script>
        <script src="./Data/utils.js"></script>
        <script src="./Data/d3.v4.min.js"></script>
        <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
        <script src="./Data/min/numeral.min.js"></script>
        <link rel="stylesheet" href="Data/general.css" />
        <style type="text/css">
            body {
                padding: 0;
                margin: 0;
            }

            ::-webkit-scrollbar {
                width: 15px;
            }

            #tooltip {
                font-size: 14px;
                font-family: Arial, Helvetica, sans-serif;
                min-width: fit-content;
                max-width: max-content;
            }

            #my_dataviz {
                overflow-y: scroll;
                margin-left: 40px;
                height: calc(100vh - 71px);
                /* background-color: red; */
            }

            #xAxisLabelId {
                position: fixed;
                bottom: 0px;
                /* z-index: -1; */
                height: 40px;
                margin-left: 40px;
                /* display: none; */
                /* background-color: red; */
            }

            #xAxisDiv {
                margin-left: 40px;
                /* display: none; */
            }

            #yAxisDiv {
                width: 40px;
                /* background-color: red; */
            }
        </style>
    </head>

    <body>
        <div id="mainChartWindow" style="display: flex; flex-direction: column">
            <div id="yAxisDiv"></div>
            <div id="my_dataviz"></div>
            <div id="xAxisDiv"></div>
            <div id="xAxisLabelId" style="position: fixed"></div>
        </div>

        <div id="tooltip"></div>

        <div id="legend"></div>
        <script>
            function sumAllData(originalData, currentData) {
                var allKeys = [
                    ...Object.keys(originalData),
                    ...Object.keys(currentData),
                ];

                allKeys = allKeys.filter((d) => {
                    if (d != "mainCategory") {
                        return d;
                    }
                });

                allKeys.forEach((d) => {
                    originalData[d] =
                        (originalData[d] || 0) + (currentData[d] || 0);
                });

                return originalData;
            }

            // function transformData(dataValue, dateFormat) {
            //     var transformedDataValue = {};
            //     var globalKeys = [];

            //     dataValue[0].forEach((d, i) => {
            //         var currentData = d;

            //         var isKey1Date = false;
            //         if (isDateFormat(d.mainCategory)) {
            //             isKey1Date = true;
            //         }

            //         var category = d.mainCategory;
            //         if (isKey1Date) {
            //             category = getDateFormattedData(
            //                 d.mainCategory,
            //                 dateFormat
            //             );
            //         }
            //         // console.log(category);
            //         if (!transformedDataValue[category]) {
            //             transformedDataValue[category] = {};
            //         }
            //         var originalData = transformedDataValue[category];

            //         var allKeys = [
            //             ...Object.keys(originalData),
            //             ...Object.keys(currentData),
            //         ];

            //         allKeys = allKeys
            //             .filter((d) => {
            //                 if (d != "mainCategory") {
            //                     return d;
            //                 }
            //             })
            //             .filter(getUniqueArrayValues);

            //         globalKeys.push(...allKeys);

            //         allKeys.forEach((d) => {
            //             // console.log(originalData[d], currentData[d]);
            //             originalData[d] =
            //                 (originalData[d] || 0) + (currentData[d] || 0);
            //         });
            //         transformedDataValue[category] = {
            //             ...originalData,
            //             mainCategory: category,
            //         };

            //         // console.log({ transformedDataValue });
            //     });

            //     var transformedDataValue = Object.keys(
            //         transformedDataValue
            //     ).map((d) => transformedDataValue[d]);

            //     globalKeys = globalKeys.filter(getUniqueArrayValues);
            //     return [transformedDataValue, globalKeys];
            // }

            function transformData(dataValue, dateFormat) {
                var transformedDataValue = {};
                var globalKeys = [];

                var isKey1Date = false;

                if (isDateFormat(dataValue[0][0].mainCategory)) {
                    isKey1Date = true;
                }

                dataValue[0].forEach((d, i) => {
                    var currentData = d;

                    var category = d.mainCategory;
                    if (isKey1Date) {
                        category = getDateFormattedData(
                            d.mainCategory,
                            dateFormat
                        );
                    }
                    // console.log(category);
                    if (!transformedDataValue[category]) {
                        transformedDataValue[category] = {};
                    }
                    var originalData = transformedDataValue[category];

                    var allKeys = [
                        ...Object.keys(originalData),
                        ...Object.keys(currentData),
                    ];

                    allKeys = allKeys
                        .filter((d) => {
                            if (d != "mainCategory") {
                                return d;
                            }
                        })
                        .filter(getUniqueArrayValues);

                    globalKeys.push(...allKeys);

                    allKeys.forEach((d) => {
                        originalData[d] =
                            (originalData[d] || 0) + (currentData[d] || 0);
                    });
                    transformedDataValue[category] = {
                        ...originalData,
                        mainCategory: category,
                    };
                });

                if (isKey1Date) {
                    var sortedKeys = sortDates(
                        transformedDataValue,
                        dateFormat,
                        true
                    );
                    console.log(sortedKeys);
                    transformedDataValue = sortedKeys.map((key) => {
                        return transformedDataValue[key];
                    });
                } else {
                    transformedDataValue = Object.keys(
                        transformedDataValue
                    ).map((key) => {
                        return transformedDataValue[key];
                    });
                }

                globalKeys = globalKeys.filter(getUniqueArrayValues);
                var mainCategoryData = transformedDataValue.map(
                    (d) => d.mainCategory
                );
                return [
                    transformedDataValue,
                    globalKeys,
                    data[2],
                    [dataValue[2][0], mainCategoryData, globalKeys],
                ];
            }

            function drawChart(data, plottingConfiguration = {}) {
                window.data = data;

                let {
                    d3colorPalette,
                    paddingInner,
                    markerShape,
                    curveType,
                    dateFormat,
                    chartType,
                    toolTip,
                    legendConfig = defaultD3Config.defaultLegendConfig,
                    labelConfig = defaultD3Config.defaultlabelConfig,
                    gridConfig = defaultD3Config.defaultGridConfig,
                    standardThresholdHeight = defaultD3Config.standardThresholdHeight,
                    // font size
                    xLabelfontSize = defaultD3Config.fontSize,
                    yLabelfontSize = defaultD3Config.fontSize,
                    xTickfontSize = defaultD3Config.fontSize,
                    yTickfontSize = defaultD3Config.fontSize,
                    dataLabelfontSize = defaultD3Config.fontSize,
                    // font family
                    xLabelfontFamily = defaultD3Config.fontFamily,
                    yLabelfontFamily = defaultD3Config.fontFamily,
                    xTickfontFamily = defaultD3Config.fontFamily,
                    yTickfontFamily = defaultD3Config.fontFamily,
                    dataLabelfontFamily = defaultD3Config.fontFamily,
                    // font color
                    xLabelfontColor = defaultD3Config.fontColor,
                    yLabelfontColor = defaultD3Config.fontColor,
                    xTickfontColor = defaultD3Config.fontColor,
                    yTickfontColor = defaultD3Config.fontColor,
                    dataLabelColor = defaultD3Config.fontColor,
                    options,
                } = plottingConfiguration;
                window.xLabelfontSize = xLabelfontSize;
                window.yLabelfontSize = yLabelfontSize;
                window.xTickfontSize = xTickfontSize;
                window.yTickfontSize = yTickfontSize;
                window.dataLabelfontSize = dataLabelfontSize;

                window.xLabelfontFamily = xLabelfontFamily;
                window.yLabelfontFamily = yLabelfontFamily;
                window.xTickfontFamily = xTickfontFamily;
                window.yTickfontFamily = yTickfontFamily;
                window.dataLabelfontFamily = dataLabelfontFamily;

                window.xLabelfontColor = xLabelfontColor;
                window.yLabelfontColor = yLabelfontColor;
                window.xTickfontColor = xTickfontColor;
                window.yTickfontColor = yTickfontColor;
                window.dataLabelColor = dataLabelColor;

                d3.selectAll("#my_dataviz").html("");
                d3.selectAll("#yAxisDiv").html("");

                var legendNames = [];
                let { legendStatus, legendPosition } = legendConfig;
                let { labelStatus, labelFormat } = labelConfig;
                let { gridStatus } = gridConfig;

                var { groupBarChartColorBy } = options || {};

                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3colorPalette;

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                if (!dateFormat) {
                    dateFormat = defaultD3Config.dateFormat;
                }

                if (!chartType) {
                    chartType = defaultD3Config.horizontalChartType;
                }

                if (!standardThresholdHeight) {
                    standardThresholdHeight =
                        defaultD3Config.standardThresholdHeight;
                }

                // console.log({ data });
                data = transformData(data, dateFormat);
                console.log(data);

                var [data, all_keys, labels, legendNames] = data;
                console.log({ legendNames });

                var margin = { top: 40, right: 20, bottom: 0, left: 70 };
                var width = window.innerWidth - margin.left - margin.right - 70;
                var height =
                    window.innerHeight - margin.top - margin.bottom + 25;

                if (chartType == constants.chartType.STANDARD) {
                    var bars = numberOfBars(data);
                    height = bars * standardThresholdHeight;

                    if (height < window.innerHeight) {
                        d3.select("#xAxisDiv").style(
                            "top",
                            height - margin.top + "px"
                        );
                    } else {
                        d3.select("#xAxisDiv").style(
                            "bottom",
                            // -(margin.top -10) + "px"
                            0 + "px"
                        );
                        d3.select("#xAxisDiv").style("top", null);
                    }
                } else {
                    height -= margin.top - 10;
                    d3.select("#xAxisDiv").style("bottom", 0);
                }

                function numberOfBars(data) {
                    var count = 0;
                    for (var i = 0; i < data.length; i++) {
                        var innerData = data[i];
                        count += Object.keys(innerData).length - 1;
                    }
                    return count;
                }

                window.clearChart && clearChart();

                var minHeight = d3.min(data, (d) =>
                    d3.min(all_keys, (k) => d[k])
                );

                if (minHeight > 0) {
                    minHeight = 0;
                }

                const yAxisWidth =
                    document.querySelector("#yAxisDiv").clientWidth;

                var maxHeight = d3.max(data, (d) =>
                    d3.max(all_keys, (k) => d[k])
                );

                var legendNameArray = [legendNames[0]];
                var legenedNameLabel = legendNames[0];

                if (groupBarChartColorBy == "category") {
                    legendNameArray = legendNames[1];
                    legenedNameLabel = labels[0];
                } else if (groupBarChartColorBy) {
                    legendNameArray = legendNames[2];
                    legenedNameLabel = labels[1];
                }
                // legends code starts
                d3.select("#legend").html("").style("padding", "");
                if (legendStatus) {
                    d3.select("#legend").html("");

                    d3.select("#legend")
                        .append("p")
                        .html(legenedNameLabel + "&nbsp;")
                        .style("font-weight", "bold")
                        .style("margin", "auto")
                        .style("position", "sticky");

                    d3.select("#legend")
                        .selectAll("div")
                        .data(legendNameArray)
                        .enter()
                        .append("div")
                        .html((d, i) => {
                            return (
                                '<div style="width: 15px; height: 15px; margin-top:2px; background: ' +
                                d3Colors[i % d3Colors.length] +
                                ';">  </div>' +
                                "<span style='margin-left: 5px; max-width: 160px'>" +
                                d +
                                "</span>"
                            );
                        })
                        .style("display", "flex")
                        .style("padding", "2px");
                }

                d3.selectAll("#my_dataviz").style(
                    "height",
                    "calc(100vh - 71px)"
                );

                // legends code ends

                // legends height ,width elements
                var legendElement = document.querySelector("#legend");
                var legendHeight = legendElement.offsetHeight;
                var legendWidth = legendElement.offsetWidth;

                // const yAxisWidth =
                //     document.querySelector("#yAxisDiv").clientWidth;

                d3.select("#legend").attr("style", null);
                d3.select("#mainChartWindow").attr("style", null);

                // legends code starts
                if (legendStatus) {
                    if (
                        legendHeight <
                        document.querySelector("html").offsetHeight
                    ) {
                        topPosition = "calc(50vh - " + legendHeight / 2 + "px)";
                    } else {
                        topPosition = 0;
                    }

                    rightPosition = "calc(50vw - " + legendWidth / 2 + "px)";

                    //  var widthOld = (document.querySelector("#my_dataviz").clientWidth) ;
                    var widthOld =
                        document.querySelector("html").clientWidth - 40;
                    var heightOld = document.querySelector("html").clientHeight;

                    // legendElement.style.padding = "10px";
                    legendElement.style.border = "1px solid black";
                    d3.selectAll("#my_dataviz").style("margin-top", 0 + "px");
                    switch (legendPosition) {
                        case "left":
                            // clearStyle();
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", topPosition)
                                .style("right", "auto")
                                // .style("bottom", "auto")
                                .style("left", "0px")
                                // .style("right", "5px")
                                .style("display", "block")
                                .style("max-height", "100vh")
                                .style("overflow-x", "scroll")
                                .style("border", "none")
                                .style("position", "fixed");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            var legendWidth = legendElement.offsetWidth;
                            // margin.left += 100;
                            // width -= 100;
                            // d3.select("#my_dataviz svg").attr("width", width + margin.left + margin.right);

                            d3.select("#mainChartWindow").attr("style", null);

                            d3.select("#mainChartWindow").style(
                                "width",
                                widthOld - legendWidth + yAxisWidth + "px"
                            );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                legendWidth + "px"
                            );
                            d3.selectAll("#xAxisLabelId").style(
                                "bottom",
                                "0px"
                            );
                            break;
                        case "top":
                            // clearStyle();
                            d3.select("#mainChartWindow").attr("style", null);
                            // margin.top -= 50;
                            height -= 50;
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "10px")
                                .style("right", rightPosition)
                                .style("bottom", "auto")
                                .style("left", "auto")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow-x", "scroll")
                                .style("border", "none");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            // d3.selectAll("#legend div").style(
                            //     "padding",
                            //     "2px 4px"
                            // );
                            d3.selectAll("#my_dataviz").style(
                                "margin-top",
                                50 + "px"
                            );

                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 122px)"
                            );
                            // debugger;
                            d3.selectAll("#xAxisDiv").style("bottom", "0px");
                            d3.selectAll("#xAxisLabelId").style(
                                "bottom",
                                "0px"
                            );
                            break;
                        case "bottom":
                            // clearStyle();
                            height -= 50; // use legend client height
                            // bottomHeight += 50;
                            // margin.bottom += 10;
                            var legendWidth = legendElement.offsetWidth;

                            d3.select("#xAxisLabelId").style("bottom", 50);
                            d3.select("#mainChartWindow").attr("style", null);

                            // d3.select("#mainChartWindow").style("width", width);
                            //  d3.select("#mainChartWindow").style("height",heightOld-80 );
                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                0
                            );
                            d3.select("#legend")
                                .attr("style", null)
                                .style("top", "auto")
                                .style("right", rightPosition)
                                .style("bottom", "0px")
                                // .style("left", margin.left + "px")
                                .style("display", "flex")
                                .style("max-width", "99vw")
                                .style("overflow-x", "scroll")
                                .style("border", "none");

                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            // d3.selectAll("#my_dataviz").style(
                            //     "margin-bottom",
                            //     50
                            // );
                            // d3.selectAll("#my_dataviz").style(
                            //     "margin-bottom",
                            //     180
                            // );
                            d3.selectAll("#my_dataviz").style(
                                "height",
                                "calc(100vh - 122px)"
                            );
                            d3.selectAll("#xAxisDiv").style("bottom", "50px");
                            d3.selectAll("#xAxisLabelId").style(
                                "bottom",
                                "50px"
                            );

                            break;
                        // For Right Legened
                        case "right":
                        default:
                            // debugger;
                            // clearStyle();
                            var legendWidth = legendElement.offsetWidth;
                            // width -= legendWidth;
                            // d3.select("#my_dataviz").style("width", width + margin.left + margin.right);

                            d3.select("#legend")
                                .attr("style", null)
                                .style("right", "5px")
                                .style("left", "auto")
                                .style("position", "fixed")
                                .style("top", topPosition)
                                .style("max-height", "100vh")
                                .style("overflow-x", "scroll")
                                .style("border", "none")
                                .style("bottom", "auto")
                                .style("display", "block");
                            d3.selectAll("#legend div span")
                                .style("max-width", "160px")
                                .style("white-space", "nowrap")
                                .style("overflow", "hidden")
                                .style("text-overflow", "ellipsis");

                            d3.select("#mainChartWindow").attr("style", null);
                            d3.select("#mainChartWindow").style(
                                "width",
                                widthOld + yAxisWidth - legendWidth - 10 + "px"
                            );
                            // d3.select("#my_dataviz svg" ).style(
                            //     "width",
                            //    widthOld+yAxisWidth-legendWidth-20
                            // );

                            d3.select("#mainChartWindow").style(
                                "margin-left",
                                "0px"
                            );
                            d3.selectAll("#xAxisLabelId").style(
                                "bottom",
                                "0px"
                            );
                    }
                }

                if (legendPosition == "left" || legendPosition == "right") {
                    var legendWidth = legendElement.offsetWidth;
                    width -= legendWidth + 30;
                }
                if (legendPosition == "top") {
                    var legendHeightTop = 60;
                } else {
                    legendHeightTop = 0;
                }
                if (legendPosition == "left") {
                    var legendWidthLeft = legendWidth;
                } else {
                    legendWidthLeft = 0;
                }
                // .;

                // legends code ends

                //add svg with margin !important
                //this is svg is actually group
                var svg = d3
                    .selectAll("#my_dataviz")
                    .append("svg")
                    .attr("width", width + 100)
                    .attr("height", height - margin.top - margin.bottom)
                    .append("g") //add group to leave margin for axis
                    .attr(
                        "transform",
                        "translate(" +
                            margin.left +
                            "," +
                            (margin.top - 10) +
                            ")"
                    );

                d3.selectAll("#yAxisDiv")
                    .append("svg")
                    .attr("width", 40)
                    .attr("height", window.innerHeight)
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" +
                            margin.left +
                            "," +
                            (margin.top + 10) +
                            ")"
                    );
                // Change xScale from range 0 width to max and min c=value and scale it linearly
                const xScale = d3.scaleLinear().range([0, width]);
                // .padding(paddingInner);

                const yScale0 = d3
                    .scaleBand()
                    .rangeRound([height - margin.top - margin.bottom, 0]);

                // change yScale to scale band and range from 0 to height (which is fine here)

                var zScale = d3.scaleOrdinal().range(d3Colors);
                // yaxisTicks = height / 70;
                yaxisTicks = width / 150;

                // change scale domain from, xScale from minVaue to maxValue
                xScale.domain([minHeight, maxHeight]).nice();

                //add x and y axis
                var yAxis = d3.axisLeft(yScale0).tickSize(0).ticks(yaxisTicks);

                var xAxis = d3
                    .axisBottom(xScale)
                    .tickSize(0)
                    .ticks(yaxisTicks)
                    .tickFormat(d3.format(".2s"));

                d3.select("#xAxisDiv")
                    .append("svg")
                    .attr("height", "80")
                    .attr("width", width + margin.left + margin.right)
                    .append("g") //add group to leave margin for axis
                    .attr(
                        "transform",
                        "translate(" + margin.left + ",0)"
                        // "translate(0,0)"
                    )
                    .append("g")
                    .attr("class", "x-axis")
                    .call(xAxis);

                // change xScale0 to yScale0
                yScale0.domain(data.map((d) => d.mainCategory));

                svg.append("g")
                    .attr("class", "grid")
                    .style("stroke-width", "1")
                    .call(
                        make_x_gridlines(xScale)
                            .tickSize(height - margin.top)
                            .tickFormat("")
                    );

                svg.selectAll(".groups")
                    .data(data)
                    .enter()
                    .append("g")
                    .attr("class", "mainCategory")
                    .each(function (group_data) {
                        const bar_data = getBars(group_data),
                            x_offset = groupOffset(group_data),
                            group_keys = bar_data.map((d) => d.name);
                        yScale1 = d3
                            .scaleBand()
                            .domain(group_keys)
                            .range([0, yScale0.bandwidth() - x_offset * 2]) // change xScale0 to yScale0
                            .padding(paddingInner);

                        d3.select(this)
                            .attr(
                                "transform",
                                (d) =>
                                    `translate(0,${
                                        yScale0(d.mainCategory) + x_offset
                                    })`
                            ) // change this to yScale0   ( check translate value )
                            .selectAll(".bar")
                            .data(bar_data)
                            .enter()
                            .append("rect")
                            .attr("class", "bar")
                            .attr("fill", function (d) {
                                this.setAttribute(
                                    "data-value-x1",
                                    d.mainCategory
                                );
                                this.setAttribute("data-value-x2", d.name);
                                this.setAttribute("data-value-y", d.value);

                                if (groupBarChartColorBy == "category") {
                                    return zScale(d.data.mainCategory);
                                }
                                if (groupBarChartColorBy == "subcategory") {
                                    return zScale(d.name);
                                }
                                return d3Colors[0];
                            })
                            .on("mouseout", function (d, i) {
                                d3.select("#tooltip").style("display", "none");
                                d3.selectAll(".bar").style("opacity", 1);
                            })
                            .on("mouseover mousemove", function (d, i) {
                                let xpos = d3.mouse(this)[0] + margin.left;
                                let ypos = d3.mouse(this)[1];
                                var yScroll =
                                    document.querySelector(
                                        "#my_dataviz"
                                    ).scrollTop;
                                ypos -= yScroll;
                                var parentElement = this.parentElement;
                                xAxisValue1 =
                                    this.getAttribute("data-value-x1");
                                xAxisValue2 =
                                    this.getAttribute("data-value-x2");

                                const matrix =
                                    window.getComputedStyle(
                                        parentElement
                                    ).transform;
                                const matrixValues = matrix
                                    .match(/matrix.*\((.+)\)/)[1]
                                    .split(", ");

                                ypos += +matrixValues[5] || 0;

                                d3.select("#tooltip")
                                    .style("left", xpos + 20 + "px")
                                    .style("top", ypos - 49 + "px")
                                    .style("display", "block")
                                    // .html(d.name + ":" + d.value);
                                    .html(function () {
                                        var textValue = d.y0 - d.y1;
                                        if (d.y1 < 0) {
                                            textValue = d.y1 - d.y0;
                                        }

                                        return (
                                            "<div class='arrowTooltip'></div>" +
                                            "<span style='color:grey;''>" +
                                            labels[0] +
                                            ":&nbsp;&nbsp;" +
                                            "</span>" +
                                            "<span style='float: right;'>" +
                                            xAxisValue1 +
                                            "</span>" +
                                            "<br/> <br/>" +
                                            "<span style='color:grey;''>" +
                                            labels[1] +
                                            ":" +
                                            "</span>" +
                                            "<span style='float: right;margin-left: 15px;'>" +
                                            xAxisValue2 +
                                            "</span>" +
                                            "<br/> <br/>" +
                                            "<span style='color:grey;''>" +
                                            labels[2] +
                                            ":" +
                                            "</span>" +
                                            "<span style='float: right;margin-left: 15px;'>" +
                                            d.value +
                                            "</span>"
                                        );
                                    });

                                if (
                                    xpos - window.scrollX >
                                    document.documentElement.clientWidth -
                                        document.querySelector("#tooltip")
                                            .clientWidth
                                ) {
                                    d3.select("#tooltip").style(
                                        "left",
                                        xpos -
                                            document.querySelector("#tooltip")
                                                .clientWidth +
                                            25 +
                                            "px"
                                    );

                                    d3.select(".arrowTooltip")
                                        //  document.querySelector("#tooltip:before")
                                        // .style("height","50px";"width","50px";"background-color","red";")

                                        .attr(
                                            "style",
                                            "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';right: -12px; transform: rotate(-90deg)!important;bottom: 22px; position: absolute;"
                                        );
                                } else {
                                    d3.select("#tooltip").style(
                                        "left",
                                        xpos + 55 + legendWidthLeft + "px"
                                    );

                                    d3.select(".arrowTooltip").attr(
                                        "style",
                                        "border: solid; border-color: white transparent; border-width: 12px 6px 0 6px; content: '';left: -12px; transform: rotate(90deg)!important;bottom: 22px; position: absolute;"
                                    );
                                }

                                d3.selectAll(".bar").style("opacity", 0.3);
                                d3.select(this).style("opacity", 1);
                            })
                            .attr("y", (d) => {
                                return yScale1(d.name); // y = yScale1
                            })
                            .attr("x", (d) => {
                                // x = xscale
                                if (d.value < 0) {
                                    return xScale(d.value);
                                }
                                return xScale(0);
                            })
                            .attr("height", yScale1.bandwidth()) // height = yScale1.bandwidth
                            .attr("width", (d) => {
                                var heightValue = Math.abs(
                                    xScale(0) - xScale(Math.abs(d.value)) // xScale and this will be width
                                );
                                if (!heightValue) {
                                    heightValue = 1;
                                }
                                return heightValue;

                                // return (
                                //     height -
                                //     margin.top -
                                //     margin.bottom -
                                //     yScale(d.value)
                                // );
                            });

                        if (labelStatus) {
                            d3.select(this)
                                .attr(
                                    "transform",
                                    (d) =>
                                        `translate(0,${
                                            yScale0(d && d.mainCategory) +
                                            x_offset
                                        })`
                                )
                                .selectAll("text.label")
                                .data(bar_data)
                                .enter()
                                .append("text")
                                .attr("class", "label")
                                // yScale1.bandwidth()
                                .attr("y", (d) => {
                                    return yScale1(d.name) +8; // y = yScale1
                                })
                                .text(function (d) {
                                    return   labelFormatSet(d.value, labelFormat);
                                })
                                .attr("font-family", dataLabelfontFamily)
                                .attr("font-size", dataLabelfontSize)
                                .attr("fill", dataLabelColor)
                                // .attr("x", (d) => xScale1(d.name)-textLength.baseVal.value)
                                .attr("x", (d) => {
                                    // x = xscale
                                    var heightValue = Math.abs(
                                        xScale(0) - xScale(Math.abs(d.value)) // xScale and this will be width
                                    );
                                    if (!heightValue) {
                                        heightValue = 1;
                                    }

                                    if (d.value < 0) {
                                        return xScale(d.value);
                                    }

                                    return xScale(0) + heightValue;
                                });
                        }
                    });

                // // Add the X Axis
                // svg.append("g")
                //     .attr("class", "x-axis")
                //     .attr(
                //         "transform",
                //         `translate(0,${height - margin.top - margin.bottom})`
                //     )
                //     .call(xAxis);

                // Add the Y Axis
                svg.append("g").attr("class", "y-axis").call(yAxis);

                a = document.querySelectorAll(".y-axis text");
                for (var i = 0; i < a.length; i++) {
                    if (a[i] && a[i].innerHTML) {
                        var singleCharacterLength =
                            a[i].getBBox().width / a[i].innerHTML.length;

                        var maxWidth =
                            document.querySelector(".y-axis").getBBox().width >
                            72
                                ? 72
                                : document.querySelector(".y-axis").getBBox()
                                      .width;
                        var numOfCharacters = maxWidth / singleCharacterLength;

                        if (a[i].innerHTML.length > numOfCharacters) {
                            a[i].innerHTML =
                                a[i].innerHTML.substr(0, numOfCharacters - 3) +
                                "...";
                        }
                    }
                }

                setLabel(labels[0], "y_label", d3.select("svg"), false);
                setLabel(
                    labels[2],
                    "x_label",
                    d3
                        .select("#xAxisLabelId")
                        .append("svg")
                        .attr("width", window.innerWidth, "height", 150),
                    50
                );
                d3.selectAll(".x-axis text")
                    .attr("font-size", xTickfontSize)
                    .attr("font-family", xTickfontFamily)
                    .attr("fill", xTickfontColor)
                    .attr("y", 8);
                d3.selectAll(".y-axis text")
                    .attr("font-size", yTickfontSize)
                    .attr("font-family", yTickfontFamily)
                    .attr("fill", yTickfontColor);

                function getBars(d) {
                    const bars = [];
                    all_keys.forEach((k) => {
                        if (d.hasOwnProperty(k)) {
                            bars.push({
                                name: k,
                                value: d[k],
                                data: d,
                                mainCategory: d.mainCategory,
                            });
                        }
                    });
                    return bars;
                }

                function groupOffset(d) {
                    const groupElementsCount = all_keys.reduce(
                            (acc, k) =>
                                d.hasOwnProperty(k) ? (acc += 1) : acc,
                            0
                        ),
                        allElementsCount = all_keys.length,
                        groupWidth = yScale0.bandwidth(), // change to yScale0
                        x_offset =
                            ((1 - groupElementsCount / allElementsCount) *
                                groupWidth) /
                            2;

                    return x_offset;
                }

                function make_x_gridlines(x) {
                    return d3.axisBottom(x).ticks(8);
                }
                function make_y_gridlines(y) {
                    return d3.axisLeft(y).ticks(yaxisTicks);
                }

                function getDateFormattedData(dateValue, dateFormat) {
                    return d3.timeFormat(dateFormat)(new Date(dateValue));
                }
            }

            // var data = [
            //     {
            //         mainCategory: "2020-02-01",
            //         field1: 19,
            //         field2: 83,
            //         field3: 2,
            //         field4: 30,
            //         field5: 30,
            //         field6: 30,
            //     },
            //     {
            //         mainCategory: "2019-04-02",
            //         field1: 100,
            //         field2: 29,
            //         field3: 100,
            //         field4: 130,
            //     },
            //     {
            //         mainCategory: "2019-03-03",
            //         field1: 100,
            //         field3: 100,
            //     },
            //     {
            //         mainCategory: "2019-03-01",
            //         field1: 100,
            //         field2: 43,
            //         field3: 100,
            //     },
            //     {
            //         mainCategory: "2021-03-03",
            //         field1: 98,
            //         field2: 43,
            //         field3: 100,
            //     },
            //     {
            //         mainCategory: "2018-02-04",
            //         // field1: -98,
            //         field2: 43,
            //         field3: 100,
            //     },
            //     {
            //         mainCategory: "2019-04-09",
            //         field1: 100,
            //         field2: 43,
            //         field3: 10,
            //     },
            //     {
            //         mainCategory: "2019-03-09",
            //         field2: 43,
            //         field3: 100,
            //     },
            // ];

            var data = [
                [
                    {
                        Bookcases: -8016,
                        Chairs: 6906,
                        Furnishings: -2398,
                        Tables: 10230,
                        mainCategory: "Furniture",
                    },
                    {
                        Appliances: 1060,
                        Art: 2756,
                        Binders: 2114,
                        Envelopes: 1134,
                        Fasteners: 160,
                        Labels: 192,
                        Paper: 1198,
                        Storage: 4638,
                        Supplies: 132,
                        mainCategory: "Office Supplies",
                    },
                    {
                        Accessories: 938,
                        Phones: 8372,
                        mainCategory: "Technology",
                    },
                ],
                [
                    [
                        "Bookcases",
                        "Chairs",
                        "Labels",
                        "Tables",
                        "Storage",
                        "Furnishings",
                        "Art",
                        "Phones",
                        "Binders",
                        "Appliances",
                        "Paper",
                        "Envelopes",
                        "Accessories",
                        "Fasteners",
                        "Supplies",
                    ],
                ],
                ["Category", "Sub-category", "Sales"],
            ];

            drawChart(data);
        </script>
    </body>
</html>
