<!DOCTYPE html>
<html>
    <meta charset="utf-8" />

    <!-- Load d3.js -->

    <script src="./Data/d3DefaultConfig.js"></script>
    <script src="./Data/utils.js"></script>
    <script src="./Data/d3.v4.min.js"></script>
    <script src="./Data/d3-scale-chromatic.v1.min.js"></script>
    <link rel="stylesheet" href="Data/general.css" />

    <!-- Create a div where the graph will take place -->

    <body>
        <!-- Create a div where the graph will take place -->
        <div id="my_dataviz"></div>
        <div id="tooltip"></div>

        <script>
            var data = [
                [
                    ["asdsad2221", "Helen", "6129"],
                    ["1903", "Dorothy", "3078"],
                    ["1903", "Betty", "596"],
                    ["1903", "Amanda", "247"],
                    ["1998", "Betty", "194"],
                    ["1999", "Ashley", "18132"],
                    ["1999", "Jessica", "16346"],
                    ["1999", "Amanda", "9741"],
                    ["1999", "Patricia", "1532"],
                    ["1999", "Linda", "898"],
                    ["1999", "Helen", "841"],
                    ["1999", "Deborah", "524"],
                    ["1999", "Dorothy", "335"],
                    ["1999", "Betty", "182"],
                    ["2000", "Ashley", "17997"],
                    ["2000", "Jessica", "15705"],
                    ["2000", "Amanda", "8550"],
                    ["2000", "Patricia", "1392"],
                    ["2000", "Helen", "890"],
                    ["2000", "Linda", "849"],
                    ["2000", "Deborah", "545"],
                    ["2000", "Dorothy", "312"],
                    ["2000", "Betty", "174"],
                ],
                ["Labels"],
            ];

            var data = [
                [
                    ["Furniture", "Furniture", -3636],
                    ["Furniture", "OfficeSupplies", 0],
                    ["Furniture", "Technology", 0],
                    ["OfficeSupplies", "Furniture", 0],
                    ["OfficeSupplies", "OfficeSupplies", 2010],
                    ["OfficeSupplies", "Technology", 0],
                    ["Technology", "Furniture", 0],
                    ["Technology", "OfficeSupplies", 0],
                    ["Technology", "Technology", 1362],
                ],
                ["Furniture", "OfficeSupplies", "Technology"],
                ["Category", "Profit"],
            ];
            // set the dimensions and margins of the graph

            var {
                initialCircleRadius,
                initialBoxDimension,
                onHoverCircleRadius,
                onHoverBoxDimension,
                defaultLineCurve,
            } = defaultD3Config;

            function drawChart(data, plottingConfiguration = {}) {
                var dataValues = data[0];

                let { d3colorPalette, paddingInner, markerShape, curveType } =
                    plottingConfiguration;
                if (!d3colorPalette) {
                    d3colorPalette = defaultD3Config.d3ColorPalette;
                }
                d3Colors = d3colorPalette;

                if (!paddingInner) {
                    paddingInner = defaultD3Config.defaultPaddingInner;
                }

                if (!curveType) {
                    curveType = defaultLineCurve;
                }
                d3.selectAll("#my_dataviz").html("");
                var margin = { top: 30, right: 30, bottom: 70, left: 60 },
                    width = window.innerWidth - margin.left - margin.right - 20,
                    height =
                        window.innerHeight - margin.top - margin.bottom - 20;

                // append the svg object to the body of the page
                svg = d3
                    .select("#my_dataviz")
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr(
                        "transform",
                        "translate(" + margin.left + "," + margin.top + ")"
                    );

                // group the data: I want to draw one line per group
                var sumstat = d3
                    .nest() // nest function allows to group the calculation per level of a factor
                    .key(function (d) {
                        return d[1];
                    })
                    .entries(dataValues);

                var xAxisValues = dataValues.map((d) => d[0]);
                console.log(xAxisValues);

                // Add X axis --> it is a date format
                x = d3.scaleBand().domain(xAxisValues).range([0, width]);

                svg.append("g")
                    .attr("transform", "translate(0," + height + ")")
                    .call(d3.axisBottom(x).ticks(5));

                // Add Y axis
                y = d3
                    .scaleLinear()
                    .domain([
                        0,
                        d3.max(dataValues, function (d) {
                            return +d[2];
                        }),
                    ])
                    .range([height, 0])
                    .nice();

                svg.append("g").call(d3.axisLeft(y));

                // color palette
                var res = sumstat.map(function (d) {
                    return d.key;
                }); // list of group names
                var color = d3.scaleOrdinal().domain(res).range(d3Colors);

                // Draw the line
                svg.selectAll(".line")
                    .data(sumstat)
                    .enter()
                    .append("path")
                    .attr("fill", "none")
                    .attr("stroke", function (d) {
                        return color(d.key);
                    })
                    .attr("stroke-width", 1.5)
                    .attr("d", function (d) {
                        return d3
                            .line()
                            .x(function (d) {
                                return x(d[0]);
                            })
                            .y(function (d) {
                                return y(+d[2]);
                            })
                            .curve(d3[curveType])(d.values);
                    });

                drawMarker(true, false, "#ff00ff");
            }

            // function drawMarker(fillStatus, markerShape, fillColor) {
            //     let dataValues = data,
            //         fill = "#ffffff",
            //         stroke = d3Colors[0];

            //     if (fillStatus) {
            //         initialCircleRadius = 3;
            //         fill = fillColor;
            //         stroke = 0;
            //     }

            //     if (!markerShape) {
            //         markerShape = defaultD3Config.defaultMarkerShape;
            //     }

            //     svg.selectAll(".marker-shape").remove();

            //     svg.selectAll(".dot")
            //         .data(dataValues)
            //         .enter()
            //         .append(markerShape)
            //         .attr("stroke", stroke)
            //         .attr("class", markerShape)
            //         .attr("class", "marker-shape")
            //         .attr("fill", fill)
            //         .attr(
            //             markerShapeConfig[markerShape] &&
            //                 markerShapeConfig[markerShape].xPositionAttrName,
            //             function (d, i) {
            //                 return x(i);
            //             }
            //         )
            //         .attr(
            //             markerShapeConfig[markerShape] &&
            //                 markerShapeConfig[markerShape].yPositionAttrName,
            //             function (d) {
            //                 return y(d);
            //             }
            //         )
            //         .attr("r", initialCircleRadius)
            //         .attr("height", initialBoxDimension)
            //         .attr("width", initialBoxDimension)
            //         .attr("points", function (d, i) {
            //             console.log(x(i));
            //             var x1 = x(i);
            //             return (
            //                 x1 +
            //                 " " +
            //                 (x1 + 3) +
            //                 ", " +
            //                 (x1 + 10) +
            //                 " " +
            //                 (x1 + 10) +
            //                 ", " +
            //                 (x1 - 10) +
            //                 " " +
            //                 (x1 + 10)
            //             );
            //         })
            //         .on("mousemove ", function (d, i) {
            //             var x_pos = d3.mouse(this)[0];
            //             var y_pos = d3.mouse(this)[1];

            //             const xValue = x.invert(x_pos);
            //             const yValue = y.invert(y_pos);

            //             d3.select("#tooltip")
            //                 .style("left", x_pos - 10 + "px")
            //                 .style("top", y_pos + "px")
            //                 .style("display", "block")
            //                 .html(parseInt(xValue) + ", " + yValue.toFixed(2));

            //             var shapeClass = ".marker-shape";
            //             d3.selectAll(shapeClass).style("opacity", 0.3);
            //             d3.select(this)
            //                 .style("opacity", 1)
            //                 .attr("r", onHoverCircleRadius)
            //                 .attr("height", onHoverBoxDimension)
            //                 .attr("width", onHoverBoxDimension);
            //         })
            //         .on("mouseout", function () {
            //             d3.select("#tooltip").style("display", "none");
            //             var shapeClass = ".marker-shape";
            //             d3.selectAll(shapeClass)
            //                 .style("opacity", 1)
            //                 .attr("r", initialCircleRadius)
            //                 .attr("height", initialBoxDimension)
            //                 .attr("width", initialBoxDimension);
            //         });
            // }

            function drawMarker(fillStatus, markerShape) {
                dateformatValue = function (value) {
                    return value;
                };

                let dataValues = window.chartDataValues,
                    fill = "#ffffff",
                    stroke = d3Colors[0];

                if (fillStatus) {
                    initialCircleRadius = 3;
                    fill = d3Colors[0];
                    stroke = 0;
                }
                if (!markerShape) {
                    markerShape = defaultD3Config.defaultMarkerShape;
                }

                var svg = d3.select("#my_dataviz svg");

                svg.selectAll(".marker-shape").remove();

                svg.selectAll(".dot")
                    .data(sumstat)
                    .enter()
                    .append(markerShape)
                    .attr("stroke", stroke)
                    .attr("class", markerShape)
                    .attr("class", "marker-shape")
                    .attr(
                        "transform",
                        "translate(" +
                            (markerShape == constants.markerShapes.RECT
                                ? margin.left - 2.8
                                : margin.left) +
                            "," +
                            (markerShape == constants.markerShapes.RECT
                                ? margin.top - 3
                                : margin.top) +
                            ")"
                    )
                    .attr("fill", fill)
                    .attr(
                        markerShapeConfig[markerShape] &&
                            markerShapeConfig[markerShape].xPositionAttrName,
                        function (d, i) {
                            return xScale(d[0]) + xScale.bandwidth() / 2;
                        }
                    )
                    .attr(
                        markerShapeConfig[markerShape] &&
                            markerShapeConfig[markerShape].yPositionAttrName,
                        function (d) {
                            return yScale(d[1]);
                        }
                    )
                    .attr("r", initialCircleRadius)
                    .attr("height", initialBoxDimension)
                    .attr("width", initialBoxDimension)
                    .attr("points", function (d, i) {
                        var x1 = xScale(d[0]);
                        return x1;
                    })
                    .on("mousemove ", function (d, i) {
                        var x_pos = d3.mouse(this)[0];
                        var y_pos = d3.mouse(this)[1];

                        // console.log(d);
                        const xValue = dateformatValue(d[0]);
                        const yValue = d[1];

                        d3.select("#tooltip")
                            .style("left", x_pos - 20 + "px")
                            .style("top", y_pos - 20 + "px")
                            .style("display", "block")
                            .html(xValue + ", " + yValue.toFixed(2));

                        var shapeClass = ".marker-shape";
                        d3.selectAll(shapeClass).style("opacity", 0.3);
                        d3.select(this)
                            .style("opacity", 1)
                            .attr("r", onHoverCircleRadius)
                            .attr("height", onHoverBoxDimension)
                            .attr("width", onHoverBoxDimension);
                    })
                    .on("mouseout", function () {
                        d3.select("#tooltip").style("display", "none");
                        var shapeClass = ".marker-shape";
                        d3.selectAll(shapeClass)
                            .style("opacity", 1)
                            .attr("r", initialCircleRadius)
                            .attr("height", initialBoxDimension)
                            .attr("width", initialBoxDimension);
                    });
            }

            window.onload = function () {
                drawChart(data);
            };

            // Pass this from QT
            window.addEventListener("resize", function () {
                drawChart(data);
            });
        </script>
    </body>
</html>
